# ğŸš€ AI ìë™ ì½”ë“œ ë¦¬ë·° ë¦¬í¬íŠ¸ (Engine: CODEX)

**ë‚ ì§œ**: 2026-01-24 16-21-14
**ì»¤ë°‹**: `d85025a3e`
**ë¸Œëœì¹˜**: `main`
**AI ì—”ì§„**: **CODEX**

---

## ğŸ” ì‹¤ì‹œê°„ ê²€ì¦ ê²°ê³¼ (2026-01-24 16:21:14)

```
ESLint: ìë™ ê²€ì¦ (pre-push)
TypeScript: ìë™ ê²€ì¦ (pre-push)
```

**ê²€ì¦ ë¡œê·¸ íŒŒì¼**:
- ESLint: `logs/validation/`
- TypeScript: `logs/validation/`

---

## ğŸ“Š ë³€ê²½ì‚¬í•­ ìš”ì•½

**ì»¤ë°‹**: `d85025a3ecd1812d26b97b3ecf728aa8eceb07d6`
**ë©”ì‹œì§€**: feat(ai-sdk): add UIMessageStream native protocol support (v2)

## ğŸ“„ src/app/api/ai/supervisor/stream/v2/route.ts

```diff
diff --git a/src/app/api/ai/supervisor/stream/v2/route.ts b/src/app/api/ai/supervisor/stream/v2/route.ts
new file mode 100644
index 000000000..159909cb4
--- /dev/null
+++ b/src/app/api/ai/supervisor/stream/v2/route.ts
@@ -0,0 +1,217 @@
+/**
+ * Cloud Run AI Supervisor Stream V2 Proxy (Passthrough Mode)
+ *
+ * @endpoint POST /api/ai/supervisor/stream/v2
+ *
+ * AI SDK Native UIMessageStream passthrough proxy.
+ * Simply forwards the Cloud Run response directly to the frontend,
+ * preserving the AI SDK native protocol for direct useChat integration.
+ *
+ * Benefits:
+ * - No SSE parsing overhead
+ * - Native AI SDK protocol preserved
+ * - Works directly with useChat (no TextStreamChatTransport needed)
+ * - Structured data events (handoffs, tool calls, metadata)
+ *
+ * @created 2026-01-24
+ */
+
+import type { NextRequest } from 'next/server';
+import { NextResponse } from 'next/server';
+import { z } from 'zod';
+import {
+  extractLastUserQuery,
+  type HybridMessage,
+  normalizeMessagesForCloudRun,
+} from '@/lib/ai/utils/message-normalizer';
+import { withAuth } from '@/lib/auth/api-auth';
+import { logger } from '@/lib/logging';
+import { rateLimiters, withRateLimit } from '@/lib/security/rate-limiter';
+import { quickSanitize } from '../../security';
+
+// Allow streaming responses up to 60 seconds (Vercel Hobby: max 60s)
+export const maxDuration = 60;
+
+// ============================================================================
+// ğŸ“‹ Request Schema
+// ============================================================================
+
+const textPartSchema = z.object({
+  type: z.literal('text'),
+  text: z.string(),
+});
+
+const partSchema = z.union([
+  textPartSchema,
+  z.object({ type: z.literal('tool-invocation') }).passthrough(),
+  z.object({ type: z.literal('tool-result') }).passthrough(),
+  z.object({ type: z.literal('file') }).passthrough(),
+  z.object({ type: z.literal('reasoning') }).passthrough(),
+  z.object({ type: z.literal('source') }).passthrough(),
+  z.object({ type: z.literal('step-start') }).passthrough(),
+  z.object({ type: z.literal('step-finish') }).passthrough(),
+  z.object({ type: z.string() }).passthrough(),
+]);
+
+const messageSchema = z.object({
+  id: z.string().optional(),
+  role: z.enum(['user', 'assistant', 'system']),
+  parts: z.array(partSchema).optional(),
+  content: z.string().optional(),
+  createdAt: z.union([z.string(), z.date()]).optional(),
+});
+
+const requestSchema = z.object({
+  messages: z.array(messageSchema).min(1).max(50),
+  sessionId: z.string().optional(),
+});
+
+// ============================================================================
+// ğŸŒŠ POST - UIMessageStream Passthrough Proxy
+// ============================================================================
+
+export const POST = withRateLimit(
+  rateLimiters.aiAnalysis,
+  withAuth(async (req: NextRequest) => {
+    try {
+      // 1. Validate request
+      const body = await req.json();
+      const parseResult = requestSchema.safeParse(body);
+
+      if (!parseResult.success) {
+        logger.warn(
+          'âš ï¸ [SupervisorStreamV2] Invalid payload:',
+          parseResult.error.issues
+        );
+        return NextResponse.json(
+          {
+            success: false,
+            error: 'Invalid request payload',
+            details: parseResult.error.issues.map((i) => i.message).join(', '),
+          },
+          { status: 400 }
+        );
+      }
```

## ğŸ“„ src/hooks/ai/useHybridAIQuery.ts

```diff
diff --git a/src/hooks/ai/useHybridAIQuery.ts b/src/hooks/ai/useHybridAIQuery.ts
index 51082f968..8b3a9e949 100644
--- a/src/hooks/ai/useHybridAIQuery.ts
+++ b/src/hooks/ai/useHybridAIQuery.ts
@@ -28,7 +28,7 @@
 
 import type { UIMessage } from '@ai-sdk/react';
 import { useChat } from '@ai-sdk/react';
-import { TextStreamChatTransport } from 'ai';
+import { TextStreamChatTransport, DefaultChatTransport } from 'ai';
 import { useCallback, useMemo, useRef, useState } from 'react';
 import {
   applyClarification,
@@ -210,6 +210,20 @@ export interface UseHybridAIQueryOptions {
    * ```
    */
   onData?: (dataPart: StreamDataPart) => void;
+  /**
+   * AI SDK Native Protocol ì‚¬ìš© ì—¬ë¶€ (v2 ì—”ë“œí¬ì¸íŠ¸)
+   *
+   * - true: `/api/ai/supervisor/stream/v2` ì‚¬ìš© (UIMessageStream)
+   * - false (default): `/api/ai/supervisor/stream` ì‚¬ìš© (TextStreamChatTransport)
+   *
+   * Native Protocol ì¥ì :
+   * - AI SDK ë„¤ì´í‹°ë¸Œ í”„ë¡œí† ì½œ (text, data, source ì´ë²¤íŠ¸)
+   * - êµ¬ì¡°í™”ëœ ë°ì´í„° ì´ë²¤íŠ¸ (handoff, tool_call, metadata)
+   * - useChatê³¼ ì§ì ‘ í†µí•© (TextStreamChatTransport ë¶ˆí•„ìš”)
+   *
+   * @default false
+   */
+  useNativeProtocol?: boolean;
 }
 
 export interface UseHybridAIQueryReturn {
@@ -288,14 +302,23 @@ export function useHybridAIQuery(
     sessionId: initialSessionId,
     // ğŸ¯ Real-time streaming endpoint (2026-01-09)
     // Cloud Run SSE streaming â†’ Vercel proxy â†’ Frontend
-    apiEndpoint = '/api/ai/supervisor/stream',
+    apiEndpoint: customEndpoint,
     complexityThreshold = DEFAULT_COMPLEXITY_THRESHOLD,
     onStreamFinish,
     onJobResult,
     onProgress,
     onData,
+    useNativeProtocol = false,
   } = options;
 
+  // Determine API endpoint based on protocol
+  // v2 uses AI SDK native UIMessageStream protocol
+  const apiEndpoint =
+    customEndpoint ??
+    (useNativeProtocol
+      ? '/api/ai/supervisor/stream/v2'
+      : '/api/ai/supervisor/stream');
+
   // Session ID with stable initial value
   const sessionIdRef = useRef<string>(
     initialSessionId || generateMessageId('session')
@@ -329,18 +352,27 @@ export function useHybridAIQuery(
   // ============================================================================
   // useChat Hook (Streaming Mode) - AI SDK v6 ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì ìš©
   // ============================================================================
-  // TextStreamChatTransport for plain text streaming
-  // Cloud Run SSE â†’ Vercel proxy â†’ plain text â†’ TextStreamChatTransport
+  // Transport selection based on protocol:
+  // - TextStreamChatTransport: Plain text streaming (legacy, v1)
+  // - DefaultChatTransport: AI SDK native protocol (UIMessageStream, v2)
+  //
   // ğŸ¯ Real-time streaming enabled (2026-01-09)
-  // Note: TextStreamChatTransportëŠ” ë™ì  body í•¨ìˆ˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ
+  // ğŸŒŠ Native protocol support added (2026-01-24)
   // @see https://ai-sdk.dev/docs/ai-sdk-ui/stream-protocol
-  const transport = useMemo(
-    () =>
-      new TextStreamChatTransport({
+  const transport = useMemo(() => {
+    if (useNativeProtocol) {
+      // v2: AI SDK native UIMessageStream protocol
+      // Works directly with useChat, supports structured data events
+      return new DefaultChatTransport({
         api: apiEndpoint,
-      }),
-    [apiEndpoint]
-  );
+      });
+    }
+    // v1: Plain text streaming (TextStreamChatTransport)
+    // Requires Vercel proxy to convert SSE â†’ plain text
+    return new TextStreamChatTransport({
+      api: apiEndpoint,
+    });
+  }, [apiEndpoint, useNativeProtocol]);
 
   const {
     messages,
```

---

## ğŸš€ AI ë¦¬ë·° ê²°ê³¼

**í•µì‹¬ ê²€ì¦ ê²°ê³¼ (Findings ë¨¼ì €, ì‹¬ê°ë„ ìˆœ)**

- [ì¤‘ìš”/ë²„ê·¸] UIMessageStream ì´ë²¤íŠ¸ íƒ€ì… ë¶ˆì¼ì¹˜ë¡œ `warning/redirect` ì²˜ë¦¬ ë° `onData` íƒ€ì… ë¶„ê¸° ì‹¤íŒ¨  
  - ìœ„ì¹˜: `src/hooks/ai/useHybridAIQuery.ts:421-477`  
  - ê·¼ê±°: Cloud Run v2ëŠ” `createUIMessageStream`ì—ì„œ `data-warning`, `data-handoff`, `data-redirect`, `text-delta` í˜•ì‹ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ í›…ì€ `warning`, `redirect`, `text_delta`ë¥¼ ê¸°ëŒ€í•˜ë¯€ë¡œ v2ì—ì„œ ë‚´ë¶€ ì²˜ë¦¬(ê²½ê³ /ë¦¬ë‹¤ì´ë ‰íŠ¸)ì™€ ì‚¬ìš©ì `onData` ë¶„ê¸°ê°€ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.  
  - ì˜í–¥: v2 ì‚¬ìš© ì‹œ ê²½ê³  UI ë…¸ì¶œ/Job Queue ì „í™˜ ë¡œì§ì´ ë¬´ë ¥í™”ë˜ê³ , í´ë¼ì´ì–¸íŠ¸ ì´ë²¤íŠ¸ í•¸ë“¤ë§ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
  - ê°œì„  ìŠ¤ë‹ˆí«:
    ```ts
    // src/hooks/ai/useHybridAIQuery.ts
    onData: (dataPart) => {
      const rawType = dataPart.type;
      const normalizedType =
        rawType === 'text-delta'
          ? 'text_delta'
          : rawType.startsWith('data-')
            ? rawType.slice(5)
            : rawType;

      const part = { ...dataPart, type: normalizedType } as StreamDataPart;

      if (part.type === 'warning' && part.data) { ... }
      if (part.type === 'redirect' && part.data) { ... }

      onData?.(part);
    },
    ```
    (v1/v2 ê²¸ìš©ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ `data-*`/`text-delta` ì •ê·œí™” ê¶Œì¥)

- [ì¤‘ìš”/ë²„ê·¸] v2 ì‚¬ìš© ì‹œ ìŠ¤íŠ¸ë¦¼ ë³µêµ¬ê°€ í•­ìƒ v1 ì—”ë“œí¬ì¸íŠ¸ë¡œ ê³ ì •ë¨  
  - ìœ„ì¹˜: `src/hooks/ai/useHybridAIQuery.ts:482-488`  
  - ê·¼ê±°: `useNativeProtocol` í™œì„±í™” ì‹œì—ë„ ë³µêµ¬ ìš”ì²­ì´ `/api/ai/supervisor/stream`(v1)ë¡œë§Œ í˜¸ì¶œë©ë‹ˆë‹¤. v2ì—ëŠ” GET ë³µêµ¬ê°€ ì—†ìœ¼ë¯€ë¡œ ë³µêµ¬ ì‹œë„ ìì²´ê°€ ì˜ëª»ëœ ê²½ë¡œë¡œ ë‚˜ê°€ê±°ë‚˜, ë‹¤ë¥¸ ì‘ë‹µ í˜•ì‹ì„ ë°›ì•„ ì˜¤ë¥˜ë¥¼ ìœ ë°œí•©ë‹ˆë‹¤.  
  - ì˜í–¥: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ í›„ ë³µêµ¬ ê²½ë¡œê°€ ì‹¤íŒ¨í•˜ê³  ë¶ˆí•„ìš”í•œ ì˜¤ë¥˜ ìƒíƒœë¡œ ì „í™˜ë  ìˆ˜ ìˆìŒ.  
  - ê°œì„  ìŠ¤ë‹ˆí«:
    ```ts
    // src/hooks/ai/useHybridAIQuery.ts
    const recoveryBase = customEndpoint ?? '/api/ai/supervisor/stream';

    if (!useNativeProtocol && sessionIdRef.current && error.message?.includes('network')) {
      const response = await fetch(`${recoveryBase}?sessionId=${sessionIdRef.current}`);
      ...
    }
    ```
    (ë˜ëŠ” v2ì— GET ë³µêµ¬ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜, v2ì—ì„œëŠ” ë³µêµ¬ ë¡œì§ì„ ìŠ¤í‚µí•˜ë„ë¡ ëª…í™•í™”)

- [ì¤‘ê°„/ì„±ëŠ¥Â·ì•ˆì •ì„±] v2ëŠ” ì»¨í…ìŠ¤íŠ¸ ì••ì¶•/ë©”ì‹œì§€ í¬ê¸° ì œì–´ê°€ ì—†ì–´ íƒ€ì„ì•„ì›ƒÂ·ìš”ì²­ í¬ê¸° ì œí•œ ë¦¬ìŠ¤í¬  
  - ìœ„ì¹˜: `src/app/api/ai/supervisor/stream/v2/route.ts:123-158`  
  - ê·¼ê±°: v1ì€ `compressContext/shouldCompress`ë¡œ ëŒ€í™” ê¸¸ì´ë¥¼ ì œì–´í•˜ì§€ë§Œ v2ëŠ” ê·¸ëŒ€ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤. ë©”ì‹œì§€ ìˆ˜ ì œí•œ(50)ë§Œìœ¼ë¡œëŠ” ì´ ê¸¸ì´ í­ì¦ì„ ë§‰ê¸° ì–´ë µê³ , Cloud Run ìš”ì²­ í¬ê¸° í•œë„/ì§€ì—° ìœ„í—˜ì´ ì¦ê°€í•©ë‹ˆë‹¤.  
  - ì˜í–¥: ê¸´ ëŒ€í™”ì—ì„œ ìš”ì²­ ì‹¤íŒ¨, ì§€ì—° ì¦ê°€, íƒ€ì„ì•„ì›ƒ ê°€ëŠ¥ì„±.  
  - ê°œì„  ìŠ¤ë‹ˆí«:
    ```ts
    // src/app/api/ai/supervisor/stream/v2/route.ts
    import { compressContext, shouldCompress } from '@/lib/ai/utils/context-compressor';

    const normalizedMessages = normalizeMessagesForCloudRun(messages);
    let messagesToSend = normalizedMessages;

    if (shouldCompress(normalizedMessages.length, 4)) {
      const compression = compressContext(normalizedMessages, {
        keepRecentCount: 3,
        maxTotalMessages: 6,
        maxCharsPerMessage: 800,
      });
      messagesToSend = compression.messages;
      logger.info(
        `ğŸ—œï¸ [SupervisorStreamV2] Context compressed: ${compression.originalCount} â†’ ${compression.compressedCount}`
      );
    }

    body: JSON.stringify({ messages: messagesToSend, sessionId }),
    ```

---

**1. ë²„ê·¸ ë° ì •í•©ì„±**
- ìœ„ 2ê±´ì€ ì‹¤ì œ ëŸ°íƒ€ì„ ë™ì‘ì— ì˜í–¥ì´ í¼. íŠ¹íˆ v2 ì´ë²¤íŠ¸ íƒ€ì… ë¶ˆì¼ì¹˜ëŠ” **ì¦‰ì‹œ ìˆ˜ì • ê¶Œì¥**ì…ë‹ˆë‹¤.

**2. ì½”ë“œ í’ˆì§ˆ ë° êµ¬ì¡°**
- v1/v2ê°€ ë¶„ê¸°ë˜ë©´ì„œ ë™ì¼í•œ ê¸°ëŠ¥(ì••ì¶•/ë³µêµ¬)ì˜ ìœ„ì¹˜ê°€ í©ì–´ì ¸ ìˆìŒ. ê³µí†µ ìœ í‹¸ë¡œ í†µí•©í•˜ê±°ë‚˜, í”„ë¡œí† ì½œë³„ ì§€ì› ë²”ìœ„ë¥¼ ëª…í™•íˆ ë¬¸ì„œí™”í•´ì•¼ ìœ ì§€ë³´ìˆ˜ ë¦¬ìŠ¤í¬ê°€ ì¤„ì–´ë“­ë‹ˆë‹¤.

**3. ì„±ëŠ¥ ë° íš¨ìœ¨ì„±**
- v2ëŠ” ì›ë¬¸ ê·¸ëŒ€ë¡œ ì „ì†¡ â†’ ê¸´ ì„¸ì…˜ì—ì„œ ìš”ì²­ í¬ê¸°/ì§€ì—° ì•…í™” ìœ„í—˜. v1ê³¼ ë™ì¼í•œ ì••ì¶• ë¡œì§ ì ìš© ê¶Œì¥.

**4. ë³´ì•ˆ ë° ì•ˆì •ì„±**
- `withAuth`, `withRateLimit` ì ìš©ì€ ì ì ˆ.  
- ë‹¤ë§Œ v2ëŠ” ë³µêµ¬ ê¸°ëŠ¥ì´ ì—†ìœ¼ë¯€ë¡œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì•ˆì •ì„± ì €í•˜. í´ë¼ì´ì–¸íŠ¸ ë³µêµ¬ ë¡œì§ê³¼ ì •í•©ì„± í•„ìš”.

**5. ë¬¸ì„œ/í…ŒìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•„ìš”ì„±**
- ë¬¸ì„œ: API ì‹ ê·œ ì—”ë“œí¬ì¸íŠ¸ `/api/ai/supervisor/stream/v2` ì¶”ê°€ ë° **v1 ëŒ€ë¹„ ì°¨ì´ì (ë³µêµ¬ ë¯¸ì§€ì›, native protocol ì´ë²¤íŠ¸ íƒ€ì…)** ëª…ì‹œ í•„ìš”.  
- í…ŒìŠ¤íŠ¸: ìƒˆ API ë¼ìš°íŠ¸ì— ëŒ€í•œ **ìš”ì²­ ê²€ì¦/ì˜¤ë¥˜ ì‘ë‹µ/Cloud Run ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬**ì— ëŒ€í•œ í†µí•© í…ŒìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì¢‹ìŠµë‹ˆë‹¤. (hooks/ í…ŒìŠ¤íŠ¸ ë¶€ì¬ ì§€ì ì€ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì œì™¸)

**6. ì¢…í•© í‰ê°€**
- ì ìˆ˜: **6.5 / 10**  
- ê²°ë¡ : **ì¡°ê±´ë¶€ ìŠ¹ì¸**  
  - ì´ìœ : v2 ì´ë²¤íŠ¸ íƒ€ì… ë¶ˆì¼ì¹˜ì™€ ë³µêµ¬ ê²½ë¡œ ë¬¸ì œëŠ” ì‹¤ì œ ê¸°ëŠ¥ íšŒê·€ë¥¼ ìœ ë°œí•  ê°€ëŠ¥ì„±ì´ ë†’ìŒ. ìœ„ 2ê±´ ìˆ˜ì • í›„ ìŠ¹ì¸ ê°€ëŠ¥.

---

**ìš”ì•½(ê°„ë‹¨)**
- v2 í”„ë¡œí† ì½œ ì´ë²¤íŠ¸ íƒ€ì… ì •ê·œí™” ë° ë³µêµ¬ ì—”ë“œí¬ì¸íŠ¸ ì²˜ë¦¬ ë¶„ê¸° ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.  
- v1 ìˆ˜ì¤€ì˜ ì»¨í…ìŠ¤íŠ¸ ì••ì¶•ì„ v2ì—ë„ ì ìš©í•˜ê±°ë‚˜, v2 ì œí•œì„ ëª…í™•íˆ ë¬¸ì„œí™”í•˜ì„¸ìš”.  

ì›í•˜ë©´ ìœ„ ì„¸ ê°€ì§€ ìˆ˜ì •ì— ëŒ€í•œ ì‹¤ì œ íŒ¨ì¹˜ë„ ë°”ë¡œ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”.

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë²„ê·¸ ìœ„í—˜ ì‚¬í•­ í™•ì¸ ì™„ë£Œ
- [ ] ê°œì„  ì œì•ˆ ê²€í†  ì™„ë£Œ
- [ ] TypeScript ì•ˆì „ì„± í™•ì¸ ì™„ë£Œ
- [ ] ë³´ì•ˆ ì´ìŠˆ í™•ì¸ ì™„ë£Œ
- [ ] ì¢…í•© í‰ê°€ í™•ì¸ ì™„ë£Œ

## ğŸš¨ ì˜¤íƒ(False Positive) ê¸°ë¡

<!-- ê±°ë¶€/ì €ì ìˆ˜ê°€ ì˜¤íƒì¸ ê²½ìš° ì•„ë˜ì— ê¸°ë¡ -->
<!-- ì˜ˆì‹œ: - [x] limit ê²€ì¦ ì´ìŠˆ: Mock í•¸ë“¤ëŸ¬ë¼ ì‹¤ì œ ì˜í–¥ ì—†ìŒ -->


---

**ìƒì„± ì‹œê°„**: 2026-01-24 16:24:16
**ë¦¬ë·° íŒŒì¼**: `/mnt/d/cursor/openmanager-vibe-v5/reports/ai-review/pending/review-codex-2026-01-24-16-21-14.md`
**AI ì—”ì§„**: CODEX
