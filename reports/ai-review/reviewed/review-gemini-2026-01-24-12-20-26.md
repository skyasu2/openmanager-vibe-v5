# âœ¨ AI ìë™ ì½”ë“œ ë¦¬ë·° ë¦¬í¬íŠ¸ (Engine: GEMINI)

**ë‚ ì§œ**: 2026-01-24 12-20-26
**ì»¤ë°‹**: `21cbe4bf7`
**ë¸Œëœì¹˜**: `main`
**AI ì—”ì§„**: **GEMINI**

---

## ğŸ” ì‹¤ì‹œê°„ ê²€ì¦ ê²°ê³¼ (2026-01-24 12:20:27)

```
ESLint: ìë™ ê²€ì¦ (pre-push)
TypeScript: ìë™ ê²€ì¦ (pre-push)
```

**ê²€ì¦ ë¡œê·¸ íŒŒì¼**:
- ESLint: `logs/validation/`
- TypeScript: `logs/validation/`

---

## ğŸ“Š ë³€ê²½ì‚¬í•­ ìš”ì•½

**ì»¤ë°‹**: `21cbe4bf752356b0666ec194529aa678bf21b303`
**ë©”ì‹œì§€**: feat(ai-engine): migrate to AI SDK v6 native pattern

## ğŸ“„ cloud-run/ai-engine/package.json

```diff
diff --git a/cloud-run/ai-engine/package.json b/cloud-run/ai-engine/package.json
index 5cab8a7c9..9d34d1514 100644
--- a/cloud-run/ai-engine/package.json
+++ b/cloud-run/ai-engine/package.json
@@ -16,7 +16,6 @@
     "prompt:cache:clear": "promptfoo cache clear"
   },
   "dependencies": {
-    "@ai-sdk-tools/agents": "^1.2.0",
     "@ai-sdk/cerebras": "^2.0.2",
     "@ai-sdk/groq": "^2.0.33",
     "@ai-sdk/mistral": "^3.0.1",
```

## ğŸ“„ cloud-run/ai-engine/src/lib/embedding.ts

```diff
diff --git a/cloud-run/ai-engine/src/lib/embedding.ts b/cloud-run/ai-engine/src/lib/embedding.ts
index 6df36879d..f309de094 100644
--- a/cloud-run/ai-engine/src/lib/embedding.ts
+++ b/cloud-run/ai-engine/src/lib/embedding.ts
@@ -40,6 +40,75 @@ function getMistralProvider() {
   return mistralProvider;
 }
 
+// ============================================================================
+// Embedding Cache (Cost Optimization)
+// ============================================================================
+
+/**
+ * In-memory cache for embeddings to reduce Mistral API calls
+ * TTL: 5 minutes (same as Tavily cache for consistency)
+ */
+interface EmbeddingCacheEntry {
+  embedding: number[];
+  timestamp: number;
+}
+
+const embeddingCache = new Map<string, EmbeddingCacheEntry>();
+const EMBEDDING_CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes
+const EMBEDDING_CACHE_MAX_SIZE = 100; // Prevent memory leak
+
+/**
+ * Generate cache key from text (normalized)
+ */
+function getCacheKey(text: string): string {
+  return text.trim().toLowerCase().substring(0, 200); // Limit key size
+}
+
+/**
+ * Get cached embedding if valid
+ */
+function getCachedEmbedding(text: string): number[] | null {
+  const key = getCacheKey(text);
+  const cached = embeddingCache.get(key);
+
+  if (cached && Date.now() - cached.timestamp < EMBEDDING_CACHE_TTL_MS) {
+    console.log(`ğŸ“¦ [Embedding] Cache hit for: "${text.substring(0, 30)}..."`);
+    return cached.embedding;
+  }
+
+  // Remove expired entry
+  if (cached) {
+    embeddingCache.delete(key);
+  }
+
+  return null;
+}
+
+/**
+ * Store embedding in cache
+ */
+function setCachedEmbedding(text: string, embedding: number[]): void {
+  // Limit cache size to prevent memory leak
+  if (embeddingCache.size >= EMBEDDING_CACHE_MAX_SIZE) {
+    // Remove oldest entry (first inserted)
+    const oldestKey = embeddingCache.keys().next().value;
+    if (oldestKey) {
+      embeddingCache.delete(oldestKey);
+    }
+  }
+
+  const key = getCacheKey(text);
+  embeddingCache.set(key, { embedding, timestamp: Date.now() });
+}
+
+/**
+ * Clear embedding cache (for testing)
+ */
+export function clearEmbeddingCache(): void {
+  embeddingCache.clear();
+  console.log('ğŸ§¹ [Embedding] Cache cleared');
+}
+
 // Supabase í´ë¼ì´ì–¸íŠ¸ ì¸í„°í˜ì´ìŠ¤ (ë™ì  import í˜¸í™˜)
 interface SupabaseClientLike {
   rpc: (fn: string, params: Record<string, unknown>) => Promise<{ data: unknown; error: unknown }>;
@@ -47,12 +116,18 @@ interface SupabaseClientLike {
 
 /**
  * í…ìŠ¤íŠ¸ë¥¼ 1024ì°¨ì› ë²¡í„°ë¡œ ì„ë² ë”©
- * Mistral mistral-embed ì‚¬ìš©
+ * Mistral mistral-embed ì‚¬ìš© (ìºì‹± ì ìš©)
  *
  * @param text - ì„ë² ë”©í•  í…ìŠ¤íŠ¸
  * @returns 1024ì°¨ì› float ë°°ì—´
  */
 export async function embedText(text: string): Promise<number[]> {
+  // Check cache first (cost optimization)
+  const cached = getCachedEmbedding(text);
+  if (cached) {
+    return cached;
+  }
+
   const mistral = getMistralProvider();
   const model = mistral.embedding('mistral-embed');
 
```

## ğŸ“„ cloud-run/ai-engine/src/lib/llamaindex-rag-service.ts

```diff
diff --git a/cloud-run/ai-engine/src/lib/llamaindex-rag-service.ts b/cloud-run/ai-engine/src/lib/llamaindex-rag-service.ts
index 3f03f4b35..4aecf5320 100644
--- a/cloud-run/ai-engine/src/lib/llamaindex-rag-service.ts
+++ b/cloud-run/ai-engine/src/lib/llamaindex-rag-service.ts
@@ -232,42 +232,65 @@ export async function hybridSearch(
       maxResults: maxVectorResults,
     });
 
-    // 2. Graph traversal from vector results (using existing SQL function)
-    const graphResults: LlamaIndexSearchResult[] = [];
-
-    for (const result of vectorResults.slice(0, 3)) {
-      const { data } = await supabaseClient.rpc('traverse_knowledge_graph', {
-        p_start_id: result.id,
-        p_start_table: 'knowledge_base',
-        p_max_hops: maxGraphHops,
-        p_relationship_types: null,
-        p_max_results: 5,
-      });
-
+    // 2. Graph traversal from vector results (PARALLELIZED)
+    // Note: supabaseClient is guaranteed non-null here (checked above)
+    const client = supabaseClient!;
+    const topVectorResults = vectorResults.slice(0, 3);
+    const graphTraversalResults = await Promise.all(
+      topVectorResults.map(result =>
+        client.rpc('traverse_knowledge_graph', {
+          p_start_id: result.id,
+          p_start_table: 'knowledge_base',
+          p_max_hops: maxGraphHops,
+          p_relationship_types: null,
+          p_max_results: 5,
+        })
+      )
+    );
+
+    // Collect all unique node IDs from traversal results
+    const nodeIds = new Set<string>();
+    const nodeMetaMap = new Map<string, { pathWeight: number; hopDistance: number }>();
+
+    for (const { data } of graphTraversalResults) {
       if (data && Array.isArray(data)) {
         for (const node of data) {
-          // Fetch actual content
-          const { data: entry } = await supabaseClient
-            .from('knowledge_base')
-            .select('id, title, content, metadata')
-            .eq('id', node.node_id)
-            .single();
-
-          if (entry && !graphResults.some(r => r.id === entry.id)) {
-            graphResults.push({
-              id: entry.id,
-              title: entry.title,
-              content: entry.content,
-              score: Number(node.path_weight) * 0.8, // Weight graph results lower
-              sourceType: 'graph', // Use 'graph' for backward compatibility
+          const nodeId = String(node.node_id);
+          if (!nodeIds.has(nodeId)) {
+            nodeIds.add(nodeId);
+            nodeMetaMap.set(nodeId, {
+              pathWeight: Number(node.path_weight),
               hopDistance: Number(node.hop_distance || 1),
-              metadata: entry.metadata,
             });
           }
         }
       }
     }
 
+    // Batch fetch all node contents at once
+    const graphResults: LlamaIndexSearchResult[] = [];
+    if (nodeIds.size > 0) {
+      const { data: entries } = await client
+        .from('knowledge_base')
+        .select('id, title, content, metadata')
+        .in('id', Array.from(nodeIds));
+
+      if (entries) {
+        for (const entry of entries) {
+          const meta = nodeMetaMap.get(entry.id);
+          graphResults.push({
+            id: entry.id,
+            title: entry.title,
+            content: entry.content,
+            score: (meta?.pathWeight ?? 1) * 0.8, // Weight graph results lower
+            sourceType: 'graph', // Use 'graph' for backward compatibility
+            hopDistance: meta?.hopDistance ?? 1,
+            metadata: entry.metadata,
+          });
+        }
+      }
+    }
+
     // 3. Combine and deduplicate
     const allResults = [...vectorResults, ...graphResults];
     const seen = new Set<string>();
@@ -420,41 +443,65 @@ export async function hybridGraphSearch(
       metadata: row.metadata as Record<string, unknown>,
     }));
```

## ğŸ“„ cloud-run/ai-engine/src/routes/analytics.ts

```diff
diff --git a/cloud-run/ai-engine/src/routes/analytics.ts b/cloud-run/ai-engine/src/routes/analytics.ts
index 810b65b76..cd3d7ca56 100644
--- a/cloud-run/ai-engine/src/routes/analytics.ts
+++ b/cloud-run/ai-engine/src/routes/analytics.ts
@@ -4,14 +4,15 @@
  * Server analysis, incident reporting, and batch analysis endpoints.
  * Uses specialized AI agents for natural language responses.
  *
- * @version 2.0.0 - Agent Integration
+ * @version 3.0.0 - Migrated to AI SDK v6 native
  * @created 2025-12-28
- * @updated 2025-12-30
+ * @updated 2026-01-24 - Removed @ai-sdk-tools/agents dependency
  */
 
 import { Hono } from 'hono';
 import type { Context } from 'hono';
 import { randomUUID } from 'crypto';
+import { generateText } from 'ai';
 import {
   detectAnomalies,
   predictTrends,
@@ -23,8 +24,8 @@ import {
 import { getCurrentState } from '../data/precomputed-state';
 import { handleApiError, jsonSuccess } from '../lib/error-handler';
 import { sanitizeChineseCharacters, sanitizeJsonStrings } from '../lib/text-sanitizer';
-import { reporterAgent } from '../services/ai-sdk/agents/reporter-agent';
-import { analystAgent } from '../services/ai-sdk/agents/analyst-agent';
+import { getReporterAgentConfig, isReporterAgentAvailable } from '../services/ai-sdk/agents/reporter-agent';
+import { getAnalystAgentConfig, isAnalystAgentAvailable } from '../services/ai-sdk/agents/analyst-agent';
 import {
   syncIncidentsToRAG,
   getRAGInjectionStats,
@@ -90,7 +91,9 @@ analyticsRouter.post('/analyze-server', async (c: Context) => {
     }
 
     // 2. Use Agent for natural language insights (if available)
-    if (analystAgent) {
+    const analystConfig = getAnalystAgentConfig();
+    const analystModelResult = analystConfig?.getModel();
+    if (analystConfig && analystModelResult && isAnalystAgentAvailable()) {
       try {
         const anomalyData = results.anomalyDetection as { hasAnomalies?: boolean; anomalyCount?: number } | undefined;
         const trendData = results.trendPrediction as { summary?: { hasRisingTrends?: boolean } } | undefined;
@@ -108,7 +111,15 @@ analyticsRouter.post('/analyze-server', async (c: Context) => {
 JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
 {"summary": "...", "recommendations": ["...", "..."], "confidence": 0.9}`;
 
-        const agentResult = await analystAgent.generate({ prompt });
+        const agentResult = await generateText({
+          model: analystModelResult.model,
+          messages: [
+            { role: 'system', content: analystConfig.instructions },
+            { role: 'user', content: prompt },
+          ],
+          temperature: 0.4,
+          maxOutputTokens: 512,
+        });
 
         // Sanitize Chinese characters from LLM output
         const sanitizedText = sanitizeChineseCharacters(agentResult.text);
@@ -191,7 +202,9 @@ analyticsRouter.post('/incident-report', async (c: Context) => {
     const toolBasedData = extractToolBasedData(anomalyData, trendData, timelineData, serverId);
 
     // Check if Reporter Agent is available
-    if (!reporterAgent) {
+    const reporterConfig = getReporterAgentConfig();
+    const reporterModelResult = reporterConfig?.getModel();
+    if (!reporterConfig || !reporterModelResult || !isReporterAgentAvailable()) {
       console.warn('âš ï¸ [Incident Report] Reporter Agent unavailable, using tool-based fallback');
       return jsonSuccess(c, {
         ...toolBasedData,
@@ -245,8 +258,14 @@ ${metricsContext}
 
     console.log(`ğŸ¤– [Incident Report] Invoking Reporter Agent with JSON output...`);
 
-    const result = await reporterAgent.generate({
-      prompt,
+    const result = await generateText({
+      model: reporterModelResult.model,
+      messages: [
+        { role: 'system', content: reporterConfig.instructions },
+        { role: 'user', content: prompt },
+      ],
+      temperature: 0.4,
+      maxOutputTokens: 1024,
     });
 
     const durationMs = Date.now() - startTime;
```

## ğŸ“„ cloud-run/ai-engine/src/services/ai-sdk/agents/advisor-agent.ts

```diff
diff --git a/cloud-run/ai-engine/src/services/ai-sdk/agents/advisor-agent.ts b/cloud-run/ai-engine/src/services/ai-sdk/agents/advisor-agent.ts
index 3e8d041d5..0485c10be 100644
--- a/cloud-run/ai-engine/src/services/ai-sdk/agents/advisor-agent.ts
+++ b/cloud-run/ai-engine/src/services/ai-sdk/agents/advisor-agent.ts
@@ -6,44 +6,39 @@
  *
  * Model: Mistral mistral-small-2506 (RAG + reasoning)
  *
- * @version 2.0.0 - SSOT refactoring
+ * @version 3.0.0 - Migrated to AI SDK v6 native (no Agent class)
  * @created 2025-12-01
- * @updated 2026-01-06 - Import config from SSOT
+ * @updated 2026-01-24 - Removed @ai-sdk-tools/agents dependency
  */
 
-import { Agent } from '@ai-sdk-tools/agents';
-import { AGENT_CONFIGS } from './config';
+import { AGENT_CONFIGS, type AgentConfig } from './config';
 
 // ============================================================================
-// Agent Instance (Created from SSOT Config)
+// Agent Config Export (for use with generateText/streamText)
 // ============================================================================
 
-function createAdvisorAgent() {
+/**
+ * Get Advisor Agent configuration
+ * Use with orchestrator's executeForcedRouting or executeAgentStream
+ */
+export function getAdvisorAgentConfig(): AgentConfig | null {
   const config = AGENT_CONFIGS['Advisor Agent'];
   if (!config) {
     console.error('âŒ [Advisor Agent] Config not found in AGENT_CONFIGS');
     return null;
   }
+  return config;
+}
 
-  const modelResult = config.getModel();
-  if (!modelResult) {
-    console.warn('âš ï¸ [Advisor Agent] No model available (need MISTRAL_API_KEY)');
-    return null;
-  }
-
-  const { model, provider, modelId } = modelResult;
-  console.log(`ğŸ’¡ [Advisor Agent] Using ${provider}/${modelId}`);
-
-  return new Agent({
-    name: config.name,
-    model,
-    instructions: config.instructions,
-    tools: config.tools,
-    handoffDescription: config.description,
-    matchOn: config.matchPatterns,
-  });
+/**
+ * Check if Advisor Agent is available (has valid model)
+ */
+export function isAdvisorAgentAvailable(): boolean {
+  const config = getAdvisorAgentConfig();
+  return config?.getModel() !== null;
 }
 
-export const advisorAgent = createAdvisorAgent();
+// Legacy export for compatibility (deprecated - use getAdvisorAgentConfig instead)
+export const advisorAgent = null;
 
 export default advisorAgent;
```

## ğŸ“„ cloud-run/ai-engine/src/services/ai-sdk/agents/analyst-agent.ts

```diff
diff --git a/cloud-run/ai-engine/src/services/ai-sdk/agents/analyst-agent.ts b/cloud-run/ai-engine/src/services/ai-sdk/agents/analyst-agent.ts
index 794663c97..f2f720f2b 100644
--- a/cloud-run/ai-engine/src/services/ai-sdk/agents/analyst-agent.ts
+++ b/cloud-run/ai-engine/src/services/ai-sdk/agents/analyst-agent.ts
@@ -6,44 +6,39 @@
  *
  * Model: Groq llama-3.3-70b (primary) / Cerebras (fallback)
  *
- * @version 2.0.0 - SSOT refactoring
+ * @version 3.0.0 - Migrated to AI SDK v6 native (no Agent class)
  * @created 2025-12-01
- * @updated 2026-01-06 - Import config from SSOT
+ * @updated 2026-01-24 - Removed @ai-sdk-tools/agents dependency
  */
 
-import { Agent } from '@ai-sdk-tools/agents';
-import { AGENT_CONFIGS } from './config';
+import { AGENT_CONFIGS, type AgentConfig } from './config';
 
 // ============================================================================
-// Agent Instance (Created from SSOT Config)
+// Agent Config Export (for use with generateText/streamText)
 // ============================================================================
 
-function createAnalystAgent() {
+/**
+ * Get Analyst Agent configuration
+ * Use with orchestrator's executeForcedRouting or executeAgentStream
+ */
+export function getAnalystAgentConfig(): AgentConfig | null {
   const config = AGENT_CONFIGS['Analyst Agent'];
   if (!config) {
     console.error('âŒ [Analyst Agent] Config not found in AGENT_CONFIGS');
     return null;
   }
+  return config;
+}
 
-  const modelResult = config.getModel();
-  if (!modelResult) {
-    console.warn('âš ï¸ [Analyst Agent] No model available (need GROQ_API_KEY or CEREBRAS_API_KEY)');
-    return null;
-  }
-
-  const { model, provider, modelId } = modelResult;
-  console.log(`ğŸ”¬ [Analyst Agent] Using ${provider}/${modelId}`);
-
-  return new Agent({
-    name: config.name,
-    model,
-    instructions: config.instructions,
-    tools: config.tools,
-    handoffDescription: config.description,
-    matchOn: config.matchPatterns,
-  });
+/**
+ * Check if Analyst Agent is available (has valid model)
+ */
+export function isAnalystAgentAvailable(): boolean {
+  const config = getAnalystAgentConfig();
+  return config?.getModel() !== null;
 }
 
-export const analystAgent = createAnalystAgent();
+// Legacy export for compatibility (deprecated - use getAnalystAgentConfig instead)
+export const analystAgent = null;
 
 export default analystAgent;
```

## ğŸ“„ cloud-run/ai-engine/src/services/ai-sdk/agents/config/agent-configs.ts

```diff
diff --git a/cloud-run/ai-engine/src/services/ai-sdk/agents/config/agent-configs.ts b/cloud-run/ai-engine/src/services/ai-sdk/agents/config/agent-configs.ts
index c76ff646f..4bfa57c02 100644
--- a/cloud-run/ai-engine/src/services/ai-sdk/agents/config/agent-configs.ts
+++ b/cloud-run/ai-engine/src/services/ai-sdk/agents/config/agent-configs.ts
@@ -447,12 +447,13 @@ export const AGENT_CONFIGS: Record<string, AgentConfig> = {
   'Advisor Agent': {
     name: 'Advisor Agent',
     description:
-      'ë¬¸ì œ í•´ê²° ë°©ë²•, CLI ëª…ë ¹ì–´ ì¶”ì²œ, ê³¼ê±° ì¥ì•  ì‚¬ë¡€ ê²€ìƒ‰, íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤. "ì–´ë–»ê²Œ í•´ê²°?", "ëª…ë ¹ì–´ ì•Œë ¤ì¤˜" ì§ˆë¬¸ì— ì í•©í•©ë‹ˆë‹¤.',
+      'ë¬¸ì œ í•´ê²° ë°©ë²•, CLI ëª…ë ¹ì–´ ì¶”ì²œ, ê³¼ê±° ì¥ì•  ì‚¬ë¡€ ê²€ìƒ‰, íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ, ì›¹ ê²€ìƒ‰ì„ ì œê³µí•©ë‹ˆë‹¤. "ì–´ë–»ê²Œ í•´ê²°?", "ëª…ë ¹ì–´ ì•Œë ¤ì¤˜" ì§ˆë¬¸ì— ì í•©í•©ë‹ˆë‹¤.',
     getModel: getAdvisorModel,
     instructions: ADVISOR_INSTRUCTIONS,
     tools: {
       searchKnowledgeBase,
       recommendCommands,
+      searchWeb, // Added for external knowledge when RAG insufficient
     },
     matchPatterns: [
       // Solution keywords
```

## ğŸ“„ cloud-run/ai-engine/src/services/ai-sdk/agents/index.ts

```diff
diff --git a/cloud-run/ai-engine/src/services/ai-sdk/agents/index.ts b/cloud-run/ai-engine/src/services/ai-sdk/agents/index.ts
index 0fea265af..a128f3270 100644
--- a/cloud-run/ai-engine/src/services/ai-sdk/agents/index.ts
+++ b/cloud-run/ai-engine/src/services/ai-sdk/agents/index.ts
@@ -1,37 +1,64 @@
 /**
- * Multi-Agent System with @ai-sdk-tools/agents
+ * Multi-Agent System with AI SDK v6 Native
  *
  * Architecture:
- * - Orchestrator (Cerebras): Fast routing
+ * - Orchestrator: Rule-based + LLM routing using generateText
  * - NLQ Agent (Cerebras): Natural language query processing + summaries
  * - Analyst Agent (Groq): Anomaly detection, trend prediction
  * - Reporter Agent (Groq): Incident reports, timelines
  * - Advisor Agent (Mistral): Troubleshooting guides, RAG search
  *
- * Usage:
- * - Multi-agent mode: Orchestrator â†’ NLQ/Analyst/Reporter/Advisor
- * - Direct routes: /analyze-server â†’ Analyst, /incident-report â†’ Reporter
+ * All agents are now executed via generateText/streamText directly,
+ * eliminating the @ai-sdk-tools/agents dependency.
  *
- * @version 2.1.0 - Removed Summarizer Agent (merged into NLQ)
- * @updated 2026-01-12
+ * @version 3.0.0 - Migrated to AI SDK v6 native
+ * @updated 2026-01-24 - Removed @ai-sdk-tools/agents dependency
  */
 
-export { orchestrator, executeMultiAgent, executeMultiAgentStream, getRecentHandoffs, preFilterQuery } from './orchestrator';
-export { nlqAgent } from './nlq-agent';
-export { analystAgent } from './analyst-agent';
-export { reporterAgent, generateHighQualityReport } from './reporter-agent';
-export { advisorAgent } from './advisor-agent';
+export {
+  orchestrator,
+  executeMultiAgent,
+  executeMultiAgentStream,
+  getRecentHandoffs,
+  preFilterQuery,
+  shouldEnableWebSearch,
+  resolveWebSearchSetting,
+} from './orchestrator';
+export { nlqAgent, getNlqAgentConfig, isNlqAgentAvailable } from './nlq-agent';
+export { analystAgent, getAnalystAgentConfig, isAnalystAgentAvailable } from './analyst-agent';
+export { reporterAgent, getReporterAgentConfig, isReporterAgentAvailable, generateHighQualityReport } from './reporter-agent';
+export { advisorAgent, getAdvisorAgentConfig, isAdvisorAgentAvailable } from './advisor-agent';
 export { executeReporterPipeline, type PipelineResult, type PipelineConfig } from './reporter-pipeline';
 export type { MultiAgentRequest, MultiAgentResponse } from './orchestrator';
+export { AGENT_CONFIGS, type AgentConfig, getAgentNames, getAgentConfig, isAgentAvailable, getAvailableAgents } from './config';
+
+// Zod schemas for type-safe structured output
+export {
+  routingSchema,
+  taskDecomposeSchema,
+  anomalySchema,
+  incidentReportSchema,
+  serverQueryResultSchema,
+  recommendationSchema,
+  type RoutingDecision,
+  type TaskDecomposition,
+  type Subtask,
+  type AnomalyResult,
+  type IncidentReport,
+  type ServerQueryResult,
+  type Recommendation,
+  AGENT_NAMES,
+  type AgentName,
+} from './schemas';
 
 // ============================================================================
 // Agent Availability Check (Debugging)
 // ============================================================================
 
-import { nlqAgent as _nlqAgent } from './nlq-agent';
-import { analystAgent as _analystAgent } from './analyst-agent';
-import { reporterAgent as _reporterAgent } from './reporter-agent';
-import { advisorAgent as _advisorAgent } from './advisor-agent';
+import { isNlqAgentAvailable } from './nlq-agent';
+import { isAnalystAgentAvailable } from './analyst-agent';
+import { isReporterAgentAvailable } from './reporter-agent';
+import { isAdvisorAgentAvailable } from './advisor-agent';
 
 /**
  * Get available agents status for debugging
@@ -43,10 +70,10 @@ export function getAvailableAgentsStatus(): {
   details: string[];
 } {
   const agents = {
-    'NLQ Agent': _nlqAgent !== null,
-    'Analyst Agent': _analystAgent !== null,
-    'Reporter Agent': _reporterAgent !== null,
-    'Advisor Agent': _advisorAgent !== null,
+    'NLQ Agent': isNlqAgentAvailable(),
+    'Analyst Agent': isAnalystAgentAvailable(),
+    'Reporter Agent': isReporterAgentAvailable(),
+    'Advisor Agent': isAdvisorAgentAvailable(),
   };
 
   const available = Object.entries(agents)
```

## ğŸ“„ cloud-run/ai-engine/src/services/ai-sdk/agents/nlq-agent.ts

```diff
diff --git a/cloud-run/ai-engine/src/services/ai-sdk/agents/nlq-agent.ts b/cloud-run/ai-engine/src/services/ai-sdk/agents/nlq-agent.ts
index e44b2fd1b..3e7a29b41 100644
--- a/cloud-run/ai-engine/src/services/ai-sdk/agents/nlq-agent.ts
+++ b/cloud-run/ai-engine/src/services/ai-sdk/agents/nlq-agent.ts
@@ -8,44 +8,39 @@
  * Model: Cerebras llama-3.3-70b (primary) - 24M tokens/day free
  * Fallback: Groq llama-3.3-70b-versatile
  *
- * @version 2.0.0 - SSOT refactoring
+ * @version 3.0.0 - Migrated to AI SDK v6 native (no Agent class)
  * @created 2025-12-01
- * @updated 2026-01-06 - Import config from SSOT
+ * @updated 2026-01-24 - Removed @ai-sdk-tools/agents dependency
  */
 
-import { Agent } from '@ai-sdk-tools/agents';
-import { AGENT_CONFIGS } from './config';
+import { AGENT_CONFIGS, type AgentConfig } from './config';
 
 // ============================================================================
-// Agent Instance (Created from SSOT Config)
+// Agent Config Export (for use with generateText/streamText)
 // ============================================================================
 
-function createNlqAgent() {
+/**
+ * Get NLQ Agent configuration
+ * Use with orchestrator's executeForcedRouting or executeAgentStream
+ */
+export function getNlqAgentConfig(): AgentConfig | null {
   const config = AGENT_CONFIGS['NLQ Agent'];
   if (!config) {
     console.error('âŒ [NLQ Agent] Config not found in AGENT_CONFIGS');
     return null;
   }
+  return config;
+}
 
-  const modelResult = config.getModel();
-  if (!modelResult) {
-    console.warn('âš ï¸ [NLQ Agent] No model available (need CEREBRAS_API_KEY or GROQ_API_KEY)');
-    return null;
-  }
-
-  const { model, provider, modelId } = modelResult;
-  console.log(`ğŸ”§ [NLQ Agent] Using ${provider}/${modelId}`);
-
-  return new Agent({
-    name: config.name,
-    model,
-    instructions: config.instructions,
-    tools: config.tools,
-    handoffDescription: config.description,
-    matchOn: config.matchPatterns,
-  });
+/**
+ * Check if NLQ Agent is available (has valid model)
+ */
+export function isNlqAgentAvailable(): boolean {
+  const config = getNlqAgentConfig();
+  return config?.getModel() !== null;
 }
 
-export const nlqAgent = createNlqAgent();
+// Legacy export for compatibility (deprecated - use getNlqAgentConfig instead)
+export const nlqAgent = null;
 
 export default nlqAgent;
```

## ğŸ“„ cloud-run/ai-engine/src/services/ai-sdk/agents/orchestrator.test.ts

```diff
diff --git a/cloud-run/ai-engine/src/services/ai-sdk/agents/orchestrator.test.ts b/cloud-run/ai-engine/src/services/ai-sdk/agents/orchestrator.test.ts
index 7ec08322b..60a6374de 100644
--- a/cloud-run/ai-engine/src/services/ai-sdk/agents/orchestrator.test.ts
+++ b/cloud-run/ai-engine/src/services/ai-sdk/agents/orchestrator.test.ts
@@ -4,7 +4,7 @@
  * Unit tests for multi-agent orchestration system.
  * Tests mode selection, fallback chains, and response handling.
  *
- * @version 1.0.0
+ * @version 3.0.0 - Updated for AI SDK v6 native architecture
  */
 
 import { describe, it, expect, vi, beforeEach } from 'vitest';
@@ -22,72 +22,40 @@ vi.mock('../model-provider', () => ({
   logProviderStatus: vi.fn(),
 }));
 
-// Mock @ai-sdk-tools/agents with proper class including stream support
-vi.mock('@ai-sdk-tools/agents', () => {
-  return {
-    Agent: class MockAgent {
-      name: string;
-      model: unknown;
-      instructions: string;
-      tools: Record<string, unknown>;
-      handoffs: unknown[];
-      matchOn: unknown[];
-      maxTurns: number;
-
-      constructor(config: {
-        name: string;
-        model?: unknown;
-        instructions?: string;
-        tools?: Record<string, unknown>;
-        handoffs?: unknown[];
-        matchOn?: unknown[];
-        maxTurns?: number;
-      }) {
-        this.name = config.name;
-        this.model = config.model;
-        this.instructions = config.instructions || '';
-        this.tools = config.tools || {};
-        this.handoffs = config.handoffs || [];
-        this.matchOn = config.matchOn || [];
-        this.maxTurns = config.maxTurns || 10;
-      }
-
-      async generate(_options: { prompt: string }) {
-        return {
-          text: 'Mock response from ' + this.name,
-          handoffs: [],
-          steps: [],
-          usage: { inputTokens: 100, outputTokens: 50, totalTokens: 150 },
-          finalAgent: this.name,
-        };
-      }
-
-      // Stream method for executeMultiAgentStream tests
-      stream(_options: { prompt: string }) {
-        const agentName = this.name;
-        return {
-          textStream: (async function* () {
-            yield 'Mock ';
-            yield 'streaming ';
-            yield 'response from ';
-            yield agentName;
-          })(),
-          steps: Promise.resolve([
-            { toolCalls: [{ toolName: 'getServerMetrics' }] },
-          ]),
-          usage: Promise.resolve({ inputTokens: 100, outputTokens: 50 }),
-        };
-      }
-    },
-  };
-});
+// Mock AI SDK - now we mock the actual 'ai' package
+vi.mock('ai', () => ({
+  generateText: vi.fn(async () => ({
+    text: 'Mock response from generateText',
+    usage: { promptTokens: 100, completionTokens: 50, totalTokens: 150 },
+    finishReason: 'stop',
+    toolCalls: [],
+    steps: [],
+  })),
+  streamText: vi.fn(() => ({
+    textStream: (async function* () {
+      yield 'Mock ';
+      yield 'streaming ';
+      yield 'response';
+    })(),
+    fullStream: (async function* () {
+      yield { type: 'text-delta', textDelta: 'Mock ' };
+      yield { type: 'text-delta', textDelta: 'streaming ' };
+      yield { type: 'text-delta', textDelta: 'response' };
+      yield { type: 'finish', finishReason: 'stop' };
+    })(),
+    toDataStreamResponse: vi.fn(),
+    usage: Promise.resolve({ promptTokens: 100, completionTokens: 50, totalTokens: 150 }),
+  })),
```

---

## âœ¨ AI ë¦¬ë·° ê²°ê³¼

ì•ˆë…•í•˜ì„¸ìš”, Principal Software Architectì…ë‹ˆë‹¤. ìš”ì²­í•˜ì‹  Git ë³€ê²½ì‚¬í•­(`feat(ai-engine): migrate to AI SDK v6 native pattern`)ì— ëŒ€í•œ ì‹œë‹ˆì–´ ë ˆë²¨ ì½”ë“œ ë¦¬ë·° ê²°ê³¼ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.

AI SDKì˜ ì¶”ìƒí™”ëœ Agent í´ë˜ìŠ¤ ì˜ì¡´ì„±ì„ ì œê±°í•˜ê³  Native íŒ¨í„´ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ë°©í–¥ì„±ì€ ì•„í‚¤í…ì²˜ ê´€ì ì—ì„œ **ë§¤ìš° ë°”ëŒì§**í•©ë‹ˆë‹¤. ë˜í•œ `llamaindex-rag-service.ts`ì˜ ì„±ëŠ¥ ìµœì í™”ë„ í›Œë¥­í•©ë‹ˆë‹¤.

ë‹¤ë§Œ, **`embedding.ts`ì— ì‹¬ê°í•œ ë…¼ë¦¬ì  ê²°í•¨(Cache Collision)**ì´ ë°œê²¬ë˜ì–´ **ìˆ˜ì • í›„ ìŠ¹ì¸(Conditioned Approval)**ì´ í•„ìš”í•©ë‹ˆë‹¤.

---

### 1. ğŸ› ë²„ê·¸ ë° ì •í•©ì„± (Critical)

#### ğŸš¨ Embedding Cache Key ì¶©ëŒ ìœ„í—˜ (`embedding.ts`)
ì„ë² ë”© ìºì‹± ë¡œì§ì—ì„œ í‚¤ ìƒì„± ë°©ì‹ì´ ë„ˆë¬´ ë‹¨ìˆœí•˜ì—¬ ì„œë¡œ ë‹¤ë¥¸ í…ìŠ¤íŠ¸ê°€ ê°™ì€ í‚¤ë¥¼ ê°€ì§ˆ í™•ë¥ ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.

*   **ë¬¸ì œ ì½”ë“œ**:
    ```typescript
    function getCacheKey(text: string): string {
      return text.trim().toLowerCase().substring(0, 200); // Limit key size
    }
    ```
    *   **ë¬¸ì œì **: í…ìŠ¤íŠ¸ì˜ **ì• 200ìë§Œ** í‚¤ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. ë¬¸ì„œì˜ ì•ë¶€ë¶„ì´ ë™ì¼í•˜ê³  ë’·ë¶€ë¶„ë§Œ ë‹¤ë¥¸ ê²½ìš°(ì˜ˆ: ê³„ì•½ì„œ, í…œí”Œë¦¿ ê¸°ë°˜ ë¬¸ì„œ, ë‰´ìŠ¤ ê¸°ì‚¬ í—¤ë“œë¼ì¸ ë“±), **ì™„ì „íˆ ë‹¤ë¥¸ ë‚´ìš©ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  ì˜ëª»ëœ(ì´ì „) ì„ë² ë”© ë²¡í„°ë¥¼ ë°˜í™˜**í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ëŠ” RAG ê²€ìƒ‰ í’ˆì§ˆì„ ì‹¬ê°í•˜ê²Œ ì €í•˜ì‹œí‚µë‹ˆë‹¤.

*   **âœ… ê°œì„  ê¶Œì¥ (Snippet)**:
    Node.js í™˜ê²½ì´ë¯€ë¡œ `crypto`ë¥¼ ì‚¬ìš©í•´ í•´ì‹œë¥¼ ìƒì„±í•˜ê±°ë‚˜, ì ì–´ë„ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. (ë©”ëª¨ë¦¬ ì œì•½ì´ ìˆë‹¤ë©´ í•´ì‹œ í•„ìˆ˜)

    ```typescript
    import { createHash } from 'crypto';

    function getCacheKey(text: string): string {
      // í…ìŠ¤íŠ¸ ì „ì²´ë¥¼ í•´ì‹œí•˜ì—¬ ê³ ìœ ì„± ë³´ì¥ ë° í‚¤ ê¸¸ì´ ì¼ì •í™”
      return createHash('sha256').update(text.trim().toLowerCase()).digest('hex');
    }
    ```

---

### 2. âš¡ ì„±ëŠ¥ ë° íš¨ìœ¨ì„±

#### ğŸ‘ RAG ê²€ìƒ‰ ë³‘ë ¬í™” (`llamaindex-rag-service.ts`)
ê¸°ì¡´ ìˆœì°¨ ì²˜ë¦¬(Loop)ë¥¼ `Promise.all`ê³¼ ë°°ì¹˜ ì¡°íšŒ(`in('id', ...)`)ë¡œ ë³€ê²½í•œ ê²ƒì€ í›Œë¥­í•œ ìµœì í™”ì…ë‹ˆë‹¤. DB Round Tripì„ íšê¸°ì ìœ¼ë¡œ ì¤„ì˜€ìŠµë‹ˆë‹¤.

*   **âš ï¸ ê°œì„  ì œì•ˆ (Optional)**:
    `Promise.all`ì€ í•˜ë‚˜ì˜ ìš”ì²­ë§Œ ì‹¤íŒ¨í•´ë„(ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ë“±) ì „ì²´ê°€ ì‹¤íŒ¨(Reject)í•©ë‹ˆë‹¤. "ì§€ì‹ ê·¸ë˜í”„ íƒìƒ‰"ì€ ë³´ì¡°ì ì¸ ì •ë³´ì´ë¯€ë¡œ ì¼ë¶€ ì‹¤íŒ¨í•˜ë”ë¼ë„ ë‚˜ë¨¸ì§€ëŠ” ì„±ê³µì‹œí‚¤ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.
    *   **ì œì•ˆ**: `Promise.all` ëŒ€ì‹  `Promise.allSettled`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤íŒ¨í•œ ìš”ì²­ì€ ë¬´ì‹œí•˜ê³  ì„±ê³µí•œ ê²°ê³¼ë§Œ ì§‘ê³„í•˜ëŠ” ë°©ì–´ì  ì½”ë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.

---

### 3. ğŸ›¡ï¸ ë³´ì•ˆ ë° ì•ˆì „ì„±

#### âš ï¸ `Promise.all` ë‚´ `client` ê°ì²´ ì°¸ì¡° (`llamaindex-rag-service.ts`)
```typescript
const client = supabaseClient!;
// ...
client.rpc(...)
```
*   `supabaseClient`ê°€ `null`ì´ ì•„ë‹˜ì„ ìƒìœ„ ìŠ¤ì½”í”„ì—ì„œ ë³´ì¥í•œë‹¤ê³  í•˜ì…¨ìœ¼ë‚˜, íƒ€ì… ë‹¨ì–¸(`!`)ë³´ë‹¤ëŠ” ê°€ë“œ ì ˆì„ ëª…í™•íˆ ë‘ëŠ” ê²ƒì´ ëŸ°íƒ€ì„ ì•ˆì „ì„±ì— ì¢‹ìŠµë‹ˆë‹¤. (í˜„ì¬ ì½”ë“œ íë¦„ìƒ í° ë¬¸ì œëŠ” ì—†ì–´ ë³´ì…ë‹ˆë‹¤.)

#### ğŸ”„ Agent Fallback ë¡œì§ (`analytics.ts`)
*   `Reporter Agent`ê°€ ì—†ì„ ë•Œ íˆ´ ê¸°ë°˜ìœ¼ë¡œ Fallbackí•˜ëŠ” ë¡œì§(`if (!reporterConfig ...)`)ì´ ì˜ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ˆì´ê·¸ë ˆì´ì…˜ ê³¼ì •ì—ì„œ ëˆ„ë½ë˜ê¸° ì‰¬ìš´ ë¶€ë¶„ì¸ë° ì˜ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.

---

### 4. ğŸ—ï¸ ì½”ë“œ í’ˆì§ˆ ë° êµ¬ì¡°

*   **Dependency ì œê±°**: `@ai-sdk-tools/agents` ì œê±°ëŠ” í”„ë¡œì íŠ¸ì˜ ë³µì¡ë„ë¥¼ ë‚®ì¶”ê³  `ai` SDKì˜ ìµœì‹  ê¸°ëŠ¥ì„ ì§ì ‘ ì œì–´í•  ìˆ˜ ìˆê²Œ ë˜ì–´ ìœ ì§€ë³´ìˆ˜ì„±ì— ê¸ì •ì ì…ë‹ˆë‹¤.
*   **Factory Pattern ë³€ê²½**: `class Agent` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ë°©ì‹ì—ì„œ `getAgentConfig()` í•¨ìˆ˜í˜• ì ‘ê·¼ìœ¼ë¡œ ë³€ê²½í•œ ê²ƒì€ Tree Shaking ë° í…ŒìŠ¤íŠ¸ ìš©ì´ì„± ì¸¡ë©´ì—ì„œ ì¢‹ìŠµë‹ˆë‹¤.

---

### 5. ğŸ“š ë¬¸ì„œ/í…ŒìŠ¤íŠ¸

*   **API ë¬¸ì„œ ëˆ„ë½**: ìë™ ê²€ì¦ ë¡œê·¸ì—ì„œ ì§€ì í•œ ëŒ€ë¡œ, `analytics.ts`ì˜ ë¡œì§ ë³€ê²½(Agent í˜¸ì¶œ ë°©ì‹ ë³€ê²½)ì€ APIì˜ ì‘ë‹µ ìŠ¤í‚¤ë§ˆì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•Šë”ë¼ë„, ë‚´ë¶€ ì²˜ë¦¬ ë°©ì‹ì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ `CHANGELOG.md`ë‚˜ ê°œë°œ ë¬¸ì„œì— "Agent ì²˜ë¦¬ ë°©ì‹ ë³€ê²½"ì„ ëª…ì‹œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
*   **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: `orchestrator.test.ts`ê°€ `ai` ëª¨ë“ˆì„ ëª¨í‚¹í•˜ë„ë¡ ì ì ˆíˆ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. `generateText`ì™€ `streamText`ì— ëŒ€í•œ ëª¨í‚¹ì´ ì˜ ì´ë£¨ì–´ì¡ŒìŠµë‹ˆë‹¤.

---

### â­ ì¢…í•© í‰ê°€ ë° ê²°ë¡ 

*   **ì ìˆ˜**: **8.5 / 10**
*   **ê²°ì •**: **ì¡°ê±´ë¶€ ìŠ¹ì¸ (Changes Requested)**

**ìŠ¹ì¸ ì¡°ê±´**:
1.  **í•„ìˆ˜**: `cloud-run/ai-engine/src/lib/embedding.ts`ì˜ `getCacheKey` í•¨ìˆ˜ë¥¼ í•´ì‹œ ê¸°ë°˜(SHA-256 ë“±)ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ **Cache Collision** ë¬¸ì œë¥¼ í•´ê²°í•˜ì‹­ì‹œì˜¤.
2.  **ê¶Œì¥**: `llamaindex-rag-service.ts`ì—ì„œ `Promise.all`ì„ `Promise.allSettled`ë¡œ ë³€ê²½í•˜ì—¬ ë¶€ë¶„ ì‹¤íŒ¨ì— ëŒ€í•œ íšŒë³µ íƒ„ë ¥ì„±ì„ í™•ë³´í•˜ì‹­ì‹œì˜¤.

ìœ„ 1ë²ˆ í•­ëª©(ë²„ê·¸)ë§Œ ìˆ˜ì •ë˜ë©´ ì¦‰ì‹œ ë°°í¬ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì˜ ê³ í’ˆì§ˆ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤.

**ìˆ˜ì • í›„ ì»¤ë°‹ ë©”ì‹œì§€ ì œì•ˆ**:
```text
fix(ai-engine): use hash for embedding cache key to prevent collisions
```

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë²„ê·¸ ìœ„í—˜ ì‚¬í•­ í™•ì¸ ì™„ë£Œ
- [ ] ê°œì„  ì œì•ˆ ê²€í†  ì™„ë£Œ
- [ ] TypeScript ì•ˆì „ì„± í™•ì¸ ì™„ë£Œ
- [ ] ë³´ì•ˆ ì´ìŠˆ í™•ì¸ ì™„ë£Œ
- [ ] ì¢…í•© í‰ê°€ í™•ì¸ ì™„ë£Œ

## ğŸš¨ ì˜¤íƒ(False Positive) ê¸°ë¡

<!-- ê±°ë¶€/ì €ì ìˆ˜ê°€ ì˜¤íƒì¸ ê²½ìš° ì•„ë˜ì— ê¸°ë¡ -->
<!-- ì˜ˆì‹œ: - [x] limit ê²€ì¦ ì´ìŠˆ: Mock í•¸ë“¤ëŸ¬ë¼ ì‹¤ì œ ì˜í–¥ ì—†ìŒ -->


---

**ìƒì„± ì‹œê°„**: 2026-01-24 12:22:45
**ë¦¬ë·° íŒŒì¼**: `/mnt/d/cursor/openmanager-vibe-v5/reports/ai-review/pending/review-gemini-2026-01-24-12-20-26.md`
**AI ì—”ì§„**: GEMINI
