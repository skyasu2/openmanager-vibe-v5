# Vercel 배포 가이드

OpenManager Vibe V5 프로젝트를 Vercel에 배포하기 위한 단계별 가이드입니다.

## 사전 준비사항

### 1. 필수 계정

- [GitHub](https://github.com/) 계정
- [Vercel](https://vercel.com/) 계정
- [Upstash](https://upstash.com/) 계정 (Redis 데이터베이스용)
- [Supabase](https://supabase.com/) 계정 (PostgreSQL 데이터베이스 및 인증용)

### 2. 필수 도구

- Git
- Node.js 18.17 이상
- npm 또는 yarn

## 배포 단계

### 1. 코드 저장소 설정

1. GitHub에서 프로젝트 저장소를 복제합니다:

```bash
git clone https://github.com/your-username/openmanager-vibe-v5.git
cd openmanager-vibe-v5
```

2. 의존성을 설치합니다:

```bash
npm install
# 또는
yarn install
```

### 2. Upstash Redis 설정

1. [Upstash 콘솔](https://console.upstash.com/)에 로그인합니다.
2. 새 Redis 데이터베이스를 생성합니다:
   - 지역: 애플리케이션에 가장 가까운 지역 선택 (예: 한국의 경우 `ap-northeast-2`)
   - 이름: `openmanager-vibe-v5`
3. 생성된 데이터베이스의 연결 정보를 메모해둡니다:
   - `UPSTASH_REDIS_REST_URL`: REST API URL
   - `UPSTASH_REDIS_REST_TOKEN`: REST API 토큰

> **참고**: Upstash Redis는 무료 플랜에서 일 10,000 요청까지 가능합니다. 이는 개발 및 소규모 프로덕션 환경에 충분합니다.

### 3. Supabase 설정

1. [Supabase 대시보드](https://app.supabase.io/)에 로그인합니다.
2. 새 프로젝트를 생성합니다:
   - 이름: `openmanager-vibe-v5`
   - 데이터베이스 비밀번호: 안전한 비밀번호 설정 (메모해두세요)
   - 지역: 애플리케이션에 가장 가까운 지역 선택 (예: 한국의 경우 `Northeast Asia (Seoul)`)
3. 프로젝트 생성이 완료되면 대시보드에서 다음 정보를 찾아 메모해둡니다:
   - `SUPABASE_URL`: 설정 > API > URL
   - `SUPABASE_ANON_KEY`: 설정 > API > anon public key
   - `SUPABASE_SERVICE_ROLE_KEY`: 설정 > API > service_role secret key

4. SQL 편집기를 열고 필요한 테이블을 생성합니다:

```sql
-- servers 테이블: 모니터링 대상 서버 정보
CREATE TABLE public.servers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR NOT NULL,
  hostname VARCHAR NOT NULL,
  type VARCHAR NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- metrics 테이블: 성능 메트릭 데이터
CREATE TABLE public.metrics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  server_id UUID REFERENCES public.servers(id),
  key VARCHAR NOT NULL,
  data JSONB NOT NULL,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- alerts 테이블: 알림 기록
CREATE TABLE public.alerts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  server_id UUID REFERENCES public.servers(id),
  type VARCHAR NOT NULL,
  message TEXT NOT NULL,
  status VARCHAR NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  resolved_at TIMESTAMP WITH TIME ZONE
);

-- RLS 정책 설정 (Row Level Security)
ALTER TABLE public.servers ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.metrics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.alerts ENABLE ROW LEVEL SECURITY;

-- 인증된 사용자만 접근 가능하도록 정책 설정
CREATE POLICY "인증된 사용자만 서버 조회 가능" ON public.servers
  FOR SELECT USING (auth.role() = 'authenticated');
  
CREATE POLICY "인증된 사용자만 메트릭 조회 가능" ON public.metrics
  FOR SELECT USING (auth.role() = 'authenticated');

CREATE POLICY "인증된 사용자만 알림 조회 가능" ON public.alerts
  FOR SELECT USING (auth.role() = 'authenticated');
```

> **참고**: 무료 플랜에서는 500MB의 데이터베이스 용량이 제공됩니다. 메트릭 데이터가 많이 쌓일 경우 정기적인 정리 또는 요금제 업그레이드를 고려하세요.

### 4. Vercel 배포 설정

1. [Vercel 대시보드](https://vercel.com/dashboard)에 로그인합니다.
2. "New Project" 버튼을 클릭합니다.
3. GitHub 저장소를 가져옵니다:
   - 저장소 목록에서 `openmanager-vibe-v5`를 찾아 선택합니다.
   - "Import" 버튼을 클릭합니다.

4. 프로젝트 설정:
   - 프레임워크 프리셋: Next.js (자동 감지됨)
   - 루트 디렉토리: ./ (기본값)
   - 빌드 명령: 기본값 유지 (`next build`)

5. 환경 변수 설정:

#### 🌐 앱 기본 설정
```
Name: NEXT_PUBLIC_APP_URL
Value: https://openmanager-vibe-v5.vercel.app
Environment: Production, Preview, Development
```

#### 📊 Supabase 기본 연결
```
Name: NEXT_PUBLIC_SUPABASE_URL
Value: https://vnswjnltnhpsueosfhmw.supabase.co
Environment: Production, Preview, Development
```

```
Name: NEXT_PUBLIC_SUPABASE_ANON_KEY
Value: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuc3dqbmx0bmhwc3Vlb3NmaG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5MjMzMjcsImV4cCI6MjA2MzQ5OTMyN30.09ApSnuXNv_yYVJWQWGpOFWw3tkLbxSA21k5sroChGU
Environment: Production, Preview, Development
```

```
Name: SUPABASE_SERVICE_ROLE_KEY
Value: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuc3dqbmx0bmhwc3Vlb3NmaG13Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NzkyMzMyNywiZXhwIjoyMDYzNDk5MzI3fQ.xk2DUcqBZnaF-iuO7sbeXS-H43h8D5gppIlsJYw7xi8
Environment: Production, Preview, Development
```

#### 🔐 Supabase JWT 설정
```
Name: SUPABASE_JWT_SECRET
Value: qNzA4/WgbksJU3xxkQJcfbCRkXhgBR7TVmI4y2XKRy59BwtRk6iuUSdkRNNQN1Yud3PGsGLTcZkdHSTZL0mhug==
Environment: Production, Preview, Development
```

#### 🗄️ PostgreSQL 직접 연결 (고급 기능용)
```
Name: POSTGRES_URL
Value: postgres://postgres.vnswjnltnhpsueosfhmw:2D3DWhSl8HBlgYIm@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres?sslmode=require&supa=base-pooler.x
Environment: Production, Preview, Development
```

```
Name: POSTGRES_PRISMA_URL
Value: postgres://postgres.vnswjnltnhpsueosfhmw:2D3DWhSl8HBlgYIm@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres?sslmode=require&supa=base-pooler.x
Environment: Production, Preview, Development
```

```
Name: POSTGRES_URL_NON_POOLING
Value: postgres://postgres.vnswjnltnhpsueosfhmw:2D3DWhSl8HBlgYIm@aws-0-ap-southeast-1.pooler.supabase.com:5432/postgres?sslmode=require
Environment: Production, Preview, Development
```

#### 🔴 Redis/KV 완전 설정
```
Name: KV_URL
Value: rediss://default:AVQeAAIjcDE0YzRiMjUxODZmOWQ0MmE0YjhjZTcxOTg0NmFkNWRiYXAxMA@enormous-fawn-21534.upstash.io:6379
Environment: Production, Preview, Development
```

```
Name: KV_REST_API_URL
Value: https://enormous-fawn-21534.upstash.io
Environment: Production, Preview, Development
```

```
Name: KV_REST_API_TOKEN
Value: AVQeAAIjcDE0YzRiMjUxODZmOWQ0MmE0YjhjZTcxOTg0NmFkNWRiYXAxMA
Environment: Production, Preview, Development
```

```
Name: KV_REST_API_READ_ONLY_TOKEN
Value: AlQeAAIgcDHphq_ecCfiZotS1fIvLjHCmNqD4qI42PDvNi8TrRdyjQ
Environment: Production, Preview, Development
```

```
Name: REDIS_URL
Value: rediss://default:AVQeAAIjcDE0YzRiMjUxODZmOWQ0MmE0YjhjZTcxOTg0NmFkNWRiYXAxMA@enormous-fawn-21534.upstash.io:6379
Environment: Production, Preview, Development
```

**기존 Upstash 변수도 유지 (호환성)**
```
Name: UPSTASH_REDIS_REST_URL
Value: https://enormous-fawn-21534.upstash.io
Environment: Production, Preview, Development
```

```
Name: UPSTASH_REDIS_REST_TOKEN
Value: AVQeAAIjcDE0YzRiMjUxODZmOWQ0MmE0YjhjZTcxOTg0NmFkNWRiYXAxMA
Environment: Production, Preview, Development
```

#### 📝 추가 PostgreSQL 정보 (필요시)
프로젝트에서 직접 PostgreSQL 연결이 필요한 경우 다음도 추가:

```
Name: POSTGRES_HOST
Value: db.vnswjnltnhpsueosfhmw.supabase.co
Environment: Production, Preview, Development
```

```
Name: POSTGRES_USER
Value: postgres
Environment: Production, Preview, Development
```

```
Name: POSTGRES_PASSWORD
Value: 2D3DWhSl8HBlgYIm
Environment: Production, Preview, Development
```

```
Name: POSTGRES_DATABASE
Value: postgres
Environment: Production, Preview, Development
```

#### 🚀 필수 환경 변수 및 설정 순서

##### 필수 환경 변수 (반드시 설정)
- ✅ `NEXT_PUBLIC_APP_URL`
- ✅ `NEXT_PUBLIC_SUPABASE_URL`
- ✅ `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- ✅ `SUPABASE_SERVICE_ROLE_KEY`
- ✅ `UPSTASH_REDIS_REST_URL`
- ✅ `UPSTASH_REDIS_REST_TOKEN`

##### 고급 기능용 (선택사항)
- `SUPABASE_JWT_SECRET` (JWT 토큰 검증용)
- `POSTGRES_URL` (Prisma ORM 등 사용시)
- `POSTGRES_PRISMA_URL` (Prisma 전용)
- PostgreSQL 직접 연결 정보들

모든 환경 변수를 설정한 후에는 "Deploy" 버튼을 클릭하여 배포를 시작합니다.

> **주의사항**: 
> - **Public 환경 변수** (`NEXT_PUBLIC_*`): 클라이언트에서 접근 가능
> - **Private 환경 변수**: 서버에서만 접근 가능
> - **Secret 키들**: 절대 GitHub에 커밋하지 말 것

6. "Deploy" 버튼을 클릭하여 배포를 시작합니다.

### 5. 배포 확인 및 테스트

1. 배포가 완료되면 제공된 URL(예: `https://openmanager-vibe-v5.vercel.app`)로 접속합니다.
2. 다음 엔드포인트를 테스트해 모든 기능이 정상 작동하는지 확인합니다:
   - `/api/health` - 상태 확인 (200 OK 응답 확인)
   - `/api/monitoring/servers` - 서버 목록 확인 (로그인 후)
   - `/dashboard` - 대시보드 접속 (로그인 필요)

## 지속적 배포 설정

Vercel은 GitHub 저장소와 연동되어 코드가 메인 브랜치에 푸시될 때마다 자동으로 배포가 진행됩니다.

### 브랜치별 환경 설정

개발, 스테이징, 프로덕션과 같은 다양한 환경을 설정하려면:

1. Vercel 프로젝트 설정 페이지의 "Git" 탭으로 이동합니다.
2. "Production Branch"를 `main`으로 설정합니다.
3. "Preview Branch Deployments"를 활성화합니다.

이제 다음과 같이 브랜치에 따라 자동으로 환경이 구분됩니다:
- `main` 브랜치: 프로덕션 환경 (예: `https://openmanager-vibe-v5.vercel.app`)
- `dev` 브랜치: 개발 환경 (예: `https://dev-openmanager-vibe-v5.vercel.app`)
- 기타 브랜치/PR: 프리뷰 환경 (예: `https://feature-branch-openmanager-vibe-v5.vercel.app`)

### 환경별 변수 설정

각 환경에 맞는 환경 변수를 설정하려면:

1. Vercel 프로젝트 설정 페이지의 "Environment Variables" 탭으로 이동합니다.
2. 환경 변수를 추가할 때 "Environment"를 선택합니다:
   - Production: 프로덕션 환경에만 적용
   - Preview: 프리뷰 배포에만 적용
   - Development: 로컬 개발 환경에만 적용

> **팁**: 개발 환경과 프로덕션 환경에 서로 다른 Upstash/Supabase 인스턴스를 연결하면 프로덕션 데이터를 안전하게 유지할 수 있습니다.

## 문제 해결

### 배포 실패 시 확인사항

1. **빌드 오류**:
   - Vercel 대시보드에서 배포 로그 확인
   - 오류 메시지를 자세히 읽고 문제 파악
   - 로컬에서 `npm run build`를 실행하여 문제 재현 및 해결

2. **환경 변수 문제**:
   - 모든 필수 환경 변수가 올바르게 설정되었는지 확인
   - 환경 변수 이름이 코드의 참조와 정확히 일치하는지 확인
   - 환경 변수 값에 따옴표나 공백이 포함되어 있지 않은지 확인

3. **API 오류**:
   - Vercel 대시보드의 "Functions" 탭에서 서버리스 함수 로그 확인
   - 서버리스 함수 제한 시간(10초) 초과 여부 확인
   - 데이터베이스 연결 문제 확인

### 일반적인 오류와 해결방법

1. **"Cannot connect to database" 오류**:
   - Supabase 프로젝트가 활성 상태인지 확인
   - IP 제한이 설정되어 있는지 확인
   - 환경 변수 `SUPABASE_URL`과 `SUPABASE_ANON_KEY` 확인

2. **"Redis connection failed" 오류**:
   - Upstash 대시보드에서 데이터베이스 상태 확인
   - 환경 변수 `UPSTASH_REDIS_REST_URL`과 `UPSTASH_REDIS_REST_TOKEN` 확인
   - 요청 제한(무료 플랜: 일 10,000건)에 도달했는지 확인

3. **"Function invocation failed" 오류**:
   - API 라우트 핸들러에 비동기 오류 처리 추가
   - 10초 제한 시간 내에 완료되지 않는 작업이 있는지 확인
   - 복잡한 쿼리 최적화 또는 분할 처리 구현

4. **"CORS 오류"**:
   - Next.js API 라우트에 적절한 CORS 헤더 설정 확인
   - 프론트엔드 요청 URL과 백엔드 URL이 일치하는지 확인

### 성능 최적화 팁

1. **콜드 스타트 지연 최소화**:
   - 자주 사용하는 API 경로에 `_middleware.ts` 파일 추가
   - Edge Functions 활용 (가능한 경우)
   - 번들 크기 최적화로 초기화 시간 단축

2. **데이터베이스 최적화**:
   - Supabase 쿼리에 적절한 인덱스 추가
   - 과도한 JOIN 연산 피하기
   - 대량의 데이터는 페이지네이션 적용

3. **캐싱 전략 개선**:
   - 자주 변경되지 않는 데이터는 TTL 증가
   - SWR 또는 React Query 활용한 클라이언트 캐싱
   - Vercel Edge Cache 활용

## 배포 모범 사례

1. **환경 변수 관리**:
   - 로컬 개발을 위해 `.env.local` 파일 사용 (절대 GitHub에 커밋하지 않음)
   - 비밀은 절대 코드나 공개 저장소에 포함하지 않음
   - Vercel 팀 설정을 통해 팀원들과 안전하게 환경 변수 공유

2. **배포 전 테스트**:
   - PR 생성 시 자동으로 생성되는 미리보기 URL로 변경사항 철저히 테스트
   - 자동화된 테스트 작성 및 실행
   - 테스트 후 문제가 없을 때만 메인 브랜치에 병합

3. **안전한 롤아웃 전략**:
   - 중요한 변경사항은 점진적으로 출시 (Vercel의 단계적 롤아웃 기능 활용)
   - 롤백 계획 미리 준비
   - 모니터링 및 알림 설정으로 문제 조기 발견

4. **정기적인 백업**:
   - Supabase 데이터베이스 정기 백업 설정
   - 중요 데이터는 외부 저장소에 추가 백업 고려
   - 장애 복구 계획 문서화