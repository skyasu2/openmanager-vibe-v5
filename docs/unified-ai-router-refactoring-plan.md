# UnifiedAIEngineRouter λ¦¬ν©ν† λ§ κ³„ν

## π“… μ‘μ„±μΌ: 2025-01-30

## π― λ©ν‘
1,027μ¤„μ God ClassμΈ UnifiedAIEngineRouterλ¥Ό λ‹¨μΌ μ±…μ„ μ›μΉ™(SRP)μ— λ”°λΌ λ¶„λ¦¬

## π“ ν„μ¬ μƒνƒ λ¶„μ„

### νμΌ μ •λ³΄
- **μ„μΉ**: `/src/services/ai/UnifiedAIEngineRouter.ts`
- **ν¬κΈ°**: 1,027μ¤„
- **λ©”μ„λ“ μ**: 31κ° (public: 7κ°, private: 24κ°)

### μ‹λ³„λ μ±…μ„λ“¤
1. **λΌμ°ν… ν•µμ‹¬ λ΅μ§** (λ©”μΈ μ±…μ„)
   - `route()` - λ©”μΈ λΌμ°ν… λ©”μ„λ“
   - `selectEngine()` - μ—”μ§„ μ„ νƒ λ΅μ§
   - `executeEngine()` - μ—”μ§„ μ‹¤ν–‰

2. **λ³΄μ• μ²λ¦¬** (λ³„λ„ μ„λΉ„μ¤λ΅ λ¶„λ¦¬ ν•„μ”)
   - `applySecurity()` - λ³΄μ• μ μ©
   - `createSecurityBlockedResponse()` - λ³΄μ• μ°¨λ‹¨ μ‘λ‹µ
   - PromptSanitizer, AIResponseFilter μ‚¬μ©

3. **ν† ν° κ΄€λ¦¬** (λ³„λ„ λ§¤λ‹μ €λ΅ λ¶„λ¦¬)
   - `checkTokenLimits()` - ν† ν° μ ν• ν™•μΈ
   - `recordTokenUsage()` - ν† ν° μ‚¬μ©λ‰ κΈ°λ΅
   - `resetDailyLimits()` - μΌμΌ μ ν• λ¦¬μ…‹
   - `createTokenLimitResponse()` - ν† ν° μ ν• μ‘λ‹µ

4. **Circuit Breaker** (λ³„λ„ ν¨ν„΄ κµ¬ν„)
   - `isCircuitOpen()` - νλ΅ μƒνƒ ν™•μΈ
   - `recordFailure()` - μ‹¤ν¨ κΈ°λ΅
   - `resetCircuitBreakers()` - νλ΅ λ¦¬μ…‹
   - `createCircuitOpenResponse()` - νλ΅ μ°¨λ‹¨ μ‘λ‹µ

5. **μΊμ‹± λ΅μ§** (λ³„λ„ μΊμ‹ λ§¤λ‹μ €)
   - `generateCacheKey()` - μΊμ‹ ν‚¤ μƒμ„±
   - `getCachedResponse()` - μΊμ‹ μ΅°ν
   - `setCachedResponse()` - μΊμ‹ μ €μ¥
   - `clearCache()` - μΊμ‹ μ΄κΈ°ν™”

6. **ν•κµ­μ–΄ NLP μ²λ¦¬** (λ³„λ„ ν”„λ΅μ„Έμ„)
   - `executeKoreanNLP()` - ν•κµ­μ–΄ NLP μ‹¤ν–‰
   - `convertKoreanNLPResponse()` - μ‘λ‹µ λ³€ν™
   - `calculateKoreanRatio()` - ν•κµ­μ–΄ λΉ„μ¨ κ³„μ‚°

7. **λ©”νΈλ¦­ μμ§‘** (λ³„λ„ μ»¬λ ‰ν„°)
   - `updateMetrics()` - λ©”νΈλ¦­ μ—…λ°μ΄νΈ
   - `getMetrics()` - λ©”νΈλ¦­ μ΅°ν

8. **μ—λ¬ μ²λ¦¬ λ° ν΄λ°±** (λ³„λ„ ν•Έλ“¤λ¬)
   - `retryWithDifferentEngine()` - λ‹¤λ¥Έ μ—”μ§„μΌλ΅ μ¬μ‹λ„
   - `retryWithFallback()` - ν΄λ°± μ¬μ‹λ„
   - `getFallbackEngine()` - ν΄λ°± μ—”μ§„ μ„ νƒ
   - `createErrorResponse()` - μ—λ¬ μ‘λ‹µ μƒμ„±

## π—οΈ μ μ•ν•λ” κµ¬μ΅°

```
src/services/ai/
β”β”€β”€ UnifiedAIEngineRouter.ts (ν•µμ‹¬ λΌμ°ν…λ§ - 200μ¤„)
β”β”€β”€ routing/
β”‚   β”β”€β”€ AISecurityService.ts (λ³΄μ• μ²λ¦¬ - 150μ¤„)
β”‚   β”β”€β”€ TokenUsageManager.ts (ν† ν° κ΄€λ¦¬ - 120μ¤„)
β”‚   β”β”€β”€ CircuitBreakerService.ts (νλ΅ μ°¨λ‹¨κΈ° - 150μ¤„)
β”‚   β”β”€β”€ AICacheManager.ts (μΊμ‹± - 100μ¤„)
β”‚   β”β”€β”€ KoreanNLPProcessor.ts (ν•κµ­μ–΄ μ²λ¦¬ - 100μ¤„)
β”‚   β”β”€β”€ AIMetricsCollector.ts (λ©”νΈλ¦­ μμ§‘ - 80μ¤„)
β”‚   β””β”€β”€ AIErrorHandler.ts (μ—λ¬ μ²λ¦¬ - 120μ¤„)
β””β”€β”€ index.ts (ν†µν•© export)
```

## π€ λ¦¬ν©ν† λ§ λ‹¨κ³„

### Phase 1: μΈν„°νμ΄μ¤ μ •μ (30λ¶„)
1. κ° μ„λΉ„μ¤μ μΈν„°νμ΄μ¤ μ •μ
2. μμ΅΄μ„± μ£Όμ…μ„ μ„ν• νƒ€μ… μ •μ
3. κ³µν†µ νƒ€μ… μ¶”μ¶

### Phase 2: μ„λΉ„μ¤ λ¶„λ¦¬ (κ° 20-30λ¶„)
1. **AISecurityService** μƒμ„±
   - `applySecurity()` λ©”μ„λ“ μ΄λ™
   - PromptSanitizer, AIResponseFilter ν†µν•©
   - λ³΄μ• κ΄€λ ¨ μ‘λ‹µ μƒμ„± λ΅μ§

2. **TokenUsageManager** μƒμ„±
   - ν† ν° μ‚¬μ©λ‰ μ¶”μ  λ΅μ§
   - μΌμΌ/μ‚¬μ©μλ³„ μ ν• κ΄€λ¦¬
   - ν† ν° κ΄€λ ¨ μ‘λ‹µ μƒμ„±

3. **CircuitBreakerService** μƒμ„±
   - μ—”μ§„λ³„ νλ΅ μƒνƒ κ΄€λ¦¬
   - μ‹¤ν¨ μ„κ³„κ°’ λ° μ¬μ‹λ„ λ΅μ§
   - νλ΅ μ°¨λ‹¨ μ‘λ‹µ μƒμ„±

4. **AICacheManager** μƒμ„±
   - μΊμ‹ ν‚¤ μƒμ„± λ° κ΄€λ¦¬
   - TTL κΈ°λ° μΊμ‹ λ§λ£
   - μΊμ‹ ν¬κΈ° μ ν• κ΄€λ¦¬

5. **KoreanNLPProcessor** μƒμ„±
   - ν•κµ­μ–΄ κ°μ§€ λ΅μ§
   - NLP API νΈμ¶ λ° μ‘λ‹µ λ³€ν™
   - ν•κµ­μ–΄ νΉν™” μ²λ¦¬

6. **AIMetricsCollector** μƒμ„±
   - μ”μ²­/μ‘λ‹µ λ©”νΈλ¦­ μμ§‘
   - μ—”μ§„λ³„ μ‚¬μ©λ‰ μ¶”μ 
   - ν†µκ³„ λ°μ΄ν„° μ κ³µ

7. **AIErrorHandler** μƒμ„±
   - μ—λ¬ νƒ€μ…λ³„ μ²λ¦¬ λ΅μ§
   - ν΄λ°± μ „λµ κ΄€λ¦¬
   - μ—λ¬ μ‘λ‹µ μƒμ„±

### Phase 3: ν†µν•© λ° ν…μ¤νΈ (1μ‹κ°„)
1. UnifiedAIEngineRouter λ¦¬ν©ν† λ§
   - λ¶„λ¦¬λ μ„λΉ„μ¤ μ£Όμ…
   - ν•µμ‹¬ λΌμ°ν… λ΅μ§λ§ μ μ§€
   - μ½”λ””λ„¤μ΄ν„° μ—­ν• λ΅ μ¶•μ†

2. μμ΅΄μ„± μ£Όμ… μ„¤μ •
   - μ„λΉ„μ¤ κ°„ μμ΅΄μ„± κ΄€λ¦¬
   - ν…μ¤νΈ κ°€λ¥ν• κµ¬μ΅° ν™•λ³΄

3. κΈ°μ΅΄ API νΈν™μ„± μ μ§€
   - κ³µκ° μΈν„°νμ΄μ¤ λ³€κ²½ μ—†μ
   - μ μ§„μ  λ§μ΄κ·Έλ μ΄μ… μ§€μ›

## β… μμƒ ν¨κ³Ό

1. **μ½”λ“ ν’μ§ ν–¥μƒ**
   - λ‹¨μΌ μ±…μ„ μ›μΉ™ μ¤€μ
   - κ° ν΄λμ¤ 200μ¤„ μ΄ν•λ΅ κ΄€λ¦¬
   - λ…ν™•ν• μ—­ν•  λ¶„λ¦¬

2. **μ μ§€λ³΄μμ„± κ°μ„ **
   - κ° κΈ°λ¥λ³„ λ…λ¦½μ  μμ • κ°€λ¥
   - ν…μ¤νΈ μ©μ΄μ„± μ¦κ°€
   - μ¬μ‚¬μ©μ„± ν–¥μƒ

3. **ν™•μ¥μ„± ν™•λ³΄**
   - μƒλ΅μ΄ μ—”μ§„ μ¶”κ°€ μ©μ΄
   - κΈ°λ¥λ³„ κ°μ„  κ°€λ¥
   - ν”λ¬κ·ΈμΈ μ•„ν‚¤ν…μ² μ§€μ›

## β οΈ μ£Όμμ‚¬ν•­

1. **API νΈν™μ„±**: κΈ°μ΅΄ κ³µκ° λ©”μ„λ“ μ‹κ·Έλ‹μ² μ μ§€
2. **μ„±λ¥**: κ³Όλ„ν• μ¶”μƒν™”λ΅ μΈν• μ„±λ¥ μ €ν• λ°©μ§€
3. **μν™ μ°Έμ΅°**: μ„λΉ„μ¤ κ°„ μμ΅΄μ„± μ£Όμ
4. **μ μ§„μ  μ μ©**: ν• λ²μ— λ¨λ“  λ³€κ²½ λ€μ‹  λ‹¨κ³„λ³„ μ μ©

## π“‹ μ²΄ν¬λ¦¬μ¤νΈ

- [ ] μΈν„°νμ΄μ¤ μ •μ μ™„λ£
- [ ] AISecurityService λ¶„λ¦¬
- [ ] TokenUsageManager λ¶„λ¦¬
- [ ] CircuitBreakerService λ¶„λ¦¬
- [ ] AICacheManager λ¶„λ¦¬
- [ ] KoreanNLPProcessor λ¶„λ¦¬
- [ ] AIMetricsCollector λ¶„λ¦¬
- [ ] AIErrorHandler λ¶„λ¦¬
- [ ] UnifiedAIEngineRouter λ¦¬ν©ν† λ§
- [ ] ν†µν•© ν…μ¤νΈ μ‘μ„±
- [ ] λ¬Έμ„ μ—…λ°μ΄νΈ