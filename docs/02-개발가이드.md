# 🛠️ OpenManager AI - 개발 가이드

## 🎯 개발 환경 개요

OpenManager AI는 NPU와 MCP 엔진 기반의 차세대 서버 모니터링 시스템으로, 통합 시스템 제어와 절전 기능을 핵심으로 합니다.

### 🏗️ 기술 스택
- **Frontend**: Next.js 15, React 19, TypeScript, Tailwind CSS
- **Backend**: Node.js, Next.js API Routes
- **Database**: Supabase (PostgreSQL) + Redis
- **AI Engine**: NPU 시뮬레이션, MCP 프로토콜
- **Deployment**: Vercel, Docker

## 🚀 개발 환경 설정

### 1. 필수 요구사항
```bash
Node.js >= 18.0.0
npm >= 9.0.0
Git
```

### 2. 프로젝트 클론 및 설치
```bash
git clone https://github.com/skyasu2/openmanager-vibe-v5.git
cd openmanager-vibe-v5
npm install
```

### 3. 환경 변수 설정
```bash
cp .env.example .env.local
```

#### 기본 환경 변수
```env
# 개발 모드
NODE_ENV=development

# Supabase 설정 (선택사항)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# Redis 설정 (선택사항)
REDIS_URL=redis://localhost:6379

# 프로덕션 모드 (실제 서버 모니터링)
DEPLOY_MODE=production
PRIMARY_SOURCE=ssh  # ssh, snmp, agent, api
```

### 4. 개발 서버 실행
```bash
npm run dev
# http://localhost:3000 접속
```

## 🏗️ 프로젝트 구조

```
src/
├── app/                    # Next.js App Router
│   ├── api/               # API 라우트
│   │   ├── power/         # 시스템 제어 API
│   │   ├── data-generator/ # 데이터 생성기 API
│   │   ├── realtime-data/ # 실시간 데이터 API
│   │   └── servers/       # 서버 관리 API
│   ├── dashboard/         # 대시보드 페이지
│   ├── demo/             # 데모 페이지
│   └── page.tsx          # 랜딩 페이지
├── components/            # React 컴포넌트
│   ├── ai/               # AI 관련 컴포넌트
│   ├── dashboard/        # 대시보드 컴포넌트
│   └── ui/               # 공통 UI 컴포넌트
├── modules/              # 모듈화된 기능
│   ├── ai-agent/         # AI 에이전트 모듈
│   ├── ai-sidebar/       # AI 사이드바 모듈
│   ├── mcp/              # MCP 프로토콜 모듈
│   └── shared/           # 공유 모듈
├── services/             # 비즈니스 로직
│   ├── collectors/       # 데이터 수집기
│   ├── storage.ts        # 저장소 서비스
│   └── aiAgent.ts        # AI 에이전트 서비스
├── stores/               # 상태 관리
│   ├── systemStore.ts    # 시스템 상태
│   └── demoStore.ts      # 데모 상태
└── types/                # TypeScript 타입 정의
```

## ⚡ 통합 시스템 제어 개발

### SystemStore 구조
```typescript
interface SystemStore {
  state: 'stopped' | 'ai-monitoring' | 'active';
  timer: number;
  sessionInfo: SessionInfo;
  
  startSystem: (duration: number) => void;
  stopSystem: () => void;
  getFormattedTime: () => string;
}
```

### 시스템 활성화 플로우
```typescript
// 1. 시스템 활성화
const handleActivateSystem = async () => {
  // 시스템 상태 변경
  startSystem(20 * 60); // 20분
  
  // 데이터 생성기 자동 시작
  await fetch('/api/data-generator', {
    method: 'POST',
    body: JSON.stringify({ action: 'start-realtime' })
  });
  
  // AI 에이전트 활성화
  smartAIAgent.generateAutoReport();
  
  // 대시보드 권한 부여
  localStorage.setItem('dashboard_auth_token', authToken);
};
```

## 🔧 빌드 시스템 최적화

### Redis 서버 사이드 처리
```typescript
// 서버 사이드에서만 Redis 클라이언트 초기화
async function getRedisClient() {
  if (typeof window !== 'undefined') {
    return null; // 클라이언트에서는 Redis 사용 안 함
  }
  
  if (!redis) {
    const { Redis } = await import('ioredis'); // 동적 import
    redis = new Redis(REDIS_URL);
  }
  
  return redis;
}
```

### API 기반 데이터 접근
```typescript
// 클라이언트에서는 API 호출로 데이터 가져오기
const getServersFromAPI = async (): Promise<Server[]> => {
  if (typeof window !== 'undefined') {
    const response = await fetch('/api/servers');
    return response.json();
  }
  return [];
};
```

## 🎭 데이터 생성기 개발

### ServerDataGenerator 구조
```typescript
export class ServerDataGenerator {
  private isGenerating: boolean = false;
  private realtimeTimer?: NodeJS.Timeout;
  private readonly REALTIME_DURATION = 10 * 60 * 1000; // 10분
  private readonly REALTIME_INTERVAL = 5 * 1000; // 5초
  
  async startRealtimeGeneration(): Promise<void> {
    // 10분간 5초 간격 데이터 생성
  }
  
  stopRealtimeGeneration(): void {
    // 데이터 생성 중지
  }
}
```

### 데이터 패턴 정의
```typescript
const DATA_PATTERNS: DataPattern[] = [
  {
    id: 'normal',
    name: '정상 운영',
    characteristics: {
      cpuBase: 35,
      memoryBase: 60,
      volatility: 'low',
      hasSpikes: false
    }
  },
  {
    id: 'high-load',
    name: '고부하',
    characteristics: {
      cpuBase: 70,
      memoryBase: 85,
      volatility: 'high',
      hasSpikes: true
    }
  }
];
```

## 🤖 AI 에이전트 모듈 개발

### 모듈 구조
```
modules/ai-agent/
├── core/
│   ├── AIAgentEngine.ts      # 메인 엔진
│   ├── IntentClassifier.ts   # 의도 분류기
│   └── ModeManager.ts        # 모드 관리
├── processors/
│   ├── ResponseGenerator.ts  # 응답 생성
│   ├── ActionExecutor.ts     # 액션 실행
│   └── ContextManager.ts     # 컨텍스트 관리
└── interfaces/
    └── types.ts              # 타입 정의
```

### NPU 시뮬레이션 엔진
```typescript
class NPUSimulator {
  async processPattern(input: string): Promise<PatternResult> {
    // NPU 기반 패턴 매칭 시뮬레이션
    const patterns = this.loadPatterns();
    const scores = patterns.map(p => this.calculateSimilarity(input, p));
    return this.selectBestMatch(scores);
  }
}
```

## 🔋 절전 시스템 개발

### 3단계 절전 모드
```typescript
type SystemState = 'stopped' | 'ai-monitoring' | 'active';

const POWER_MODES = {
  stopped: {
    dataCollection: false,
    aiAgent: false,
    interval: 0
  },
  'ai-monitoring': {
    dataCollection: true,
    aiAgent: true,
    interval: 5 * 60 * 1000 // 5분
  },
  active: {
    dataCollection: true,
    aiAgent: true,
    interval: 30 * 1000 // 30초
  }
};
```

### AI 자동 감지 로직
```typescript
const detectAnomalies = (metrics: ServerMetrics): boolean => {
  const thresholds = {
    cpuChange: 20,
    memoryChange: 15,
    diskChange: 10,
    cpuCritical: 90,
    memoryCritical: 95
  };
  
  return (
    metrics.cpu.change > thresholds.cpuChange ||
    metrics.memory.change > thresholds.memoryChange ||
    metrics.cpu.usage > thresholds.cpuCritical ||
    metrics.memory.usage > thresholds.memoryCritical
  );
};
```

## 📊 데이터베이스 개발

### Supabase 스키마
```sql
-- 서버 메트릭 테이블
CREATE TABLE server_metrics (
  id BIGSERIAL PRIMARY KEY,
  server_id VARCHAR(50) NOT NULL,
  hostname VARCHAR(100) NOT NULL,
  timestamp TIMESTAMPTZ NOT NULL,
  cpu_usage DECIMAL(5,2),
  memory_usage DECIMAL(5,2),
  disk_usage DECIMAL(5,2),
  network_bytes_received BIGINT,
  network_bytes_sent BIGINT,
  raw_data JSONB
);

-- 인덱스 생성
CREATE INDEX idx_server_metrics_server_id ON server_metrics(server_id);
CREATE INDEX idx_server_metrics_timestamp ON server_metrics(timestamp);
```

### 이중화 저장 전략
```typescript
class MetricsStorageService {
  async saveMetrics(metrics: ServerMetrics): Promise<void> {
    // 1. Supabase에 영구 저장
    await this.saveToSupabase(metrics);
    
    // 2. Redis에 캐시 저장 (서버 사이드에서만)
    const redisClient = await getRedisClient();
    if (redisClient) {
      await this.saveToRedis(metrics, redisClient);
    }
  }
}
```

## 🧪 테스트 및 디버깅

### 개발 도구
```bash
# 타입 체크
npm run type-check

# 린트 검사
npm run lint

# 빌드 테스트
npm run build

# 프로덕션 미리보기
npm run start
```

### 디버깅 팁
1. **시스템 상태 확인**: 브라우저 개발자 도구에서 SystemStore 상태 모니터링
2. **API 응답 확인**: Network 탭에서 API 호출 상태 확인
3. **Redis 연결 확인**: 서버 로그에서 Redis 연결 상태 확인
4. **데이터 생성기 상태**: 콘솔에서 생성기 로그 확인

### 환경별 테스트
```bash
# 개발 환경 (시뮬레이션 모드)
NODE_ENV=development npm run dev

# 프로덕션 환경 (실제 서버 연동)
NODE_ENV=production DEPLOY_MODE=production npm run build
```

## 🚀 배포 준비

### Vercel 배포 설정
```json
// vercel.json
{
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "framework": "nextjs",
  "functions": {
    "app/api/**/*.ts": {
      "maxDuration": 30
    }
  }
}
```

### 환경 변수 설정
```bash
# Vercel 환경 변수
vercel env add NODE_ENV production
vercel env add DEPLOY_MODE production
vercel env add DATABASE_URL [your-database-url]
vercel env add REDIS_URL [your-redis-url]
```

## 🔧 문제 해결

### 일반적인 문제들

#### 1. Redis 연결 오류
```bash
# 해결: Redis를 서버 사이드에서만 사용하도록 수정됨
# 클라이언트에서는 자동으로 Supabase fallback 사용
```

#### 2. 빌드 오류
```bash
# Node.js 모듈 클라이언트 import 오류
# 해결: 동적 import와 환경 감지 사용
```

#### 3. 타입 오류
```bash
# TypeScript 타입 불일치
npm run type-check
# 타입 정의 파일 확인 및 수정
```

## 📚 추가 리소스

- [Next.js 15 문서](https://nextjs.org/docs)
- [TypeScript 핸드북](https://www.typescriptlang.org/docs/)
- [Tailwind CSS 가이드](https://tailwindcss.com/docs)
- [Supabase 문서](https://supabase.com/docs)
- [Redis 가이드](https://redis.io/docs/)

---

**Copyright(c) 저작자. All rights reserved.** 