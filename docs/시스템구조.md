# OpenManager Vibe V5 시스템 구조

## 1. 아키텍처 개요

OpenManager Vibe V5는 모던 웹 기술을 활용한 서버 모니터링 및 관리 시스템입니다. 다음과 같은 주요 기술 스택으로 구성되어 있습니다:

- **프론트엔드**: Next.js 14 (App Router), React, TypeScript, Tailwind CSS
- **백엔드**: Next.js API Routes, Serverless Functions
- **데이터베이스**: Supabase (PostgreSQL)
- **캐싱**: Upstash Redis
- **인증**: Supabase Auth
- **배포**: Vercel

### 시스템 구성도

```
┌─────────────────────────────────────────┐
│                                         │
│             클라이언트 브라우저           │
│                                         │
└───────────────────┬─────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────┐
│                                         │
│             Vercel (Next.js)            │
│                                         │
│  ┌─────────────┐      ┌──────────────┐  │
│  │             │      │              │  │
│  │  Frontend   │◄────►│  API Routes  │  │
│  │  (Pages)    │      │              │  │
│  │             │      │              │  │
│  └─────────────┘      └──────┬───────┘  │
│                              │          │
└──────────────────────────────┼──────────┘
                               │
                               ▼
┌──────────────────┐  ┌─────────────────┐
│                  │  │                 │
│  Upstash Redis   │◄─┼─►   Supabase    │
│  (캐싱/실시간)    │  │  (데이터/인증)  │
│                  │  │                 │
└──────────────────┘  └─────────────────┘
          ▲                    ▲
          │                    │
          │                    │
┌─────────┼────────────────────┼─────────┐
│         │                    │         │
│  ┌──────┴──────┐    ┌────────┴─────┐   │
│  │             │    │              │   │
│  │  서버 A     │    │   서버 B     │   │
│  │ (모니터링)  │    │  (모니터링)  │   │
│  │             │    │              │   │
│  └─────────────┘    └──────────────┘   │
│                                        │
│           모니터링 대상 서버            │
│                                        │
└────────────────────────────────────────┘
```

## 2. 주요 모듈 구조

### 2.1 코어 모듈

```
src/
├── modules/
│   ├── mcp/
│   │   └── core/          # MCP(Management Control Protocol) 코어 모듈
│   └── storage/
│       └── hybrid/        # 하이브리드 스토리지 모듈 (Redis + Supabase)
```

### 2.2 API 엔드포인트

```
src/
└── app/
    └── api/
        ├── health/        # 헬스체크 API
        ├── mcp/
        │   └── query/     # MCP 쿼리 API
        ├── monitoring/
        │   ├── logs/      # 로그 모니터링 API
        │   ├── performance/ # 성능 모니터링 API
        │   ├── redis-stats/ # Redis 통계 API
        │   ├── servers/   # 서버 모니터링 API
        │   └── supabase-stats/ # Supabase 통계 API
        ├── servers/       # 서버 관리 API
        └── stats/         # 통계 API
```

### 2.3 프론트엔드 페이지

```
src/
└── app/
    ├── chat/             # 채팅 인터페이스
    ├── dashboard/        # 메인 대시보드
    └── monitoring/       # 모니터링 페이지
```

### 2.4 컴포넌트

```
src/
└── components/
    ├── monitoring/       # 모니터링 관련 컴포넌트
    └── ui/               # 공통 UI 컴포넌트
```

### 2.5 유틸리티 및 라이브러리

```
src/
├── config/              # 시스템 설정
├── data/                # 정적 데이터
├── hooks/               # 커스텀 훅
├── lib/                 # 유틸리티 함수
│   └── monitoring/      # 모니터링 관련 유틸리티
└── types/               # TypeScript 타입 정의
```

## 3. 데이터 흐름

### 3.1 모니터링 데이터 흐름

```
┌────────────┐     ┌───────────┐     ┌────────────┐     ┌───────────┐
│            │     │           │     │            │     │           │
│  서버 에이전트 ├────►  API 서버  ├────►  Redis 캐시 ├────►  클라이언트 │
│            │     │           │     │            │     │           │
└────────────┘     └─────┬─────┘     └────────────┘     └───────────┘
                         │
                         ▼
                   ┌───────────┐
                   │           │
                   │  Supabase │
                   │           │
                   └───────────┘
```

1. 서버 에이전트가 주기적으로 모니터링 데이터 수집
2. API 서버로 데이터 전송
3. 실시간 데이터는 Redis에 캐싱
4. 장기 데이터는 Supabase에 저장
5. 클라이언트는 API를 통해 데이터 요청
6. 실시간 데이터는 Redis에서, 히스토리 데이터는 Supabase에서 제공

### 3.2 인증 흐름

```
┌───────────┐     ┌───────────┐     ┌───────────┐
│           │     │           │     │           │
│ 클라이언트 ├────►│  Supabase ├────►│  JWT 토큰 │
│           │     │    Auth   │     │           │
└───────────┘     └───────────┘     └─────┬─────┘
                                          │
                                          ▼
                                    ┌───────────┐
                                    │           │
                                    │  API 접근 │
                                    │           │
                                    └───────────┘
```

1. 사용자가 로그인 정보 입력
2. Supabase Auth로 인증 요청
3. 성공 시 JWT 토큰 발급
4. 토큰을 사용하여 보호된 API 접근

## 4. 데이터베이스 구조

### 4.1 Supabase 테이블

#### servers 테이블
```sql
CREATE TABLE servers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR NOT NULL,
  hostname VARCHAR NOT NULL,
  description TEXT,
  status VARCHAR NOT NULL DEFAULT 'unknown',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_check TIMESTAMP WITH TIME ZONE,
  owner_id UUID REFERENCES auth.users(id)
);
```

#### server_stats 테이블
```sql
CREATE TABLE server_stats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  server_id UUID REFERENCES servers(id) ON DELETE CASCADE,
  cpu_usage FLOAT,
  memory_usage FLOAT,
  disk_usage FLOAT,
  network_rx FLOAT,
  network_tx FLOAT,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### alerts 테이블
```sql
CREATE TABLE alerts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  server_id UUID REFERENCES servers(id) ON DELETE CASCADE,
  type VARCHAR NOT NULL,
  title VARCHAR NOT NULL,
  message TEXT NOT NULL,
  read BOOLEAN DEFAULT FALSE,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 4.2 Redis 데이터 구조

#### 실시간 서버 상태
```
server:{server_id}:status -> JSON 문자열
```

#### 실시간 성능 메트릭
```
server:{server_id}:metrics:cpu -> 최근 CPU 사용량 목록 (Sorted Set)
server:{server_id}:metrics:memory -> 최근 메모리 사용량 목록 (Sorted Set)
server:{server_id}:metrics:disk -> 최근 디스크 사용량 목록 (Sorted Set)
```

#### 활성 알림
```
alerts:active -> 활성 알림 목록 (List)
```

## 5. 주요 기능 구현

### 5.1 실시간 모니터링

실시간 모니터링은 다음 기술을 조합하여 구현:

1. **서버 데이터 수집**: 
   - 서버 에이전트가 주기적으로 시스템 메트릭 수집
   - API 엔드포인트로 데이터 전송

2. **데이터 처리**:
   - API 라우트에서 데이터 수신
   - Redis에 최신 데이터 캐싱
   - Supabase에 장기 보관용 데이터 저장

3. **클라이언트 표시**:
   - SWR을 사용한 데이터 폴링
   - Recharts 라이브러리로 시각화
   - 임계값 초과 시 알림 생성

### 5.2 알림 시스템

알림 시스템은 다음과 같이 구현:

1. **알림 생성**:
   - 임계값 초과 감지 시 알림 생성
   - 우선순위에 따른 알림 분류

2. **알림 전달**:
   - Redis PubSub을 통한 실시간 알림
   - 이메일 알림 (심각한 경우)

3. **알림 관리**:
   - 알림 확인 및 해제
   - 알림 필터링 및 검색

### 5.3 서버 관리

서버 관리 기능은 다음과 같이 구현:

1. **서버 등록**:
   - 서버 정보 입력 및 저장
   - 연결 테스트 및 초기 상태 확인

2. **서버 제어**:
   - 원격 명령 실행
   - 서비스 시작/중지/재시작

3. **설정 관리**:
   - 서버별 모니터링 설정
   - 알림 임계값 설정

## 6. 확장성 및 성능 최적화

### 6.1 확장성 전략

1. **수평적 확장**:
   - 서버리스 아키텍처로 자동 스케일링
   - 지역별 엣지 함수 배포

2. **데이터 샤딩**:
   - 서버 ID 기반 데이터 샤딩
   - 시간 기반 데이터 파티셔닝

### 6.2 성능 최적화

1. **캐싱 전략**:
   - 다층 캐싱 (브라우저, CDN, Redis)
   - 캐시 무효화 전략

2. **데이터 압축**:
   - 시계열 데이터 압축 알고리즘
   - 전송 데이터 최소화

3. **클라이언트 최적화**:
   - 코드 분할 및 지연 로딩
   - 메모이제이션 및 가상화

## 7. 보안

### 7.1 인증 및 권한

1. **사용자 인증**:
   - Supabase Auth 기반 인증
   - 다중 인증(MFA) 지원

2. **권한 관리**:
   - 역할 기반 접근 제어(RBAC)
   - 서버별 접근 권한

### 7.2 데이터 보안

1. **전송 보안**:
   - 모든 통신에 HTTPS 사용
   - API 키 및 토큰 암호화

2. **저장 보안**:
   - 민감 데이터 암호화
   - 정기적인 백업 및 복구 테스트

## 8. 배포 및 운영

### 8.1 배포 파이프라인

1. **CI/CD**:
   - GitHub Actions를 통한 자동화
   - 테스트, 빌드, 배포 자동화

2. **환경 관리**:
   - 개발, 스테이징, 프로덕션 환경 분리
   - 환경별 설정 관리

### 8.2 모니터링 및 로깅

1. **시스템 모니터링**:
   - 애플리케이션 성능 모니터링
   - 인프라 모니터링

2. **로깅**:
   - 중앙 집중식 로깅
   - 로그 분석 및 알림

---

이 문서는 OpenManager Vibe V5의 시스템 구조에 대한 개요입니다. 더 자세한 정보는 개발 문서를 참조하거나 개발팀에 문의하세요.