# 💻 OpenManager Vibe v5.44.2 코드 참고

> **버전**: v5.44.2  
> **업데이트**: 2025년 6월 21일  
> **상태**: 완전 완성, 목업 시스템 통합, 프로덕션 준비 완료

---

## 🎯 핵심 코드 샘플

### **1. UnifiedAIEngine (메인 AI 허브)**

```typescript
// src/core/ai/UnifiedAIEngine.ts
export class UnifiedAIEngine {
  private googleAI?: GoogleAIService;
  private ragEngine: LocalRAGEngine;
  private mcpClient: RealMCPClient | null = null;
  private localEngine: LocalAIEngine;

  async processQuery(
    request: UnifiedAnalysisRequest
  ): Promise<UnifiedAnalysisResponse> {
    // 병렬 처리로 성능 최적화
    const [localResult, ragResult, mcpResult, googleResult] =
      await Promise.allSettled([
        this.localEngine.processQuery(request.query),
        this.ragEngine.searchAndAnswer(request.query),
        this.mcpClient?.analyze(request) || Promise.resolve(null),
        this.googleAI?.processQuery(request) || Promise.resolve(null),
      ]);

    // 결과 융합 및 신뢰도 계산
    return this.fuseResults({
      local: this.extractResult(localResult),
      rag: this.extractResult(ragResult),
      mcp: this.extractResult(mcpResult),
      google: this.extractResult(googleResult),
    });
  }

  private fuseResults(results: MultiAIResults): UnifiedAnalysisResponse {
    const validResults = Object.values(results).filter(
      r => r?.success && r.confidence > 0.5
    );

    if (validResults.length === 0) {
      return this.generateFallbackResponse();
    }

    // 가중 평균으로 최종 응답 생성
    const weightedContent = this.calculateWeightedResponse(validResults);
    const averageConfidence =
      validResults.reduce((sum, r) => sum + r.confidence, 0) /
      validResults.length;

    return {
      success: true,
      content: weightedContent,
      confidence: averageConfidence,
      sources: validResults.map(r => r.source),
      processingTime: Math.max(...validResults.map(r => r.processingTime)),
      isMockMode: validResults.some(r => r.isMockMode),
    };
  }
}
```

### **2. 목업 시스템 (자동 감지)**

```typescript
// src/services/ai/MockSystemManager.ts
export class MockSystemManager {
  detectMockMode(): boolean {
    return (
      this.isHealthCheckContext() ||
      this.isTestContext() ||
      this.isEnvironmentMissing() ||
      process.env.FORCE_MOCK_MODE === 'true'
    );
  }

  private isHealthCheckContext(): boolean {
    if (typeof window === 'undefined') {
      // 서버 사이드 렌더링 환경
      return true;
    }

    const userAgent = navigator.userAgent;
    const referer = document.referrer;

    return (
      userAgent?.includes('health-check') ||
      referer?.includes('/health') ||
      window.location.pathname.includes('/health')
    );
  }

  async processWithMockFallback<T>(
    realOperation: () => Promise<T>,
    mockOperation: () => T | Promise<T>
  ): Promise<T> {
    if (this.detectMockMode()) {
      return await mockOperation();
    }

    try {
      return await realOperation();
    } catch (error) {
      console.warn('Real operation failed, switching to mock:', error);
      return await mockOperation();
    }
  }
}
```

### **3. Google AI 서비스 (할당량 보호)**

```typescript
// src/services/ai/GoogleAIService.ts
export class GoogleAIService {
  private circuitBreaker: GoogleAICircuitBreaker;
  private quotaManager: GoogleAIQuotaManager;
  private mockManager: GoogleAIMockManager;

  async generateContent(
    request: GenerateContentRequest
  ): Promise<GoogleAIResponse> {
    // 목업 모드 확인
    if (this.mockManager.detectMockMode()) {
      return this.mockManager.generateMockResponse(request);
    }

    // Circuit Breaker 패턴 적용
    return await this.circuitBreaker.executeWithCircuitBreaker(async () => {
      // 할당량 확인
      await this.quotaManager.checkQuotaLimits();

      // 실제 Google AI 호출
      const response = await this.client.generateContent({
        contents: [{ parts: [{ text: request.prompt }] }],
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 1024,
        },
      });

      // 사용량 추적
      await this.quotaManager.trackUsage('generateContent');

      return this.parseResponse(response);
    });
  }

  private parseResponse(response: any): GoogleAIResponse {
    const content = response.candidates?.[0]?.content?.parts?.[0]?.text || '';

    return {
      success: true,
      content: content,
      confidence: 0.9,
      processingTime: Date.now() - this.startTime,
      isMockMode: false,
      source: 'google-ai',
    };
  }
}
```

### **4. 서버 데이터 생성기 (목업 통합)**

```typescript
// src/services/data-generator/RealServerDataGenerator.ts
export class RealServerDataGenerator {
  private mockMode: boolean;
  private servers: ServerInstance[] = [];

  constructor() {
    this.mockMode = this.detectMockMode();
    this.initializeServers();
    this.startDataGeneration();
  }

  private detectMockMode(): boolean {
    return (
      (typeof window !== 'undefined' &&
        window.location.pathname.includes('/health')) ||
      process.env.NODE_ENV === 'test' ||
      process.env.FORCE_MOCK_DATA === 'true'
    );
  }

  private initializeServers(): void {
    // 시나리오 기반 서버 상태 분포
    const serverConfigs = [
      { region: 'us-east-1', count: 5 },
      { region: 'eu-west-1', count: 5 },
      { region: 'ap-southeast-1', count: 5 },
    ];

    this.servers = serverConfigs.flatMap(config =>
      Array.from({ length: config.count }, (_, i) => ({
        id: `${config.region}-${i + 1}`,
        name: `Server-${config.region}-${i + 1}`,
        region: config.region,
        status: this.determineInitialStatus(i),
        metrics: this.generateInitialMetrics(),
        lastUpdated: new Date().toISOString(),
      }))
    );
  }

  private determineInitialStatus(index: number): ServerStatus {
    // 고정된 시나리오: 2개 Critical, 30% Warning, 나머지 Healthy
    if (index < 2) return 'error';
    if (index < 6) return 'warning';
    return 'healthy';
  }

  private generateRealisticMetrics(): ServerMetrics {
    const baseTime = Date.now();
    const variation = Math.random() * 0.2 - 0.1; // ±10% 변동

    return {
      cpu: Math.max(0, Math.min(100, 45 + variation * 100)),
      memory: Math.max(0, Math.min(100, 60 + variation * 100)),
      disk: Math.max(0, Math.min(100, 35 + variation * 100)),
      network: {
        incoming: Math.random() * 1000,
        outgoing: Math.random() * 800,
      },
      responseTime: 50 + Math.random() * 100,
      uptime: baseTime - Math.random() * 86400000, // 최대 1일 전
    };
  }
}
```

### **5. AI 사이드바 컴포넌트**

```typescript
// src/components/ai/AISidebarV2.tsx
export const AISidebarV2: React.FC = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [currentQuery, setCurrentQuery] = useState('');
  const [aiResponse, setAiResponse] = useState<AIResponse | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmitQuery = async (query: string) => {
    setIsLoading(true);
    setCurrentQuery(query);

    try {
      const response = await fetch('/api/ai/unified-analysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query,
          includeThinking: true,
          engines: ['google-ai', 'mcp', 'rag', 'local']
        })
      });

      const result = await response.json();
      setAiResponse(result);
    } catch (error) {
      console.error('AI query failed:', error);
      setAiResponse({
        success: false,
        content: '죄송합니다. AI 분석 중 오류가 발생했습니다.',
        confidence: 0,
        isMockMode: true
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className={`ai-sidebar ${isOpen ? 'open' : 'closed'}`}>
      <div className="sidebar-header">
        <h3>AI 어시스턴트</h3>
        <button onClick={() => setIsOpen(!isOpen)}>
          {isOpen ? '닫기' : '열기'}
        </button>
      </div>

      {isOpen && (
        <div className="sidebar-content">
          <AIQueryInput onSubmit={handleSubmitQuery} />

          {isLoading && <AIThinkingViewer />}

          {aiResponse && (
            <AIResponseDisplay
              response={aiResponse}
              showSources={true}
              showConfidence={true}
            />
          )}

          <AIPresetQuestions onSelect={handleSubmitQuery} />
        </div>
      )}
    </div>
  );
};
```

---

## 🔧 환경 설정

### **.env.local (개발환경)**

```env
# 기본 설정
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3001

# Google AI (선택사항)
GOOGLE_AI_API_KEY=your_google_ai_api_key
GOOGLE_AI_ENABLED=true
GOOGLE_AI_QUOTA_PROTECTION=true
GOOGLE_AI_TEST_LIMIT_PER_DAY=5
GOOGLE_AI_HEALTH_CHECK_CACHE_HOURS=24

# Supabase (선택사항)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Redis (선택사항)
REDIS_URL=redis://your-redis-url:6379
REDIS_PASSWORD=your_redis_password

# MCP 서버
MCP_RENDER_URL=https://openmanager-vibe-v5.onrender.com
MCP_LOCAL_URL=http://localhost:3001/api/mcp
MCP_TIMEOUT_MS=3000

# 목업 모드 강제 활성화 (개발/테스트용)
FORCE_MOCK_GOOGLE_AI=false
FORCE_MOCK_REDIS=false
FORCE_MOCK_SUPABASE=false
FORCE_MOCK_MCP=false

# 디버그 모드
DEBUG_AI_ENGINES=false
DEBUG_MCP_REQUESTS=false
DEBUG_PERFORMANCE=false

# 성능 최적화
ENABLE_AI_CACHING=true
ENABLE_RESPONSE_COMPRESSION=true
MAX_CONCURRENT_AI_REQUESTS=5
```

### **.env.production (프로덕션)**

```env
# 기본 설정
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://your-domain.vercel.app

# Google AI (실제 키 필요)
GOOGLE_AI_API_KEY=your_production_google_ai_key
GOOGLE_AI_ENABLED=true
GOOGLE_AI_QUOTA_PROTECTION=true

# Supabase (실제 프로젝트)
NEXT_PUBLIC_SUPABASE_URL=https://your-prod-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_prod_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_prod_service_role_key

# Redis (프로덕션 인스턴스)
REDIS_URL=redis://your-prod-redis:6379
REDIS_PASSWORD=your_prod_redis_password

# MCP 서버 (프로덕션)
MCP_RENDER_URL=https://openmanager-vibe-v5.onrender.com
MCP_TIMEOUT_MS=5000

# 보안 설정
NEXT_TELEMETRY_DISABLED=1
DISABLE_SOURCEMAPS=true

# 성능 최적화
ENABLE_AI_CACHING=true
ENABLE_RESPONSE_COMPRESSION=true
MAX_CONCURRENT_AI_REQUESTS=10
```

---

## 🚀 API 엔드포인트

### **AI 관련 API**

#### **통합 AI 분석**

```typescript
// POST /api/ai/unified-analysis
interface UnifiedAnalysisRequest {
  query: string;
  includeThinking?: boolean;
  engines?: ('google-ai' | 'mcp' | 'rag' | 'local')[];
  context?: {
    serverData?: ServerInstance[];
    previousQueries?: string[];
  };
}

// 사용 예시
const response = await fetch('/api/ai/unified-analysis', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: 'CPU 사용률이 높은 서버는?',
    includeThinking: true,
    engines: ['google-ai', 'mcp', 'rag', 'local'],
  }),
});
```

#### **Google AI 상태 확인**

```typescript
// GET /api/ai/google-ai/status
interface GoogleAIStatusResponse {
  enabled: boolean;
  available: boolean;
  quotaUsage: {
    daily: { used: number; limit: number };
    hourly: { used: number; limit: number };
  };
  circuitBreakerState: 'CLOSED' | 'OPEN' | 'HALF_OPEN';
  mockModeActive: boolean;
  lastHealthCheck: string;
}
```

### **데이터 관련 API**

#### **서버 데이터 조회**

```typescript
// GET /api/data-generator/servers
interface ServerDataResponse {
  servers: ServerInstance[];
  summary: {
    total: number;
    healthy: number;
    warning: number;
    critical: number;
  };
  lastUpdated: string;
  isMockMode: boolean;
}
```

#### **실시간 메트릭**

```typescript
// GET /api/metrics/realtime
interface RealtimeMetricsResponse {
  timestamp: string;
  servers: ServerMetrics[];
  aggregated: {
    avgCpu: number;
    avgMemory: number;
    avgDisk: number;
    totalNetworkTraffic: number;
  };
  alerts: AlertMetric[];
}
```

---

## 🧪 테스트 코드 샘플

### **단위 테스트 (Jest)**

```typescript
// tests/unit/UnifiedAIEngine.test.ts
describe('UnifiedAIEngine', () => {
  let engine: UnifiedAIEngine;

  beforeEach(() => {
    engine = new UnifiedAIEngine({ forceMockMode: true });
  });

  it('should handle mock mode gracefully', async () => {
    const request: UnifiedAnalysisRequest = {
      query: 'Test query',
      engines: ['local', 'rag'],
    };

    const response = await engine.processQuery(request);

    expect(response.success).toBe(true);
    expect(response.isMockMode).toBe(true);
    expect(response.confidence).toBeGreaterThan(0.5);
  });

  it('should fuse multiple AI results correctly', async () => {
    const mockResults = {
      local: { success: true, content: 'Local result', confidence: 0.8 },
      rag: { success: true, content: 'RAG result', confidence: 0.9 },
    };

    const fusedResult = engine['fuseResults'](mockResults);

    expect(fusedResult.confidence).toBeCloseTo(0.85); // 평균
    expect(fusedResult.sources).toHaveLength(2);
  });
});
```

### **통합 테스트**

```typescript
// tests/integration/ai-api.test.ts
describe('AI API Integration', () => {
  it('should handle unified analysis request', async () => {
    const response = await request(app)
      .post('/api/ai/unified-analysis')
      .send({
        query: 'CPU 사용률이 높은 서버는?',
        engines: ['local', 'rag'],
      })
      .expect(200);

    expect(response.body.success).toBe(true);
    expect(response.body.content).toBeDefined();
    expect(response.body.confidence).toBeGreaterThan(0);
  });
});
```

---

## 🎯 주요 유틸리티

### **타입 정의**

```typescript
// src/types/ai-agent.ts
export interface AIResponse {
  success: boolean;
  content: string;
  confidence: number;
  processingTime: number;
  engine: 'google-ai' | 'mcp' | 'rag' | 'local';
  isMockMode: boolean;
  sources?: string[];
  thinkingSteps?: AIThinkingStep[];
}

export interface ServerInstance {
  id: string;
  name: string;
  region: string;
  status: 'healthy' | 'warning' | 'error';
  metrics: ServerMetrics;
  lastUpdated: string;
}

export interface ServerMetrics {
  cpu: number;
  memory: number;
  disk: number;
  network: {
    incoming: number;
    outgoing: number;
  };
  responseTime: number;
  uptime: number;
}
```

### **유틸리티 함수**

```typescript
// src/utils/ai-helpers.ts
export function calculateConfidence(responses: AIResponse[]): number {
  const validResponses = responses.filter(r => r.success);
  if (validResponses.length === 0) return 0;

  return (
    validResponses.reduce((sum, r) => sum + r.confidence, 0) /
    validResponses.length
  );
}

export function formatAIResponse(response: AIResponse): string {
  const prefix = response.isMockMode ? '[목업] ' : '';
  const confidence = Math.round(response.confidence * 100);

  return `${prefix}${response.content} (신뢰도: ${confidence}%)`;
}

export function determineServerStatus(metrics: ServerMetrics): ServerStatus {
  const { cpu, memory, disk } = metrics;

  if (cpu > 90 || memory > 95 || disk > 95) return 'error';
  if (cpu > 75 || memory > 80 || disk > 85) return 'warning';
  return 'healthy';
}
```

---

## 📝 개발 가이드

### **새로운 AI 엔진 추가**

1. **인터페이스 구현**

```typescript
interface AIEngine {
  processQuery(query: string): Promise<AIResponse>;
  isAvailable(): Promise<boolean>;
  getEngineInfo(): EngineInfo;
}
```

2. **UnifiedAIEngine에 등록**

```typescript
// src/core/ai/UnifiedAIEngine.ts
this.customEngine = new CustomAIEngine();
```

3. **목업 응답 구현**

```typescript
generateMockResponse(request: AIRequest): AIResponse {
  return {
    success: true,
    content: 'Custom AI mock response',
    confidence: 0.8,
    isMockMode: true
  };
}
```

### **새로운 API 엔드포인트 추가**

1. **API 라우트 생성**

```typescript
// src/app/api/custom/route.ts
export async function POST(request: Request) {
  try {
    const body = await request.json();
    // 처리 로직
    return NextResponse.json({ success: true, data: result });
  } catch (error) {
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}
```

2. **타입 정의 추가**

```typescript
// src/types/custom.ts
export interface CustomRequest {
  // 요청 타입 정의
}
```

이 코드 참고 문서를 통해 OpenManager Vibe v5.44.2의 핵심 구조와 구현 방법을 완전히 이해할 수 있습니다! 🚀
