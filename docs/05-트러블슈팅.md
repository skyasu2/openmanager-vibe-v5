# 트러블슈팅 가이드

## 🚨 일반적인 문제 해결

### 1. 애플리케이션 시작 실패

**문제**: `npm run dev` 실행 시 오류 발생
```bash
Error: Cannot find module 'next'
```

**해결책**:
```bash
# 의존성 재설치
rm -rf node_modules package-lock.json
npm install

# 또는 캐시 정리
npm cache clean --force
npm install
```

**문제**: 포트 3000이 이미 사용 중
```bash
Error: listen EADDRINUSE: address already in use :::3000
```

**해결책**:
```bash
# 실행 중인 프로세스 확인
lsof -i :3000

# 프로세스 종료
kill -9 [PID]

# 또는 다른 포트 사용
PORT=3001 npm run dev
```

### 2. 환경변수 설정 문제

**문제**: 환경변수가 읽히지 않음
```bash
Error: Environment variable SUPABASE_URL is not defined
```

**해결책**:
```bash
# .env.local 파일 확인
cat .env.local

# 파일 권한 확인
chmod 644 .env.local

# 환경변수 형식 확인 (따옴표 없이)
SUPABASE_URL=https://your-project.supabase.co
```

**문제**: Next.js에서 환경변수 접근 불가
```javascript
// ❌ 잘못된 방법
process.env.SUPABASE_URL // undefined in browser

// ✅ 올바른 방법
process.env.NEXT_PUBLIC_SUPABASE_URL // 브라우저에서 접근 가능
```

## 🗄️ 데이터베이스 연결 문제

### 1. Supabase 연결 실패

**문제**: Supabase 연결 시 인증 오류
```bash
Error: Invalid API key
```

**해결책**:
```bash
# API 키 확인
# Supabase 대시보드 → Settings → API
# anon (public) key와 service_role key 구분

# .env.local에서 올바른 키 사용
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**문제**: 데이터베이스 스키마가 없음
```bash
Error: relation "server_metrics" does not exist
```

**해결책**:
```bash
# 스키마 파일 실행
psql -h db.your-project.supabase.co -U postgres -d postgres -f scripts/setup-database.sql

# 또는 Supabase 대시보드에서 SQL Editor 사용
```

### 2. Redis 연결 문제

**문제**: Redis 연결 실패
```bash
Error: connect ECONNREFUSED 127.0.0.1:6379
```

**해결책**:
```bash
# Redis 서버 상태 확인
redis-cli ping

# Redis 서버 시작
sudo systemctl start redis-server

# 또는 Docker로 실행
docker run -d -p 6379:6379 redis:alpine

# 환경변수 확인
REDIS_URL=redis://localhost:6379
```

**문제**: Redis 인증 오류
```bash
Error: NOAUTH Authentication required
```

**해결책**:
```bash
# 비밀번호가 설정된 경우
REDIS_URL=redis://password@localhost:6379

# Upstash의 경우
REDIS_URL=rediss://default:password@host:6380
```

## 🔧 수집기 관련 문제

### 1. Prometheus 수집기 오류

**문제**: Prometheus 서버 연결 실패
```bash
Error: connect ECONNREFUSED prometheus:9090
```

**해결책**:
```bash
# Prometheus URL 확인
curl http://prometheus:9090/api/v1/query?query=up

# 네트워크 접근 확인
ping prometheus

# 환경변수 수정
PROMETHEUS_URL=http://localhost:9090  # 로컬 테스트용
PROMETHEUS_URL=https://prometheus.your-domain.com  # 프로덕션용
```

**문제**: PromQL 쿼리 오류
```bash
Error: bad_data: invalid parameter "query"
```

**해결책**:
```typescript
// 쿼리 인코딩 확인
const query = encodeURIComponent('node_cpu_seconds_total');
const url = `${PROMETHEUS_URL}/api/v1/query?query=${query}`;

// 쿼리 유효성 검사
// Prometheus 웹 UI에서 먼저 테스트
```

### 2. CloudWatch 수집기 오류

**문제**: AWS 인증 실패
```bash
Error: The security token included in the request is invalid
```

**해결책**:
```bash
# AWS 자격 증명 확인
aws sts get-caller-identity

# 환경변수 설정
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_REGION=ap-northeast-2

# IAM 권한 확인 (CloudWatch 읽기 권한 필요)
```

**문제**: CloudWatch 메트릭 조회 실패
```bash
Error: No metrics found for namespace AWS/EC2
```

**해결책**:
```bash
# 네임스페이스 확인
aws cloudwatch list-metrics --namespace AWS/EC2

# 메트릭 이름 확인
aws cloudwatch list-metrics --metric-name CPUUtilization

# 시간 범위 조정 (최근 5분간 데이터 확인)
```

### 3. Custom API 수집기 오류

**문제**: API 엔드포인트 접근 불가
```bash
Error: connect ECONNREFUSED server:8080
```

**해결책**:
```bash
# 엔드포인트 URL 확인
curl http://server:8080/metrics

# 네트워크 연결 확인
telnet server 8080

# 환경변수 형식 확인
CUSTOM_API_ENDPOINTS=http://server1:8080/metrics,http://server2:8080/metrics
```

**문제**: 응답 형식 파싱 오류
```bash
Error: Cannot parse metrics response
```

**해결책**:
```typescript
// 응답 형식 확인
const response = await fetch(endpoint);
const data = await response.json();
console.log(data);

// 예상 형식:
{
  "cpu": 45.2,
  "memory": 67.8,
  "disk": 23.1
}
```

## 🚀 빌드 및 배포 문제

### 1. Next.js 빌드 실패

**문제**: TypeScript 컴파일 오류
```bash
Error: Type 'string | undefined' is not assignable to type 'string'
```

**해결책**:
```typescript
// Null 체크 추가
const serverId = params?.id;
if (!serverId) {
  return NextResponse.json({ error: 'Server ID required' }, { status: 400 });
}

// 또는 기본값 설정
const serverId = params?.id ?? 'unknown';
```

**문제**: 메모리 부족으로 빌드 실패
```bash
Error: JavaScript heap out of memory
```

**해결책**:
```bash
# Node.js 메모리 증가
NODE_OPTIONS="--max-old-space-size=4096" npm run build

# 또는 package.json에 스크립트 추가
"build": "NODE_OPTIONS='--max-old-space-size=4096' next build"
```

### 2. Vercel 배포 문제

**문제**: 환경변수 누락으로 배포 실패
```bash
Error: Environment variable SUPABASE_URL is not defined
```

**해결책**:
```bash
# Vercel CLI로 환경변수 추가
vercel env add SUPABASE_URL

# 또는 Vercel 대시보드에서 설정
# Project Settings → Environment Variables
```

**문제**: 빌드 시간 초과
```bash
Error: Build exceeded maximum duration
```

**해결책**:
```bash
# 빌드 최적화
# next.config.ts에 추가
const nextConfig = {
  swcMinify: true,
  experimental: {
    turbo: true  // Turbopack 사용
  }
}
```

### 3. Docker 배포 문제

**문제**: Docker 이미지 빌드 실패
```bash
Error: COPY failed: no source files were specified
```

**해결책**:
```dockerfile
# Dockerfile에서 .dockerignore 확인
# node_modules, .git 등은 제외

# 파일 경로 확인
COPY package*.json ./
COPY . .
```

**문제**: 컨테이너 실행 시 포트 접근 불가
```bash
Error: This site can't be reached
```

**해결책**:
```bash
# 포트 매핑 확인
docker run -p 3000:3000 your-app

# 또는 docker-compose.yml에서
ports:
  - "3000:3000"

# Next.js 설정 확인
ENV PORT=3000
EXPOSE 3000
```

## 🔍 성능 문제

### 1. 페이지 로딩 속도 문제

**문제**: 초기 로딩이 느림
```bash
# 개발자 도구에서 확인
Large bundle size detected
```

**해결책**:
```bash
# 번들 분석
npm run build
npm run analyze

# 동적 import 사용
const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <p>Loading...</p>
});

# 이미지 최적화
import Image from 'next/image';
```

**문제**: API 응답 속도 문제
```bash
# 응답 시간 5초 이상
```

**해결책**:
```typescript
// Redis 캐싱 활용
const cachedData = await redis.get(cacheKey);
if (cachedData) {
  return JSON.parse(cachedData);
}

// 데이터베이스 쿼리 최적화
// 인덱스 추가, 페이지네이션 구현
```

### 2. 메모리 사용량 문제

**문제**: 메모리 누수 발생
```bash
Error: JavaScript heap out of memory
```

**해결책**:
```typescript
// 메모리 사용량 모니터링
const getMemoryUsage = () => {
  const used = process.memoryUsage();
  console.log(`RSS: ${Math.round(used.rss / 1024 / 1024 * 100) / 100} MB`);
};

// 이벤트 리스너 정리
useEffect(() => {
  const handler = () => { /* ... */ };
  window.addEventListener('resize', handler);
  
  return () => {
    window.removeEventListener('resize', handler);
  };
}, []);
```

## 🔧 개발 도구 문제

### 1. ESLint 오류

**문제**: 린트 규칙 충돌
```bash
Error: Parsing error: Cannot find module '@typescript-eslint/parser'
```

**해결책**:
```bash
# TypeScript ESLint 설치
npm install -D @typescript-eslint/parser @typescript-eslint/eslint-plugin

# eslint.config.mjs 확인
export default [
  {
    files: ['**/*.ts', '**/*.tsx'],
    languageOptions: {
      parser: typescriptParser,
    },
  }
];
```

### 2. 핫 리로드 문제

**문제**: 파일 변경이 반영되지 않음
```bash
# 개발 서버가 변경사항을 감지하지 못함
```

**해결책**:
```bash
# 개발 서버 재시작
Ctrl+C
npm run dev

# 파일 시스템 감시 설정 (Linux)
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# next.config.ts에 감시 설정 추가
const nextConfig = {
  experimental: {
    turbo: true
  }
}
```

## 🆘 긴급 상황 대응

### 1. 프로덕션 서비스 다운

**단계별 대응**:

1. **즉시 확인**
```bash
# 서비스 상태 확인
curl https://your-domain.com/api/health

# 서버 리소스 확인
top
df -h
```

2. **로그 분석**
```bash
# 애플리케이션 로그
pm2 logs openmanager --lines 100

# 시스템 로그
tail -f /var/log/syslog

# Nginx 로그
tail -f /var/log/nginx/error.log
```

3. **긴급 복구**
```bash
# 서비스 재시작
pm2 restart openmanager

# 데이터베이스 연결 확인
psql -h your-db-host -U postgres -c "SELECT 1;"

# Redis 연결 확인
redis-cli ping
```

### 2. 데이터 손실 대응

**백업 복구**:
```bash
# Supabase 백업 복구
# 대시보드에서 Point-in-time Recovery 사용

# Redis 데이터 복구 (메모리 캐시이므로 재생성)
curl -X POST https://your-domain.com/api/simulate
```

### 3. 보안 사고 대응

**즉시 조치**:
```bash
# 서비스 일시 중단
pm2 stop openmanager

# 접근 로그 확인
tail -f /var/log/nginx/access.log

# 방화벽 강화
sudo ufw deny from suspicious-ip
```

## 📞 지원 요청

### 문제 보고 시 포함할 정보

1. **환경 정보**
   - 운영체제 버전
   - Node.js 버전
   - 배포 환경 (Vercel/Docker/EC2)

2. **오류 정보**
   - 정확한 오류 메시지
   - 오류 발생 시점
   - 재현 단계

3. **로그 파일**
   - 애플리케이션 로그
   - 시스템 로그
   - 브라우저 콘솔 로그

### 로그 수집 명령어

```bash
# 종합 로그 수집
echo "=== System Info ===" > debug.log
uname -a >> debug.log
node --version >> debug.log
npm --version >> debug.log

echo "=== Application Logs ===" >> debug.log
pm2 logs openmanager --lines 50 >> debug.log

echo "=== System Logs ===" >> debug.log
tail -n 50 /var/log/syslog >> debug.log

echo "=== Environment ===" >> debug.log
env | grep -E "(SUPABASE|REDIS|COLLECTOR)" >> debug.log
```

모든 트러블슈팅은 **한국어 문서**로 관리되며, 영어 문서는 생성하지 않습니다. 