# 배포 및 운영 가이드

## 🚀 배포 개요

OpenManager Vibe v5를 프로덕션 환경에 배포하고 운영하는 방법을 설명합니다.

## 🏗️ 배포 아키텍처

```
Internet
    ↓
Load Balancer
    ↓
Next.js App (Vercel/Docker)
    ↓
┌─────────────────┬─────────────────┐
│   Supabase      │     Redis       │
│ (PostgreSQL)    │   (Upstash)     │
└─────────────────┴─────────────────┘
    ↓
Data Collectors
├── Prometheus (Kubernetes)
├── CloudWatch (AWS)
└── Custom API (On-premise)
```

## 📋 배포 전 준비사항

### 1. 환경 요구사항
- Node.js 18+
- PostgreSQL 14+ (Supabase 권장)
- Redis 6+ (Upstash 권장)
- Docker (선택사항)

### 2. 외부 서비스 설정
- **Supabase 프로젝트** 생성
- **Redis 인스턴스** 준비 (Upstash 등)
- **도메인** 및 **SSL 인증서** 준비

### 3. 수집기 접근 권한
- **Prometheus**: 클러스터 접근 URL
- **AWS CloudWatch**: IAM 키 및 권한
- **Custom API**: 서버 접근 엔드포인트

## 🔧 Vercel 배포 (권장)

### 1. Vercel 프로젝트 설정
```bash
# Vercel CLI 설치
npm i -g vercel

# 프로젝트 연결
vercel link

# 환경변수 설정
vercel env add
```

### 2. 환경변수 설정
Vercel 대시보드에서 다음 환경변수를 설정합니다:

```env
# 기본 설정
NEXT_PUBLIC_SITE_URL=https://your-domain.vercel.app
COLLECTOR_MODE=production

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Redis (Upstash)
REDIS_URL=rediss://default:xxx@xxx.upstash.io:6379

# 프로덕션 수집기
PROMETHEUS_URL=https://prometheus.your-k8s.com
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_REGION=ap-northeast-2
CUSTOM_API_ENDPOINTS=https://server1.com/metrics,https://server2.com/metrics
```

### 3. 배포 실행
```bash
# 프로덕션 배포
vercel --prod
```

## 🐳 Docker 배포

### 1. Dockerfile 설정
```dockerfile
FROM node:18-alpine AS base

# 의존성 설치
FROM base AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci

# 빌드 단계
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# 프로덕션 단계
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000
ENV PORT=3000

CMD ["node", "server.js"]
```

### 2. Docker Compose 설정
```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - REDIS_URL=${REDIS_URL}
      - COLLECTOR_MODE=production
    depends_on:
      - redis
    
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/ssl
    depends_on:
      - app

volumes:
  redis_data:
```

### 3. 배포 실행
```bash
# 이미지 빌드 및 실행
docker-compose up -d

# 로그 확인
docker-compose logs -f app
```

## ☁️ AWS EC2 배포

### 1. EC2 인스턴스 준비
```bash
# Ubuntu 22.04 LTS 인스턴스에서
sudo apt update
sudo apt install -y nodejs npm nginx

# PM2 설치 (프로세스 관리)
sudo npm install -g pm2
```

### 2. 애플리케이션 배포
```bash
# 코드 배포
git clone https://github.com/your-repo/openmanager-vibe-v5.git
cd openmanager-vibe-v5

# 의존성 설치
npm install

# 프로덕션 빌드
npm run build

# PM2로 실행
pm2 start npm --name "openmanager" -- start
pm2 save
pm2 startup
```

---

## 🚨 트러블슈팅

### 1. 애플리케이션 시작 실패

**문제**: `npm run dev` 실행 시 오류 발생
```bash
Error: Cannot find module 'next'
```

**해결책**:
```bash
# 의존성 재설치
rm -rf node_modules package-lock.json
npm install

# 또는 캐시 정리
npm cache clean --force
npm install
```

**문제**: 포트 3000이 이미 사용 중
```bash
Error: listen EADDRINUSE: address already in use :::3000
```

**해결책**:
```bash
# 실행 중인 프로세스 확인
lsof -i :3000

# 프로세스 종료
kill -9 [PID]

# 또는 다른 포트 사용
PORT=3001 npm run dev
```

### 2. 환경변수 설정 문제

**문제**: 환경변수가 읽히지 않음
```bash
Error: Environment variable SUPABASE_URL is not defined
```

**해결책**:
```bash
# .env.local 파일 확인
cat .env.local

# 파일 권한 확인
chmod 644 .env.local

# 환경변수 형식 확인 (따옴표 없이)
SUPABASE_URL=https://your-project.supabase.co
```

**문제**: Next.js에서 환경변수 접근 불가
```javascript
// ❌ 잘못된 방법
process.env.SUPABASE_URL // undefined in browser

// ✅ 올바른 방법
process.env.NEXT_PUBLIC_SUPABASE_URL // 브라우저에서 접근 가능
```

### 3. 데이터베이스 연결 문제

**문제**: Supabase 연결 시 인증 오류
```bash
Error: Invalid API key
```

**해결책**:
```bash
# API 키 확인
# Supabase 대시보드 → Settings → API
# anon (public) key와 service_role key 구분

# .env.local에서 올바른 키 사용
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**문제**: Redis 연결 실패
```bash
Error: connect ECONNREFUSED 127.0.0.1:6379
```

**해결책**:
```bash
# Redis 서버 상태 확인
redis-cli ping

# Redis 서버 시작
sudo systemctl start redis-server

# 또는 Docker로 실행
docker run -d -p 6379:6379 redis:alpine

# 환경변수 확인
REDIS_URL=redis://localhost:6379
```

### 4. 수집기 관련 문제

**문제**: Prometheus 서버 연결 실패
```bash
Error: connect ECONNREFUSED prometheus:9090
```

**해결책**:
```bash
# Prometheus URL 확인
curl http://prometheus:9090/api/v1/query?query=up

# 네트워크 접근 확인
ping prometheus

# 환경변수 수정
PROMETHEUS_URL=http://localhost:9090  # 로컬 테스트용
PROMETHEUS_URL=https://prometheus.your-domain.com  # 프로덕션용
```

**문제**: CloudWatch 수집기 오류
```bash
Error: The security token included in the request is invalid
```

**해결책**:
```bash
# AWS 자격 증명 확인
aws sts get-caller-identity

# 환경변수 설정
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_REGION=ap-northeast-2

# IAM 권한 확인 (CloudWatch 읽기 권한 필요)
```

### 5. 성능 최적화

**문제**: 메모리 사용량 과다
```bash
# Node.js 메모리 제한 증가
NODE_OPTIONS="--max-old-space-size=4096" npm start

# PM2 클러스터 모드
pm2 start ecosystem.config.js
```

**문제**: 빌드 시간 과다
```bash
# 병렬 빌드 활성화
npm run build -- --parallel

# 캐시 활용
npm run build -- --cache
```

### 6. 보안 설정

**SSL 인증서 설정**:
```bash
# Let's Encrypt 인증서
sudo certbot --nginx -d your-domain.com
```

**방화벽 설정**:
```bash
# UFW 방화벽
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 22
sudo ufw enable
```

### 7. 모니터링 및 로깅

**로그 관리**:
```bash
# PM2 로그 확인
pm2 logs openmanager

# 로그 로테이션
pm2 install pm2-logrotate
```

**성능 모니터링**:
```bash
# PM2 모니터링
pm2 monit

# 시스템 리소스 확인
htop
iotop
```

## 🔍 상태 점검 체크리스트

### 배포 후 확인사항
- [ ] 웹사이트 접속 확인
- [ ] AI 에이전트 응답 테스트
- [ ] 데이터 수집기 동작 확인
- [ ] SSL 인증서 유효성 검사
- [ ] 백업 시스템 작동 확인

### 정기 점검사항
- [ ] 데이터베이스 용량 확인
- [ ] 로그 파일 크기 관리
- [ ] 보안 업데이트 적용
- [ ] 성능 메트릭 검토
- [ ] 백업 데이터 복원 테스트

---

**Copyright(c) 저작자. All rights reserved.** 