# 🚨 배포 오류 해결 가이드

## 1. 즉시 확인해야 할 사항들

### ✅ 환경 변수 확인
Vercel 대시보드에서 다음 환경 변수들이 모두 설정되어 있는지 확인:

```
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
UPSTASH_REDIS_REST_URL=your_upstash_redis_url
UPSTASH_REDIS_REST_TOKEN=your_upstash_redis_token
```

### ✅ 빌드 명령어 확인
`package.json`에서 scripts 확인:
```json
{
  "scripts": {
    "build": "next build",
    "start": "next start"
  }
}
```

### ✅ Node.js 버전 확인
`package.json`에 Node.js 버전 명시:
```json
{
  "engines": {
    "node": ">=18.0.0"
  }
}
```

## 2. 주요 오류별 해결책

### 🔥 TypeScript ESLint 오류

**증상:**
```bash
Error: Unexpected any. Specify a different type.  @typescript-eslint/no-explicit-any
```

**해결 방법:**
1. `any` 타입 대신 구체적인 타입 사용:
```typescript
// 잘못된 예:
const data: any = fetchData();

// 올바른 예:
const data: Record<string, unknown> = fetchData();
```

2. 반환 타입 명확히 지정:
```typescript
// 잘못된 예:
async function getData() {
  return await api.fetch();
}

// 올바른 예:
async function getData(): Promise<ResponseType | null> {
  return await api.fetch();
}
```

3. `null` 타입 처리:
```typescript
// 잘못된 예:
const value = await cache.get(key) as number || 0;

// 올바른 예:
const value = await cache.get(key) as number | null || 0;
```

4. 객체 타입 구체화:
```typescript
// 잘못된 예:
interface Config {
  options: any;
}

// 올바른 예:
interface Config {
  options: Record<string, unknown>;
}
```

### 🔥 Vercel 환경 변수 오류

**증상:**
```bash
Environment Variable 'NEXT_PUBLIC_APP_URL' references Secret 'app-url', which does not exist.
```

**해결 방법:**

#### 방법 1: 환경 변수를 직접 값으로 설정 (권장)

1. **Vercel 대시보드로 이동**
   - 프로젝트 → Settings → Environment Variables

2. **기존 환경 변수 삭제 후 재설정**
   - `NEXT_PUBLIC_APP_URL` 삭제
   - 새로 추가: `NEXT_PUBLIC_APP_URL` = `https://your-app-name.vercel.app`

3. **모든 환경 변수를 직접 값으로 설정**
   ```
   NEXT_PUBLIC_APP_URL = https://openmanager-vibe-v5.vercel.app
   NEXT_PUBLIC_SUPABASE_URL = https://your-project.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   SUPABASE_SERVICE_ROLE_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   UPSTASH_REDIS_REST_URL = https://your-redis.upstash.io
   UPSTASH_REDIS_REST_TOKEN = AXX2ASQzNzYyYjYtZGE5...
   ```

#### 방법 2: vercel.json 파일 수정

프로젝트 루트의 `vercel.json` 파일에서 Secret 참조 제거:

```json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "regions": ["icn1"],
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 10
    }
  }
  // env 섹션 전체 제거 또는 수정
}
```

#### 방법 3: Vercel CLI로 Secret 생성 (고급)

터미널에서 다음 명령어 실행:

```bash
# Vercel CLI 설치 (필요시)
npm i -g vercel

# 프로젝트 디렉토리에서
vercel login
vercel link

# Secret 생성
vercel secrets add app-url "https://openmanager-vibe-v5.vercel.app"
vercel secrets add supabase-url "https://your-project.supabase.co"
vercel secrets add supabase-anon-key "your_anon_key"
vercel secrets add supabase-service-role-key "your_service_role_key"
vercel secrets add upstash-redis-url "your_redis_url"
vercel secrets add upstash-redis-token "your_redis_token"
```

#### 환경 변수 값 확인 방법

**Supabase 값 찾기**
1. [Supabase 대시보드](https://supabase.com/dashboard) → 프로젝트 선택
2. Settings → API
3. URL, anon key, service_role key 복사

**Upstash Redis 값 찾기**
1. [Upstash 콘솔](https://console.upstash.com/) → 데이터베이스 선택
2. Details 탭에서 REST API URL과 Token 복사

**앱 URL 설정**
- 개발: `http://localhost:3000`
- 프로덕션: `https://your-app-name.vercel.app`

**주의사항**
- **Public 환경 변수** (`NEXT_PUBLIC_*`): 클라이언트에서 접근 가능
- **Private 환경 변수**: 서버에서만 접근 가능
- **Secret 키들**: 절대 GitHub에 커밋하지 말 것

### 🔥 빌드 실패 (Build Error)

**증상:**
```bash
Error: Command "npm run build" exited with 1
```

**해결 방법:**
1. 로컬에서 빌드 테스트:
```bash
npm run build
```

2. 의존성 재설치:
```bash
rm -rf node_modules package-lock.json
npm install
```

3. TypeScript 오류 확인:
```bash
npm run type-check
```

### 🔥 함수 실행 실패 (Function Timeout)

**증상:**
```bash
[ERROR] Function execution timed out after 10 seconds
```

**해결 방법:**
1. `vercel.json` 함수 설정 확인:
```json
{
  "functions": {
    "src/app/api/**/*.ts": {
      "maxDuration": 10
    }
  }
}
```

2. API 함수 최적화:
```typescript
// API 함수에서 빠른 응답 보장
export async function POST(request: Request) {
  try {
    // 타임아웃 설정
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    
    // 실제 로직
    const result = await processRequest(request, { signal: controller.signal });
    
    clearTimeout(timeoutId);
    return Response.json(result);
  } catch (error) {
    return Response.json({ error: 'Request failed' }, { status: 500 });
  }
}
```

### 🔥 환경 변수 누락

**증상:**
```bash
Error: Environment variable "SUPABASE_URL" is not defined
```

**해결 방법:**
1. Vercel 대시보드에서 환경 변수 추가
2. Production, Preview, Development 모든 환경에 설정
3. 재배포 실행

### 🔥 임포트 오류

**증상:**
```bash
Module not found: Can't resolve '@/lib/redis'
```

**해결 방법:**
1. `tsconfig.json` 경로 확인:
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

2. `next.config.js` 설정 확인:
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    // 설정 확인
  }
}

module.exports = nextConfig
```

## 3. 긴급 수정 방법

### 🚀 1단계: 기본 설정 확인
```bash
# 1. 로컬 빌드 테스트
npm run build

# 2. 린트 확인
npm run lint

# 3. 타입 체크
npm run type-check
```

### 🚀 2단계: Vercel 설정 업데이트
1. Vercel 대시보드 → Settings → Environment Variables
2. 모든 필수 환경 변수 추가
3. Deployments → Redeploy

### 🚀 3단계: 최소 구성으로 테스트
임시로 간단한 페이지만 배포해서 테스트:

```typescript
// src/app/page.tsx - 최소 구성
export default function Home() {
  return (
    <div>
      <h1>OpenManager Vibe V5</h1>
      <p>배포 테스트 중...</p>
    </div>
  )
}
```

## 4. 상세 디버깅 방법

### 📊 Vercel 로그 확인
1. Vercel 대시보드 → Functions → View Function Logs
2. 실시간 로그 모니터링으로 정확한 오류 지점 파악

### 📊 로컬 환경 확인
```bash
# 로컬에서 프로덕션 빌드 테스트
npm run build
npm run start

# 환경 변수 확인
echo $NEXT_PUBLIC_SUPABASE_URL
```

### 📊 의존성 호환성 확인
```bash
# 의존성 충돌 확인
npm ls
npm audit

# 호환성 문제 해결
npm update
```

## 5. 임시 해결책

### 🔧 단계적 배포
1. 먼저 기본 Next.js 앱만 배포
2. 하나씩 기능 추가하며 배포
3. 오류 발생 지점 정확히 파악

### 🔧 환경 분리
1. Development 환경에서만 먼저 테스트
2. Preview 환경으로 단계적 진행
3. Production 환경으로 최종 배포

## 6. 예방 방법

### ✅ 배포 전 체크리스트
- [ ] 로컬 빌드 성공 확인
- [ ] 모든 환경 변수 설정 확인
- [ ] TypeScript 오류 없음 확인
- [ ] ESLint 오류 없음 확인
- [ ] `any` 타입 사용 여부 확인
- [ ] 의존성 버전 호환성 확인
- [ ] API 함수 타임아웃 설정 확인

### ✅ 모니터링 설정
- [ ] Vercel 알림 설정
- [ ] 오류 로깅 시스템 구축
- [ ] 헬스체크 엔드포인트 추가

---

**🚨 긴급 지원이 필요하시면 구체적인 오류 메시지를 공유해주세요!**