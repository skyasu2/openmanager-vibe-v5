# 배포 가이드

## 🚀 배포 개요

OpenManager Vibe v5를 프로덕션 환경에 배포하는 방법을 설명합니다.

## 🏗️ 배포 아키텍처

```
Internet
    ↓
Load Balancer
    ↓
Next.js App (Vercel/Docker)
    ↓
┌─────────────────┬─────────────────┐
│   Supabase      │     Redis       │
│ (PostgreSQL)    │   (Upstash)     │
└─────────────────┴─────────────────┘
    ↓
Data Collectors
├── Prometheus (Kubernetes)
├── CloudWatch (AWS)
└── Custom API (On-premise)
```

## 📋 배포 전 준비사항

### 1. 환경 요구사항
- Node.js 18+
- PostgreSQL 14+ (Supabase 권장)
- Redis 6+ (Upstash 권장)
- Docker (선택사항)

### 2. 외부 서비스 설정
- **Supabase 프로젝트** 생성
- **Redis 인스턴스** 준비 (Upstash 등)
- **도메인** 및 **SSL 인증서** 준비

### 3. 수집기 접근 권한
- **Prometheus**: 클러스터 접근 URL
- **AWS CloudWatch**: IAM 키 및 권한
- **Custom API**: 서버 접근 엔드포인트

## 🔧 Vercel 배포 (권장)

### 1. Vercel 프로젝트 설정
```bash
# Vercel CLI 설치
npm i -g vercel

# 프로젝트 연결
vercel link

# 환경변수 설정
vercel env add
```

### 2. 환경변수 설정
Vercel 대시보드에서 다음 환경변수를 설정합니다:

```env
# 기본 설정
NEXT_PUBLIC_SITE_URL=https://your-domain.vercel.app
COLLECTOR_MODE=production

# Supabase
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Redis (Upstash)
REDIS_URL=rediss://default:xxx@xxx.upstash.io:6379

# 프로덕션 수집기
PROMETHEUS_URL=https://prometheus.your-k8s.com
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_REGION=ap-northeast-2
CUSTOM_API_ENDPOINTS=https://server1.com/metrics,https://server2.com/metrics
```

### 3. 배포 실행
```bash
# 프로덕션 배포
vercel --prod
```

### 4. 도메인 설정
```bash
# 커스텀 도메인 추가
vercel domains add your-domain.com
```

## 🐳 Docker 배포

### 1. Dockerfile 생성
```dockerfile
FROM node:18-alpine AS base

# 의존성 설치
FROM base AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci

# 빌드 단계
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# 프로덕션 단계
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000
ENV PORT=3000

CMD ["node", "server.js"]
```

### 2. Docker Compose 설정
```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - REDIS_URL=${REDIS_URL}
      - COLLECTOR_MODE=production
    depends_on:
      - redis
    
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/ssl
    depends_on:
      - app

volumes:
  redis_data:
```

### 3. 배포 실행
```bash
# 이미지 빌드 및 실행
docker-compose up -d

# 로그 확인
docker-compose logs -f app
```

## ☁️ AWS EC2 배포

### 1. EC2 인스턴스 준비
```bash
# Ubuntu 22.04 LTS 인스턴스에서
sudo apt update
sudo apt install -y nodejs npm nginx

# PM2 설치 (프로세스 관리)
sudo npm install -g pm2
```

### 2. 애플리케이션 배포
```bash
# 코드 배포
git clone https://github.com/your-repo/openmanager-vibe-v5.git
cd openmanager-vibe-v5

# 의존성 설치 및 빌드
npm install
npm run build

# 환경변수 설정
cp .env.example .env.local
# .env.local 편집

# PM2로 실행
pm2 start npm --name "openmanager" -- start
pm2 save
pm2 startup
```

### 3. Nginx 설정
```nginx
# /etc/nginx/sites-available/openmanager
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# Nginx 설정 활성화
sudo ln -s /etc/nginx/sites-available/openmanager /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# SSL 인증서 설정 (Let's Encrypt)
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## 🗄️ 데이터베이스 설정

### 1. Supabase 프로젝트 생성
1. https://supabase.com 에서 새 프로젝트 생성
2. 데이터베이스 비밀번호 설정
3. API 키 복사

### 2. 스키마 설정
```bash
# 로컬에서 스키마 적용
psql -h db.your-project.supabase.co -U postgres -d postgres -f scripts/setup-database.sql
```

### 3. RLS (Row Level Security) 설정
Supabase 대시보드에서:
1. Authentication → Settings → "Enable RLS" 체크
2. Table Editor에서 정책 설정

## 🔄 Redis 설정

### 1. Upstash Redis (권장)
1. https://upstash.com 에서 데이터베이스 생성
2. 연결 URL 복사
3. 환경변수에 설정

### 2. 자체 Redis 서버
```bash
# Ubuntu에서 Redis 설치
sudo apt install redis-server

# 설정 편집
sudo nano /etc/redis/redis.conf

# 보안 설정
requirepass your-strong-password
bind 127.0.0.1

# 서비스 재시작
sudo systemctl restart redis-server
```

## 📊 모니터링 및 로깅

### 1. 애플리케이션 모니터링
```bash
# PM2 모니터링
pm2 monit

# 로그 확인
pm2 logs openmanager

# 성능 메트릭
pm2 show openmanager
```

### 2. 로그 수집 설정
```javascript
// next.config.ts에 추가
const nextConfig = {
  experimental: {
    instrumentationHook: true,
  },
  logging: {
    fetches: {
      fullUrl: true,
    },
  },
}
```

### 3. 알림 설정
```bash
# PM2 알림 설정
pm2 install pm2-logrotate
pm2 install pm2-auto-pull
```

## 🔒 보안 설정

### 1. 환경변수 보안
```bash
# 환경변수 파일 권한 설정
chmod 600 .env.local

# Git에서 제외
echo ".env.local" >> .gitignore
```

### 2. 방화벽 설정
```bash
# UFW 방화벽 설정
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
```

### 3. SSL/TLS 설정
```bash
# 강력한 SSL 설정
sudo nano /etc/nginx/snippets/ssl-params.conf

# 내용:
ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
```

## 🎯 성능 최적화

### 1. Next.js 최적화
```javascript
// next.config.ts
const nextConfig = {
  compress: true,
  swcMinify: true,
  images: {
    optimized: true,
  },
  experimental: {
    appDir: true,
  },
}
```

### 2. CDN 설정
```bash
# Vercel의 경우 자동 CDN 제공
# AWS CloudFront 또는 Cloudflare 사용 권장
```

### 3. 캐싱 전략
```bash
# Redis 캐시 최적화
# TTL 설정: 5분 (메트릭 데이터)
# 압축 활성화
```

## 🔍 배포 검증

### 1. 헬스 체크
```bash
# API 엔드포인트 확인
curl https://your-domain.com/api/health
curl https://your-domain.com/api/ping
```

### 2. 성능 테스트
```bash
# 부하 테스트 (예: Artillery)
npm install -g artillery
artillery quick --count 50 --num 100 https://your-domain.com
```

### 3. 기능 테스트
```bash
# 주요 API 테스트
curl https://your-domain.com/api/servers
curl https://your-domain.com/api/dashboard
```

## 🚨 장애 대응

### 1. 롤백 절차
```bash
# Vercel 롤백
vercel --prod --env=rollback

# PM2 롤백
pm2 reload openmanager
```

### 2. 로그 분석
```bash
# 에러 로그 확인
pm2 logs openmanager --err
tail -f /var/log/nginx/error.log
```

### 3. 긴급 대응
```bash
# 서비스 재시작
pm2 restart openmanager
sudo systemctl restart nginx
```

## 📝 배포 체크리스트

### 배포 전
- [ ] 환경변수 설정 확인
- [ ] 데이터베이스 스키마 적용
- [ ] Redis 연결 테스트
- [ ] 수집기 설정 검증
- [ ] 빌드 성공 확인

### 배포 후
- [ ] 헬스 체크 API 확인
- [ ] 주요 기능 테스트
- [ ] 성능 모니터링 설정
- [ ] 로그 수집 설정
- [ ] 백업 정책 수립

### 보안 체크
- [ ] SSL 인증서 설정
- [ ] 방화벽 규칙 적용
- [ ] 민감한 정보 환경변수 처리
- [ ] 접근 권한 최소화

모든 배포 과정은 **한국어 문서**로 관리하며, 영어 문서는 생성하지 않습니다. 