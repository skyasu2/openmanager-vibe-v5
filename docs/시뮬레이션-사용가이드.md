# 🎯 전역 세션 시뮬레이션 시스템 사용 가이드

## 📋 개요

OpenManager Vibe v5의 전역 세션 시뮬레이션 시스템은 **누가 랜딩페이지에서 들어와도 동일한 1시간짜리 시뮬레이션을 공유**하도록 설계되었습니다.

### 🎯 핵심 특징

- ✅ **전역 세션**: 모든 사용자가 같은 시뮬레이션 세션 공유
- ✅ **60분 시나리오**: 5분 단위 12단계로 구성된 완전한 장애/복구 시나리오
- ✅ **Redis 기반**: `sim:global:session` 키로 세션 관리
- ✅ **자동 갱신**: 60분 경과 시 새로운 세션 자동 생성
- ✅ **성능 최적화**: 100명이 동시 접속해도 세션 1개만 유지

---

## 🔧 API 엔드포인트

### 1. 시뮬레이션 초기화
```bash
GET /api/simulate/init
```

**응답 예시 (새 세션):**
```json
{
  "success": true,
  "newSession": true,
  "startedAt": "2025-05-25T14:00:00Z",
  "minutesElapsed": 0,
  "sessionId": "global_1740825600000_abc123def",
  "currentStep": 0,
  "totalSteps": 12,
  "nextDataUpdate": "2025-05-25T14:05:00Z"
}
```

**응답 예시 (기존 세션):**
```json
{
  "success": true,
  "newSession": false,
  "startedAt": "2025-05-25T14:00:00Z",
  "minutesElapsed": 12,
  "sessionId": "global_1740825600000_abc123def",
  "currentStep": 2,
  "totalSteps": 12,
  "nextDataUpdate": "2025-05-25T14:15:00Z"
}
```

### 2. 시뮬레이션 스텝 실행
```bash
POST /api/simulate/step
```

**응답 예시:**
```json
{
  "success": true,
  "step": 3,
  "timestamp": "2025-05-25T14:15:00Z",
  "dataKey": "sim:global:data:1740826500",
  "serversAffected": 1,
  "newIssues": 1,
  "description": "K8s 마스터 노드 리소스 고갈"
}
```

### 3. 시뮬레이션 데이터 조회
```bash
# 현재 데이터 조회
GET /api/simulate/data?step=current

# 특정 스텝 데이터 조회
GET /api/simulate/data?step=5

# 특정 타임스탬프 데이터 조회
GET /api/simulate/data?timestamp=1740826500
```

### 4. 세션 상태 확인
```bash
OPTIONS /api/simulate/data
```

**응답 예시:**
```json
{
  "success": true,
  "hasActiveSession": true,
  "session": {
    "sessionId": "global_1740825600000_abc123def",
    "startedAt": "2025-05-25T14:00:00Z",
    "minutesElapsed": 25,
    "currentStep": 5,
    "totalSteps": 12,
    "isCompleted": false,
    "remainingMinutes": 35
  },
  "dataStatus": {
    "availableSteps": [0, 1, 2, 3, 4, 5],
    "totalGeneratedSteps": 6,
    "nextStepDue": "2025-05-25T14:30:00Z"
  }
}
```

---

## 🎭 시뮬레이션 시나리오

### 12단계 시나리오 구성

| 스텝 | 시간 | 시나리오 | 설명 |
|------|------|----------|------|
| 0 | 0-5분 | 🟢 **Stable Start** | 시뮬레이션 시작 - 모든 시스템 정상 |
| 1 | 5-10분 | 🟡 **Load Increase** | 일부 서버에서 부하 증가 감지 (3대 영향) |
| 2 | 10-15분 | 🟡 **Database Load** | DB 연결 풀 사용률 증가 (2대 영향) |
| 3 | 15-20분 | 🔴 **First Failure** | K8s 마스터 노드 리소스 고갈 (1대 Critical) |
| 4 | 20-25분 | 🔴 **Cascade Failure** | 장애 연쇄 반응 - 다중 서버 영향 (4대 영향) |
| 5 | 25-30분 | 🟡 **Recovery Start** | 복구 절차 시작 - 부하 감소 중 (2대 영향) |
| 6 | 30-35분 | 🟢 **Stabilization** | 시스템 안정화 진행 중 (1대 영향) |
| 7 | 35-40분 | 🟡 **Storage Issue** | 스토리지 용량 부족 경고 (2대 영향) |
| 8 | 40-45분 | 🟡 **Network Issue** | 네트워크 지연 증가 감지 (5대 영향) |
| 9 | 45-50분 | 🟢 **Optimization** | 자동 최적화 적용 - 성능 개선 |
| 10 | 50-55분 | 🟢 **Final Stabilization** | 전체 시스템 안정화 완료 |
| 11 | 55-60분 | ✅ **Completion** | 시뮬레이션 완료 - 모든 시스템 정상 |

---

## 🗂️ Redis 데이터 구조

### 세션 키
```redis
Key: sim:global:session
TTL: 3600초 (60분)
Value: {
  "startedAt": "2025-05-25T14:00:00Z",
  "sessionId": "global_1740825600000_abc123def",
  "currentStep": 5,
  "totalSteps": 12
}
```

### 데이터 키
```redis
Key: sim:global:data:1740825600  # Unix timestamp
TTL: 3600초 (60분)
Value: {
  "timestamp": "2025-05-25T14:00:00Z",
  "step": 0,
  "sessionId": "global_1740825600000_abc123def",
  "scenario": "Stable Start",
  "description": "시뮬레이션 시작 - 모든 시스템 정상 운영",
  "servers": [...], // 30개 서버 상태
  "incidents": [...], // 발생한 이벤트들
  "metadata": {
    "totalServers": 30,
    "healthyServers": 30,
    "warningServers": 0,
    "criticalServers": 0,
    "averageCpu": 25,
    "averageMemory": 35,
    "newIssuesCount": 0
  }
}
```

---

## 🚀 프론트엔드 통합 예시

### 1. 컴포넌트에서 세션 초기화
```typescript
// components/SimulationStatus.tsx
import { useEffect, useState } from 'react'

interface SimulationSession {
  sessionId: string
  startedAt: string
  minutesElapsed: number
  currentStep: number
  totalSteps: number
  isActive: boolean
}

export function SimulationStatus() {
  const [session, setSession] = useState<SimulationSession | null>(null)

  useEffect(() => {
    async function initSimulation() {
      try {
        const response = await fetch('/api/simulate/init')
        const data = await response.json()
        
        if (data.success) {
          setSession({
            sessionId: data.sessionId,
            startedAt: data.startedAt,
            minutesElapsed: data.minutesElapsed,
            currentStep: data.currentStep,
            totalSteps: data.totalSteps,
            isActive: data.minutesElapsed < 60
          })
        }
      } catch (error) {
        console.error('Failed to initialize simulation:', error)
      }
    }

    initSimulation()
  }, [])

  if (!session) return <div>세션 로딩 중...</div>

  return (
    <div className="bg-blue-50 p-4 rounded-lg">
      <h3 className="font-semibold">🎯 시뮬레이션 세션</h3>
      <p>세션 ID: {session.sessionId}</p>
      <p>경과 시간: {session.minutesElapsed}분</p>
      <p>현재 스텝: {session.currentStep}/{session.totalSteps}</p>
      <p>상태: {session.isActive ? '🟢 진행 중' : '🔴 완료'}</p>
    </div>
  )
}
```

### 2. 실시간 데이터 업데이트
```typescript
// hooks/useSimulationData.ts
import { useEffect, useState } from 'react'

export function useSimulationData() {
  const [currentData, setCurrentData] = useState(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function fetchCurrentData() {
      try {
        const response = await fetch('/api/simulate/data?step=current')
        const data = await response.json()
        
        if (data.success) {
          setCurrentData(data.data)
        }
      } catch (error) {
        console.error('Failed to fetch simulation data:', error)
      } finally {
        setLoading(false)
      }
    }

    // 초기 로드
    fetchCurrentData()

    // 5분마다 업데이트
    const interval = setInterval(fetchCurrentData, 5 * 60 * 1000)
    
    return () => clearInterval(interval)
  }, [])

  return { currentData, loading }
}
```

---

## ⚡ 성능 최적화

### 동시 접속자 처리
- **문제**: 10명이 동시에 `/api/simulate/init` 호출
- **해결**: Redis 전역 세션으로 모든 사용자가 동일한 데이터 참조
- **결과**: 서버 부하 최소화, 일관된 사용자 경험

### 캐싱 전략
- **세션 데이터**: 60분 TTL, 자동 만료
- **스텝 데이터**: 1시간 TTL, 필요시에만 생성
- **메모리 효율**: 불필요한 데이터 자동 정리

### 에러 처리
- **Redis 연결 실패**: 개발 모드에서 메모리 캐시 fallback
- **세션 만료**: 자동으로 새 세션 생성
- **데이터 누락**: 명확한 오류 메시지와 해결 방법 제시

---

## 🔄 운영 가이드

### 세션 상태 모니터링
```bash
# 현재 활성 세션 확인
curl http://localhost:3000/api/simulate/data/status

# 세션 강제 초기화 (개발용)
curl -X DELETE http://localhost:3000/api/simulate/init
```

### 로그 확인
```bash
# 세션 생성 로그
🌍 New global simulation session created: global_1740825600000_abc123def

# 스텝 실행 로그
📊 Simulation step 3 created: Step 3
   Affected servers: 1, New issues: 1

# 데이터 생성 로그
📊 Initial simulation data created: sim:global:data:1740825600
   Healthy: 30, Warning: 0, Critical: 0
```

---

## 🎉 완료!

이제 전역 세션 기반 시뮬레이션 시스템이 완전히 구현되었습니다:

✅ **세션 관리**: `sim:global:session` 키로 60분 세션  
✅ **데이터 생성**: 5분 단위 스텝별 시나리오  
✅ **성능 최적화**: 다중 사용자 동일 세션 공유  
✅ **API 완성**: init, step, data, status 엔드포인트  
✅ **시나리오 완성**: 12단계 완전한 장애/복구 스토리  

**누가 랜딩페이지에서 들어와도 모두 같은 드라마틱한 1시간 시뮬레이션을 경험하게 됩니다!** 🚀 