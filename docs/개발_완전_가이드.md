# 🛠️ OpenManager Vibe v5 - 개발 완전 가이드

## 📋 목차

1. [AI 에이전트 아키텍처](#ai-에이전트-아키텍처)
2. [개발 환경 설정](#개발-환경-설정)
3. [상태 관리 시스템](#상태-관리-시스템)
4. [인증 시스템](#인증-시스템)
5. [컴포넌트 구조](#컴포넌트-구조)
6. [API 라우트](#api-라우트)
7. [보안 구현](#보안-구현)

---

## 🤖 AI 에이전트 아키텍처

### v5.41.3 주요 변경사항 (2025-01-09)

**AI 에이전트 접근 권한 구조 개선**

#### 변경 전 (Legacy)

```typescript
// 기존: AI 에이전트 사용을 위해 PIN 인증 필요
aiAgent: {
  isEnabled: false,        // 기본 비활성화
  isAuthenticated: false,  // PIN 인증 필요
  state: 'disabled'
}
```

#### 변경 후 (Current)

```typescript
// 신규: AI 에이전트 기본 활성화, 관리자 기능만 인증 필요
aiAgent: {
  isEnabled: true,         // 기본 활성화 - 누구나 사용 가능
  state: 'enabled'
}

// 새로운 관리자 모드 분리
adminMode: {
  isAuthenticated: false,  // 관리자 기능만 PIN 인증
  lastLoginTime: null
}
```

### 사용자 접근 권한 매트릭스

| 기능 | 일반 사용자 | 관리자 (PIN 인증) |
|------|-------------|-------------------|
| AI 에이전트 기본 사용 | ✅ 즉시 가능 | ✅ 가능 |
| AI 사이드바 | ✅ 사용 가능 | ✅ 사용 가능 |
| AI 질의 응답 | ✅ 사용 가능 | ✅ 사용 가능 |
| AI 관리자 페이지 | ❌ 차단 | ✅ 접근 가능 |
| AI 설정 변경 | ❌ 차단 | ✅ 가능 |
| 패턴 분석 관리 | ❌ 차단 | ✅ 가능 |
| 스마트 질의 추천 | ❌ 차단 | ✅ 가능 |

---

## ⚙️ 개발 환경 설정

### 필수 요구사항

```bash
# Node.js & 패키지 매니저
Node.js >= 18.17.0
npm >= 9.0.0

# 개발 도구
Cursor IDE (권장)
Git >= 2.34.0
```

### 로컬 개발 환경 구축

```bash
# 1. 저장소 클론
git clone <repository-url>
cd openmanager-vibe-v5

# 2. 의존성 설치
npm install

# 3. 환경변수 설정
cp .env.example .env.local
# .env.local 파일을 편집하여 필요한 환경변수 설정

# 4. 개발 서버 시작
npm run dev
```

---

## 🗃️ 상태 관리 시스템

### useUnifiedAdminStore 구조

`src/stores/useUnifiedAdminStore.ts`

```typescript
interface UnifiedAdminState {
  // 시스템 상태
  isSystemStarted: boolean;
  systemStartTime: number | null;
  
  // AI 에이전트 (기본 활성화)
  aiAgent: {
    isEnabled: boolean;  // 기본 true
    state: 'enabled' | 'disabled' | 'processing' | 'idle';
  };
  
  // 관리자 모드 (PIN 인증 필요)
  adminMode: {
    isAuthenticated: boolean;
    lastLoginTime: number | null;
  };
  
  // 보안
  attempts: number;
  isLocked: boolean;
  lockoutEndTime: number | null;
}
```

### 주요 액션 메서드

```typescript
// 시스템 제어
startSystem(): void
stopSystem(): void

// 관리자 인증
authenticateAdmin(password: string): Promise<{success: boolean, message: string}>
logoutAdmin(): void

// 상태 확인
checkLockStatus(): boolean
getRemainingLockTime(): number
```

---

## 🔐 인증 시스템

### 관리자 PIN 인증

- **PIN 코드**: `4231` (하드코딩)
- **최대 시도**: 5회
- **잠금 시간**: 10초
- **저장소**: Zustand persist

### 인증 플로우

```typescript
// 1. 사용자가 PIN 입력
const result = await authenticateAdmin(pin);

// 2. 성공 시 관리자 모드 활성화
if (result.success) {
  adminMode.isAuthenticated = true;
  adminMode.lastLoginTime = Date.now();
}

// 3. 실패 시 시도 횟수 증가
else {
  attempts++;
  if (attempts >= 5) {
    isLocked = true;
    lockoutEndTime = Date.now() + 10000;
  }
}
```

### 보호 라우트 구현

```typescript
// src/app/admin/ai-agent/page.tsx
useEffect(() => {
  if (!adminMode.isAuthenticated) {
    router.push('/');
    return;
  }
}, [adminMode.isAuthenticated, router]);
```

---

## 🧩 컴포넌트 구조

### 인증 관련 컴포넌트

```
src/components/unified-profile/
├── UnifiedProfileComponent.tsx     # 메인 프로필 컴포넌트
├── UnifiedSettingsPanel.tsx        # 설정 패널 (AI 관리자 로그인)
├── hooks/
│   └── useAuthentication.ts        # 인증 훅
├── components/
│   └── ProfileDropdown.tsx         # 드롭다운 (로그아웃 옵션)
└── types/
    └── ProfileTypes.ts             # 타입 정의
```

### 핵심 컴포넌트 사용법

```typescript
// 관리자 상태 확인
const { adminMode } = useUnifiedAdminStore();

// 관리자 기능 조건부 렌더링
{adminMode.isAuthenticated && (
  <AdminOnlyComponent />
)}

// 인증 훅 사용
const { handleAIAuthentication } = useAuthentication();
await handleAIAuthentication(pin);
```

---

## 📊 API 라우트

### AI 에이전트 관련 API

```
/api/ai-agent/
├── power/              # AI 에이전트 전원 관리 (관리자 전용)
├── admin/
│   ├── logs/          # 관리자 로그 조회
│   └── stats/         # 관리자 통계
└── learning/
    └── analysis/      # 학습 분석 (관리자 전용)
```

### 인증이 필요한 API

- ✅ `/api/ai-agent/power` (activate 액션)
- ✅ `/api/ai-agent/admin/*`
- ✅ `/api/ai-agent/learning/*`

### 개방된 API

- ✅ `/api/ai/*` (기본 AI 기능)
- ✅ `/api/system/status`
- ✅ `/api/health`

---

## 🛡️ 보안 구현

### 클라이언트 사이드 보안

1. **라우트 보호**: 관리자 페이지 접근 시 인증 확인
2. **UI 조건부 렌더링**: 인증 상태에 따른 버튼/메뉴 표시
3. **상태 지속성**: 새로고침 후에도 관리자 상태 유지

### 서버 사이드 보안

```typescript
// API 라우트에서 관리자 인증 확인
const adminStore = useUnifiedAdminStore.getState();
if (!adminStore.adminMode.isAuthenticated) {
  return NextResponse.json({
    success: false,
    error: 'AI 관리자 기능 사용을 위해서는 관리자 인증이 필요합니다.',
    code: 'ADMIN_AUTHENTICATION_REQUIRED'
  }, { status: 401 });
}
```

---

## 🔧 개발 팁

### 디버깅

```typescript
// 관리자 상태 확인
console.log('Admin Mode:', useUnifiedAdminStore.getState().adminMode);

// 인증 상태 모니터링
useEffect(() => {
  console.log('Auth changed:', adminMode.isAuthenticated);
}, [adminMode.isAuthenticated]);
```

### 테스트

```bash
# 빌드 테스트
npm run build

# 타입 체크
npm run type-check

# 린팅
npm run lint
```

### 문제 해결

1. **인증 실패**: PIN 4231 확인, 잠금 상태 확인
2. **라우트 접근 불가**: 관리자 인증 상태 확인
3. **상태 초기화**: localStorage 클리어 후 재시작

---

*마지막 업데이트: 2025-01-09 v5.41.3*
*AI 에이전트 접근 권한 구조 개선 반영*
