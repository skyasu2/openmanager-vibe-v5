# 성능 모니터링 시스템

OpenManager Vibe V5의 핵심 기능인 성능 모니터링 시스템에 대한 문서입니다.

## 시스템 개요

Vibe V5 모니터링 시스템은 Next.js 14, Upstash Redis, Supabase를 기반으로 구축된 서버리스 아키텍처입니다. 실시간 데이터 수집, 저장, 분석 및 알림 기능을 제공합니다.

## 주요 기능

### 실시간 성능 모니터링

- **서버 리소스 모니터링**: CPU, 메모리, 디스크, 네트워크 사용량 추적
- **애플리케이션 성능 모니터링**: 응답 시간, 처리량, 오류율 측정
- **데이터베이스 모니터링**: 쿼리 성능, 연결 상태, 캐시 효율성 분석

### 데이터 저장 및 관리

- **하이브리드 스토리지 전략**:
  - **Upstash Redis**: 실시간 메트릭 데이터 캐싱 (짧은 TTL)
  - **Supabase**: 장기 데이터 저장 및 분석용 구조화된 저장소

### 알림 및 이상 탐지

- **임계값 기반 알림**: 사용자 정의 임계값 초과 시 알림
- **이상 탐지**: 과거 패턴 기반 비정상 동작 감지
- **알림 채널**: 이메일, Slack, Discord 등 다양한 통합

## 아키텍처

```
                                 ┌─────────────┐
                                 │             │
              ┌─────────────────►│  Vercel UI  │◄────────────────┐
              │                  │             │                  │
              │                  └─────────────┘                  │
              │                                                   │
              │                                                   │
   ┌──────────▼─────────┐                           ┌────────────▼─────────┐
   │                    │                           │                      │
   │  Vercel Functions  │◄─────────────────────────►│  Upstash Redis      │
   │  (Serverless API)  │                           │  (Cache/KV Store)    │
   │                    │                           │                      │
   └──────────▲─────────┘                           └──────────────────────┘
              │
              │
              │                  ┌─────────────┐
              │                  │             │
              └─────────────────►│  Supabase   │
                                 │  (Database) │
                                 │             │
                                 └─────────────┘
```

## 구현 세부사항

### 데이터 수집 모듈

```typescript
// src/modules/monitoring/collectors/server-stats.ts
export async function getServerStats(serverId?: string): Promise<ServerStats[]> {
  // 캐시 키 생성
  const cacheKey = `server-stats:${serverId || 'all'}`;
  
  // 하이브리드 스토리지에서 데이터 가져오기
  return getData(
    cacheKey,
    async () => {
      // 서버에서 실시간 데이터 수집 로직
      const servers = serverId 
        ? await fetchServerById(serverId)
        : await fetchAllServers();
        
      return servers;
    },
    { ttl: 60, persistToDatabase: true } // 1분 캐시, DB 저장
  );
}
```

### 데이터 저장 모듈

```typescript
// src/modules/storage/hybrid/storage.ts
export async function getData<T>(
  key: string,
  fetchFn: () => Promise<T>,
  options: StorageOptions = {}
): Promise<T> {
  const { ttl = 300, skipCache = false } = options;
  
  // Redis에서 캐시된 데이터 확인
  if (!skipCache) {
    const cachedData = await redis.get(key);
    if (cachedData) return JSON.parse(cachedData);
  }
  
  // 데이터 소스에서 새로운 데이터 가져오기
  const data = await fetchFn();
  
  // Redis에 캐싱
  await redis.set(key, JSON.stringify(data), { ex: ttl });
  
  // 필요하면 Supabase에 영구 저장
  if (options.persistToDatabase) {
    await supabase.from('metrics').insert({
      key,
      data,
      timestamp: new Date().toISOString()
    });
  }
  
  return data;
}
```

## API 참조

### 서버 상태 API

**엔드포인트**: `/api/monitoring/servers`

**메소드**: GET

**쿼리 파라미터**:
- `serverId`: (선택) 특정 서버 ID

**응답**:
```json
{
  "servers": [
    {
      "id": "web-server-1",
      "name": "Web Server 1",
      "status": "healthy",
      "cpu": {
        "usage": 35.2,
        "cores": 4
      },
      "memory": {
        "total": 16384,
        "used": 8192,
        "usage": 50.0
      },
      "disk": {
        "total": 512000,
        "used": 256000,
        "usage": 50.0
      },
      "network": {
        "rx": 1024,
        "tx": 512,
        "connections": 245
      },
      "uptime": 1209600,
      "lastChecked": "2025-06-01T12:00:00Z"
    }
  ]
}
```

### 성능 로그 API

**엔드포인트**: `/api/monitoring/performance`

**메소드**: GET

**쿼리 파라미터**:
- `serverId`: (필수) 서버 ID
- `from`: (선택) ISO 시작 시간
- `to`: (선택) ISO 종료 시간
- `metric`: (선택) 특정 메트릭 (cpu, memory, disk, network)

**응답**:
```json
{
  "metrics": [
    {
      "timestamp": "2025-06-01T11:00:00Z",
      "cpu": 32.5,
      "memory": 48.2,
      "disk": 50.0,
      "network": {
        "rx": 980,
        "tx": 490
      }
    },
    {
      "timestamp": "2025-06-01T11:05:00Z",
      "cpu": 36.2,
      "memory": 49.1,
      "disk": 50.0,
      "network": {
        "rx": 1050,
        "tx": 520
      }
    }
  ]
}
```

## 사용 예시

### 대시보드에서 서버 목록 조회

```typescript
// src/app/dashboard/page.tsx
import { getServerStats } from '@/modules/monitoring/collectors/server-stats';

export default async function DashboardPage() {
  // 서버 데이터 가져오기
  const servers = await getServerStats();
  
  return (
    <div className="dashboard">
      <h1>서버 모니터링 대시보드</h1>
      <ServerList servers={servers} />
    </div>
  );
}
```

### 실시간 업데이트 구현

```typescript
// src/hooks/useServerStats.ts
import { useEffect, useState } from 'react';
import { ServerStats } from '@/types';

export function useServerStats(serverId?: string) {
  const [stats, setStats] = useState<ServerStats[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);
  
  useEffect(() => {
    const fetchStats = async () => {
      try {
        setIsLoading(true);
        const response = await fetch(`/api/monitoring/servers?serverId=${serverId || ''}`);
        const data = await response.json();
        setStats(data.servers);
      } catch (err) {
        setError(err instanceof Error ? err : new Error('Unknown error'));
      } finally {
        setIsLoading(false);
      }
    };
    
    // 초기 데이터 로드
    fetchStats();
    
    // 5초마다 업데이트
    const interval = setInterval(fetchStats, 5000);
    
    return () => clearInterval(interval);
  }, [serverId]);
  
  return { stats, isLoading, error };
}
```

## 최적화 기법

1. **데이터 캐싱 전략**
   - 고빈도 메트릭: 짧은 TTL (15-60초)
   - 저빈도 메트릭: 긴 TTL (5-15분)

2. **단계적 로딩**
   - 중요 메트릭 먼저 로드
   - 세부 정보는 요청 시 로드

3. **데이터 압축**
   - 시계열 데이터 압축 알고리즘 적용
   - 대용량 데이터 전송 시 gzip 압축

4. **스마트 폴링**
   - 활성 탭에서만 실시간 업데이트
   - 비활성 시 폴링 빈도 감소