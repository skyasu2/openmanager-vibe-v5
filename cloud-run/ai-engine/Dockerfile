# ============================================================================
# AI Engine - Cloud Run Service (Multi-stage Build)
# Optimized for Cloud Run cold start & minimal image size
#
# v4.0 - 2025-12-29 (Observability & Resilience)
# - Langfuse LLM Observability (1M spans/month free)
# - Circuit Breaker pattern for provider fault tolerance
# - streamText real-time token streaming
# - Graceful shutdown with trace flushing
# - Memory optimized for observability (450 → 480MB)
#
# v3.0 - 2025-12-28 (AI SDK Migration)
# - LangGraph → Vercel AI SDK v6 migration
# - Multi-stage build optimization maintained
#
# v2.2 - 2025-12-28 (Precomputed State)
# - Pre-built JSON for O(1) server state lookup
# - 69.8% token reduction (3076 → 930 chars)
#
# v2.0 - 2025-12-27 (RCA + Capacity Agents)
# - Added dumb-init for proper signal handling
# - Security hardening with non-root user
# ============================================================================

# Build arguments
ARG NODE_VERSION=22

# ============================================================================
# Stage 1: Dependencies (cached layer)
# ============================================================================
FROM node:${NODE_VERSION}-alpine AS deps

WORKDIR /app

# Install dumb-init for proper signal handling (PID 1 problem)
RUN apk add --no-cache dumb-init

# Copy package files first (maximize cache hit)
COPY package.json package-lock.json ./

# Install all dependencies (dev + prod) for build
# Note: Using npm install instead of npm ci due to lockfile sync issues in Cloud Build
RUN npm install --legacy-peer-deps --ignore-scripts

# ============================================================================
# Stage 2: Build
# ============================================================================
FROM node:${NODE_VERSION}-alpine AS builder

WORKDIR /app

# Copy deps from previous stage
COPY --from=deps /app/node_modules ./node_modules
COPY package.json tsconfig.json ./

# Copy entire source directory
COPY src/ ./src/

# Build TypeScript
RUN npm run build

# Prune dev dependencies after build
RUN npm prune --production --legacy-peer-deps

# ============================================================================
# Stage 3: Production (minimal)
# ============================================================================
FROM node:${NODE_VERSION}-alpine AS runner

# Get version from package.json at build time
ARG APP_VERSION=5.84.0
LABEL org.opencontainers.image.title="AI Engine"
LABEL org.opencontainers.image.version="${APP_VERSION}"
LABEL org.opencontainers.image.description="Multi-Agent AI Supervisor for OpenManager VIBE"
LABEL org.opencontainers.image.source="https://github.com/your-org/openmanager-vibe-v5"
LABEL org.opencontainers.image.created="2025-12-29"
LABEL ai.observability="langfuse"
LABEL ai.resilience="circuit-breaker"

WORKDIR /app

# Production environment
ENV NODE_ENV=production
ENV PORT=8080

# Cloud Run optimized Node.js settings
# - max-old-space-size: Limit memory (increased to 480MB for observability)
# - enable-source-maps: Better error traces in production
ENV NODE_OPTIONS="--max-old-space-size=480 --enable-source-maps"

# ============================================================================
# Required Environment Variables (set via Cloud Run / Secret Manager)
# ============================================================================
# AI Provider Keys (at least one required):
#   GOOGLE_GENERATIVE_AI_API_KEY, GROQ_API_KEY, CEREBRAS_API_KEY, etc.
#
# Observability (optional, enables Langfuse tracing):
#   LANGFUSE_SECRET_KEY, LANGFUSE_PUBLIC_KEY, LANGFUSE_BASE_URL
#
# Security:
#   CLOUD_RUN_API_SECRET (required for /api/* endpoints)
# ============================================================================

# Copy dumb-init from deps stage
COPY --from=deps /usr/bin/dumb-init /usr/bin/dumb-init

# Security: non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 appuser

# Copy only production dependencies from builder
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./

# Copy built files
COPY --from=builder /app/dist ./dist

# Copy pre-computed state JSON (O(1) lookup, fast cold start)
# This file is generated by scripts/build-precomputed-states.ts
COPY data/precomputed-states.json ./data/

# Set ownership and switch to non-root
RUN chown -R appuser:nodejs /app
USER appuser

# Health check (lightweight, using wget instead of curl for smaller image)
HEALTHCHECK --interval=30s --timeout=5s --start-period=15s --retries=2 \
    CMD wget -q --spider http://localhost:8080/health || exit 1

EXPOSE 8080

# Use dumb-init as entrypoint for proper signal handling
# - Forwards SIGTERM to node process
# - Ensures Langfuse traces are flushed before exit
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Direct node execution (fastest startup)
# Graceful shutdown: SIGTERM → flush Langfuse → exit
CMD ["node", "dist/server.js"]
