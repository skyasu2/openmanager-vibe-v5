# ============================================================================
# OpenManager VIBE - Local Docker Testing for Cloud Run AI Backend
# Usage: docker-compose up --build
# ============================================================================

services:
  ai-backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=development
      - PORT=8080
      # AI API Keys (load from .env.local or set directly)
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY}
      # Supabase (for checkpointer and RAG)
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_DIRECT_URL=${SUPABASE_DIRECT_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      # Cloud Run API Secret (for authentication testing)
      - CLOUD_RUN_API_SECRET=${CLOUD_RUN_API_SECRET}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ============================================================================
# Usage Instructions:
#
# 1. Copy environment variables:
#    cp ../../.env.local .env
#
# 2. Build and run:
#    docker-compose up --build
#
# 3. Test endpoints:
#    curl http://localhost:8080/health
#    curl http://localhost:8080/health/detailed
#
# 4. Test AI endpoint:
#    curl -X POST http://localhost:8080/api/ai/unified-stream \
#      -H "Content-Type: application/json" \
#      -H "X-API-Key: ${CLOUD_RUN_API_SECRET}" \
#      -d '{"messages":[{"role":"user","content":"서버 상태 분석해줘"}]}'
#
# 5. Stop:
#    docker-compose down
# ============================================================================
