# ============================================================================
# AI Engine - Local Development Docker Compose
#
# v3.0 - 2025-12-28 (AI SDK Migration Prep)
# - Added Cerebras, Mistral, Upstash environment variables
# - Added healthcheck configuration
# - Added volume mounts for hot reload development
# - Optimized for local testing before Cloud Run deployment
#
# Usage:
#   docker-compose up --build        # Build and run
#   docker-compose up -d             # Run in background
#   docker-compose logs -f ai-engine # View logs
#   docker-compose down              # Stop and remove
# ============================================================================

services:
  ai-engine:
    build:
      context: ./ai-engine
      dockerfile: Dockerfile
      args:
        - NODE_VERSION=22
        - APP_VERSION=5.83.12
    image: ai-engine:local
    container_name: ai-engine-local
    ports:
      - "8080:8080"

    environment:
      - NODE_ENV=development
      - PORT=8080

      # ============================================
      # API Authentication
      # ============================================
      - CLOUD_RUN_API_SECRET=${CLOUD_RUN_API_SECRET:-test-secret}

      # ============================================
      # LLM Provider API Keys
      # ============================================
      # Cerebras (Primary - Fast Inference)
      - CEREBRAS_API_KEY=${CEREBRAS_API_KEY}

      # Groq (Fallback)
      - GROQ_API_KEY=${GROQ_API_KEY}

      # Mistral (Verifier Agent)
      - MISTRAL_API_KEY=${MISTRAL_API_KEY}
      - MISTRAL_DEFAULT_MODEL=${MISTRAL_DEFAULT_MODEL:-mistral-small-2506}

      # Google/Gemini (Optional)
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GEMINI_API_KEY_SECONDARY=${GEMINI_API_KEY_SECONDARY}

      # ============================================
      # Upstash Redis (Job Queue & Caching)
      # ============================================
      - KV_REST_API_URL=${KV_REST_API_URL}
      - KV_REST_API_TOKEN=${KV_REST_API_TOKEN}
      # Alternative naming (for compatibility)
      - UPSTASH_REDIS_REST_URL=${KV_REST_API_URL}
      - UPSTASH_REDIS_REST_TOKEN=${KV_REST_API_TOKEN}

      # ============================================
      # Supabase Configuration
      # ============================================
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      # JSON config format (used by config-parser.ts)
      - SUPABASE_CONFIG=${SUPABASE_CONFIG:-}

      # ============================================
      # Tavily (Web Search)
      # ============================================
      - TAVILY_API_KEY=${TAVILY_API_KEY}

      # ============================================
      # Langfuse (Tracing - Optional)
      # ============================================
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_BASE_URL=${LANGFUSE_BASE_URL:-https://us.cloud.langfuse.com}

    # Health check matching Cloud Run configuration
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

    # Resource limits (matching Cloud Run 512MB)
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

    # Restart policy for development
    restart: unless-stopped

    networks:
      - vibe-network

networks:
  vibe-network:
    driver: bridge

# ============================================================================
# Development Override (docker-compose.override.yml)
# ============================================================================
# For local development with hot reload, create docker-compose.override.yml:
#
# services:
#   ai-engine:
#     build:
#       target: deps  # Stop at deps stage for faster builds
#     volumes:
#       - ./ai-engine/src:/app/src:ro
#       - ./ai-engine/data:/app/data:ro
#     command: ["npx", "tsx", "watch", "src/server.ts"]
#     environment:
#       - NODE_ENV=development
# ============================================================================
