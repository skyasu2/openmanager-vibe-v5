<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œì»¬ AI ìƒíƒœ í™•ì¸ (í™˜ê²½ë³€ìˆ˜ ìˆ˜ì • í›„)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status {
            padding: 10px 20px;
            border-radius: 25px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }

        .success {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .error {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }

        .warning {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #FFC107;
            color: #333;
        }

        .info {
            background: rgba(33, 150, 243, 0.3);
            border: 2px solid #2196F3;
        }

        button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .result-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        h1,
        h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        .url-display {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }

        .fix-status {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .env-status {
            background: rgba(59, 130, 246, 0.2);
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ  ë¡œì»¬ AI ìƒíƒœ í™•ì¸ (í™˜ê²½ë³€ìˆ˜ ìˆ˜ì • í›„)</h1>
        <div class="info status">
            <strong>ë¡œì»¬ ê°œë°œ ì„œë²„:</strong>
            <div class="url-display">http://localhost:3000</div>
        </div>

        <div class="env-status">
            <h3>ğŸ”§ í™˜ê²½ë³€ìˆ˜ ìˆ˜ì •ì‚¬í•­</h3>
            <ul>
                <li>âœ… NEXT_PUBLIC_SUPABASE_URL ì¶”ê°€</li>
                <li>âœ… NEXT_PUBLIC_SUPABASE_ANON_KEY ì¶”ê°€</li>
                <li>âœ… NODE_ENV=development ì„¤ì •</li>
                <li>âœ… ê°œë°œ ì„œë²„ ì¬ì‹œì‘ ì™„ë£Œ</li>
            </ul>
        </div>

        <div class="fix-status">
            <h3>ğŸ› ï¸ ì ìš©ëœ ìˆ˜ì •ì‚¬í•­</h3>
            <ul>
                <li>âœ… AI ì‚¬ì´ë“œë°” ìì—°ì–´ ì§ˆì˜ ë¼ìš°íŒ… ì¶©ëŒ í•´ê²°</li>
                <li>âœ… ëŒ€ì‹œë³´ë“œ ì„œë²„ ëª¨ë‹¬ ì•ˆì „ì„± ê°•í™” (safeServer ê°ì²´)</li>
                <li>âœ… ServerModalErrorBoundary ì¶”ê°€</li>
                <li>âœ… React Hooks ê·œì¹™ ì¤€ìˆ˜</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>ğŸš€ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</h2>
            <button onclick="runAllTests()">ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <div id="all-results" class="result-box"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ ê°œë³„ í…ŒìŠ¤íŠ¸</h2>
            <button onclick="testBasicHealth()">ê¸°ë³¸ í—¬ìŠ¤ì²´í¬</button>
            <button onclick="testSmartFallback()">Smart Fallback í…ŒìŠ¤íŠ¸</button>
            <button onclick="testLogsAPI()">ë¡œê·¸ API í…ŒìŠ¤íŠ¸</button>
            <button onclick="testStreamAPI()">ìŠ¤íŠ¸ë¦¼ API í…ŒìŠ¤íŠ¸</button>
            <div id="individual-results" class="result-box"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š ì¢…í•© ê²°ê³¼</h2>
            <div id="summary-result" class="result-box">í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3000';
        let testResults = {
            basic: null,
            smartFallback: null,
            logsAPI: null,
            streamAPI: null,
            overall: null
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            };
            element.innerHTML += `[${timestamp}] ${typeIcon[type]} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function runAllTests() {
            clearLog('all-results');
            log('all-results', 'ğŸš€ í™˜ê²½ë³€ìˆ˜ ìˆ˜ì • í›„ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');

            // 1. ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
            await testBasicHealthInternal('all-results');

            // 2. Smart Fallback API í…ŒìŠ¤íŠ¸
            await testSmartFallbackInternal('all-results');

            // 3. ë¡œê·¸ API í…ŒìŠ¤íŠ¸
            await testLogsAPIInternal('all-results');

            // 4. ìŠ¤íŠ¸ë¦¼ API í…ŒìŠ¤íŠ¸ (ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸ë§Œ)
            await testStreamAPIInternal('all-results');

            // ì „ì²´ ê²°ê³¼ í‰ê°€
            const successCount = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;
            testResults.overall = successCount === totalTests;

            log('all-results', `\nğŸ¯ ì „ì²´ í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${successCount}/${totalTests} ì„±ê³µ`,
                testResults.overall ? 'success' : 'warning');

            updateSummary();
        }

        async function testBasicHealthInternal(logId) {
            log(logId, '\nğŸ“¡ 1. ê¸°ë³¸ í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸', 'info');
            try {
                const response = await fetch(`${BASE_URL}/api/health`);
                if (response.ok) {
                    const data = await response.json();
                    log(logId, `âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ: ${JSON.stringify(data, null, 2)}`, 'success');
                    testResults.basic = true;
                } else {
                    log(logId, `âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: ${response.status} ${response.statusText}`, 'error');
                    testResults.basic = false;
                }
            } catch (error) {
                log(logId, `âŒ ê¸°ë³¸ ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
                testResults.basic = false;
            }
        }

        async function testSmartFallbackInternal(logId) {
            log(logId, '\nğŸ”§ 2. Smart Fallback API í…ŒìŠ¤íŠ¸', 'info');
            try {
                // GET ìš”ì²­ í…ŒìŠ¤íŠ¸
                log(logId, '  - GET ìš”ì²­ í…ŒìŠ¤íŠ¸', 'info');
                const getResponse = await fetch(`${BASE_URL}/api/ai/smart-fallback`);
                log(logId, `  GET ì‘ë‹µ: ${getResponse.status} ${getResponse.statusText}`,
                    getResponse.ok ? 'success' : 'warning');

                // POST ìš”ì²­ í…ŒìŠ¤íŠ¸
                log(logId, '  - POST ìš”ì²­ í…ŒìŠ¤íŠ¸', 'info');
                const postResponse = await fetch(`${BASE_URL}/api/ai/smart-fallback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: 'í™˜ê²½ë³€ìˆ˜ ìˆ˜ì • í›„ í…ŒìŠ¤íŠ¸: ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸',
                        context: 'dashboard'
                    })
                });

                if (postResponse.ok) {
                    const postData = await postResponse.json();
                    log(logId, `âœ… POST ì„±ê³µ: 405 ì˜¤ë¥˜ í•´ê²°ë¨!`, 'success');
                    log(logId, `  ì‘ë‹µ ìš”ì•½: ${postData.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}, ì—”ì§„: ${postData.engine}`, 'success');
                    testResults.smartFallback = true;
                } else {
                    const errorText = await postResponse.text();
                    log(logId, `âŒ POST ì‹¤íŒ¨: ${postResponse.status} ${postResponse.statusText}`, 'error');
                    log(logId, `  ì˜¤ë¥˜ ë‚´ìš©: ${errorText.substring(0, 200)}`, 'error');
                    testResults.smartFallback = false;
                }
            } catch (error) {
                log(logId, `âŒ Smart Fallback ì˜¤ë¥˜: ${error.message}`, 'error');
                testResults.smartFallback = false;
            }
        }

        async function testLogsAPIInternal(logId) {
            log(logId, '\nğŸ“‹ 3. ë¡œê·¸ API í…ŒìŠ¤íŠ¸', 'info');
            try {
                const response = await fetch(`${BASE_URL}/api/logs/recent?limit=10`);
                if (response.ok) {
                    const data = await response.json();
                    log(logId, `âœ… ë¡œê·¸ API ì„±ê³µ: ${data.data?.length || 0}ê°œ ë¡œê·¸`, 'success');
                    testResults.logsAPI = true;
                } else {
                    const errorText = await response.text();
                    log(logId, `âŒ ë¡œê·¸ API ì‹¤íŒ¨: ${response.status} ${response.statusText}`, 'error');
                    log(logId, `  ì˜¤ë¥˜ ë‚´ìš©: ${errorText.substring(0, 200)}`, 'error');
                    testResults.logsAPI = false;
                }
            } catch (error) {
                log(logId, `âŒ ë¡œê·¸ API ì˜¤ë¥˜: ${error.message}`, 'error');
                testResults.logsAPI = false;
            }
        }

        async function testStreamAPIInternal(logId) {
            log(logId, '\nğŸŒŠ 4. ìŠ¤íŠ¸ë¦¼ API ì—°ê²° í…ŒìŠ¤íŠ¸', 'info');
            try {
                // ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸ë§Œ ìˆ˜í–‰ (ì‹¤ì œ ìŠ¤íŠ¸ë¦¼ì€ í…ŒìŠ¤íŠ¸í•˜ì§€ ì•ŠìŒ)
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 3000); // 3ì´ˆ í›„ ì¤‘ë‹¨

                const response = await fetch(`${BASE_URL}/api/ai/logging/stream?mode=sidebar`, {
                    signal: controller.signal
                });

                if (response.ok) {
                    log(logId, `âœ… ìŠ¤íŠ¸ë¦¼ API ì—°ê²° ì„±ê³µ: ${response.status}`, 'success');
                    testResults.streamAPI = true;
                } else {
                    log(logId, `âŒ ìŠ¤íŠ¸ë¦¼ API ì—°ê²° ì‹¤íŒ¨: ${response.status} ${response.statusText}`, 'error');
                    testResults.streamAPI = false;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    log(logId, `âœ… ìŠ¤íŠ¸ë¦¼ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ (ì •ìƒ ì¤‘ë‹¨)`, 'success');
                    testResults.streamAPI = true;
                } else {
                    log(logId, `âŒ ìŠ¤íŠ¸ë¦¼ API ì˜¤ë¥˜: ${error.message}`, 'error');
                    testResults.streamAPI = false;
                }
            }
        }

        // ê°œë³„ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
        async function testBasicHealth() {
            clearLog('individual-results');
            await testBasicHealthInternal('individual-results');
        }

        async function testSmartFallback() {
            clearLog('individual-results');
            await testSmartFallbackInternal('individual-results');
        }

        async function testLogsAPI() {
            clearLog('individual-results');
            await testLogsAPIInternal('individual-results');
        }

        async function testStreamAPI() {
            clearLog('individual-results');
            await testStreamAPIInternal('individual-results');
        }

        function updateSummary() {
            const summaryElement = document.getElementById('summary-result');
            let summary = 'ğŸ“Š í™˜ê²½ë³€ìˆ˜ ìˆ˜ì • í›„ í…ŒìŠ¤íŠ¸ ê²°ê³¼\n\n';

            summary += `ğŸ”— ê¸°ë³¸ í—¬ìŠ¤ì²´í¬: ${testResults.basic === null ? 'ë¯¸ì‹¤í–‰' : testResults.basic ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'}\n`;
            summary += `ğŸ”§ Smart Fallback: ${testResults.smartFallback === null ? 'ë¯¸ì‹¤í–‰' : testResults.smartFallback ? 'âœ… ì •ìƒ' : 'âŒ ë¬¸ì œìˆìŒ'}\n`;
            summary += `ğŸ“‹ ë¡œê·¸ API: ${testResults.logsAPI === null ? 'ë¯¸ì‹¤í–‰' : testResults.logsAPI ? 'âœ… ì •ìƒ' : 'âŒ ë¬¸ì œìˆìŒ'}\n`;
            summary += `ğŸŒŠ ìŠ¤íŠ¸ë¦¼ API: ${testResults.streamAPI === null ? 'ë¯¸ì‹¤í–‰' : testResults.streamAPI ? 'âœ… ì •ìƒ' : 'âŒ ë¬¸ì œìˆìŒ'}\n\n`;

            if (testResults.overall === true) {
                summary += 'ğŸ‰ ëª¨ë“  APIê°€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!\n';
                summary += 'âœ… í™˜ê²½ë³€ìˆ˜ ë¬¸ì œ í•´ê²° ì™„ë£Œ\n';
                summary += 'âœ… AI ì‚¬ì´ë“œë°” ìì—°ì–´ ì§ˆì˜ ë¬¸ì œ í•´ê²°\n';
                summary += 'âœ… ëŒ€ì‹œë³´ë“œ ì„œë²„ ëª¨ë‹¬ ì•ˆì •ì„± ê°•í™”\n';
                summary += '\nğŸš€ ì´ì œ Vercelì— ì¬ë°°í¬í•˜ë©´ í”„ë¡œë•ì…˜ì—ì„œë„ ì •ìƒ ì‘ë™í•  ê²ƒì…ë‹ˆë‹¤.';
            } else if (testResults.overall === false) {
                summary += 'âš ï¸ ì¼ë¶€ APIì—ì„œ ì—¬ì „íˆ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.\n';
                summary += 'ğŸ” ê°œë³„ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ êµ¬ì²´ì ì¸ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                summary += 'â„¹ï¸ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ìˆ˜ì •ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.';
            }

            summaryElement.textContent = summary;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.onload = function () {
            log('summary-result', 'ğŸ  í™˜ê²½ë³€ìˆ˜ ìˆ˜ì • í›„ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ\n"ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'info');
        };
    </script>
</body>

</html>