<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 한글 인코딩 테스트 - OpenManager Vibe v5</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #4a5568;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f7fafc;
        }

        .test-section h3 {
            color: #2d3748;
            margin-top: 0;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 10px;
        }

        input,
        textarea,
        select,
        button {
            padding: 12px;
            margin: 5px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            width: auto;
            min-width: 150px;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .success {
            background: #f0fff4;
            border-left: 4px solid #38a169;
            color: #2f855a;
        }

        .error {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
            color: #c53030;
        }

        .info {
            background: #ebf8ff;
            border-left: 4px solid #3182ce;
            color: #2b6cb0;
        }

        .warning {
            background: #fffbeb;
            border-left: 4px solid #d69e2e;
            color: #b7791f;
        }

        .sample-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .sample-query {
            background: #edf2f7;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid #e2e8f0;
        }

        .sample-query:hover {
            background: #e2e8f0;
        }

        .encoding-status {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .status-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            flex: 1;
        }

        .status-ok {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-warning {
            background: #fefcbf;
            color: #744210;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #38a169);
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🔧 한글 인코딩 테스트</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            OpenManager Vibe v5의 한글 처리 시스템을 테스트하고 문제를 진단합니다.
        </p>

        <!-- 1. 기본 인코딩 테스트 -->
        <div class="test-section">
            <h3>📊 1. 기본 인코딩 상태 확인</h3>
            <p>시스템의 기본 한글 인코딩 상태를 확인합니다.</p>
            <button onclick="testBasicEncoding()">기본 인코딩 테스트</button>
            <div id="basic-result" class="result" style="display: none;"></div>
        </div>

        <!-- 2. 쿼리 처리 테스트 -->
        <div class="test-section">
            <h3>🔍 2. 한글 쿼리 처리 테스트</h3>
            <p>API 요청에서 한글 쿼리가 올바르게 처리되는지 확인합니다.</p>

            <div style="margin-bottom: 15px;">
                <label for="test-query">테스트 쿼리:</label>
                <input type="text" id="test-query" placeholder="한글 테스트 쿼리를 입력하세요" value="서버 상태 확인">
            </div>

            <div class="sample-queries">
                <div class="sample-query" onclick="setTestQuery('CPU 사용량 분석')">
                    📊 CPU 사용량 분석
                </div>
                <div class="sample-query" onclick="setTestQuery('메모리 부족 경고')">
                    ⚠️ 메모리 부족 경고
                </div>
                <div class="sample-query" onclick="setTestQuery('네트워크 연결 상태')">
                    🌐 네트워크 연결 상태
                </div>
                <div class="sample-query" onclick="setTestQuery('데이터베이스 성능 최적화')">
                    🗄️ 데이터베이스 성능 최적화
                </div>
            </div>

            <button onclick="testQueryProcessing()">쿼리 처리 테스트</button>
            <div id="query-result" class="result" style="display: none;"></div>
        </div>

        <!-- 3. AI 엔진 통합 테스트 -->
        <div class="test-section">
            <h3>🤖 3. AI 엔진 한글 처리 테스트</h3>
            <p>최적화된 AI 엔진에서 한글 쿼리가 올바르게 처리되는지 확인합니다.</p>

            <div style="margin-bottom: 15px;">
                <label for="ai-query">AI 테스트 쿼리:</label>
                <input type="text" id="ai-query" placeholder="AI 엔진 테스트용 한글 쿼리" value="메모리 사용량 분석">
            </div>

            <div style="margin-bottom: 15px;">
                <label for="ai-mode">AI 모드:</label>
                <select id="ai-mode">
                    <option value="AUTO">자동 모드</option>
                    <option value="INTERNAL">내부 엔진만</option>
                    <option value="GOOGLE_AI">Google AI</option>
                </select>
            </div>

            <button onclick="testAIEngineKorean()">AI 엔진 한글 테스트</button>
            <div id="ai-result" class="result" style="display: none;"></div>
        </div>

        <!-- 4. 종합 진단 -->
        <div class="test-section">
            <h3>🔬 4. 종합 진단 및 권장사항</h3>
            <p>모든 테스트 결과를 종합하여 문제점과 해결책을 제시합니다.</p>
            <button onclick="runComprehensiveTest()">종합 진단 실행</button>
            <div class="progress" id="comprehensive-progress" style="display: none;">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div id="comprehensive-result" class="result" style="display: none;"></div>
        </div>

        <!-- 5. 인코딩 상태 -->
        <div class="test-section">
            <h3>📋 5. 현재 인코딩 상태</h3>
            <div class="encoding-status">
                <div class="status-item status-ok" id="browser-status">
                    🌐 브라우저: UTF-8
                </div>
                <div class="status-item status-warning" id="server-status">
                    🖥️ 서버: 확인 중...
                </div>
                <div class="status-item status-warning" id="api-status">
                    🔗 API: 확인 중...
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let testResults = {
            basic: null,
            query: null,
            ai: null,
            comprehensive: null
        };

        // 테스트 쿼리 설정
        function setTestQuery(query) {
            document.getElementById('test-query').value = query;
        }

        // 1. 기본 인코딩 테스트
        async function testBasicEncoding() {
            const resultDiv = document.getElementById('basic-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔍 기본 인코딩 상태 확인 중...';

            try {
                const response = await fetch('/api/test-korean-encoding');
                const data = await response.json();

                if (data.success) {
                    testResults.basic = data;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ 기본 인코딩 테스트 성공

플랫폼: ${data.platform}
터미널 LANG: ${data.encoding.terminal.LANG || '설정되지 않음'}
터미널 LC_ALL: ${data.encoding.terminal.LC_ALL || '설정되지 않음'}

테스트 결과:
${data.encoding.tests.map(test =>
                        `${test.success ? '✅' : '❌'} ${test.name}: ${test.output}`
                    ).join('\n')}

샘플 한글:
- 기본: ${data.samples.korean}
- 혼합: ${data.samples.mixed}
- 특수: ${data.samples.special}
- 기술: ${data.samples.technical}

권장사항:
${data.recommendations.join('\n')}`;

                    updateServerStatus(data.encoding.overall ? 'ok' : 'error');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 기본 인코딩 테스트 실패: ${data.error}`;
                    updateServerStatus('error');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 네트워크 오류: ${error.message}`;
                updateServerStatus('error');
            }
        }

        // 2. 쿼리 처리 테스트
        async function testQueryProcessing() {
            const query = document.getElementById('test-query').value;
            const resultDiv = document.getElementById('query-result');

            if (!query.trim()) {
                alert('테스트 쿼리를 입력해주세요!');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔍 쿼리 처리 테스트 중...';

            try {
                const response = await fetch('/api/test-korean-encoding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify({
                        testQuery: query,
                        expectedResult: '정상 처리'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    testResults.query = data;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ 쿼리 처리 테스트 성공

입력 쿼리: "${data.input.testQuery}"
처리 결과: "${data.processing.processed}"

검증 결과:
- 한글 포함: ${data.validation.isKorean ? '예' : '아니오'}
- 깨진 문자: ${data.validation.isBroken ? '발견됨' : '없음'}
- 상태: ${data.validation.status}
- 길이: ${data.processing.length}자

응답 메시지: ${data.echo.message}
권장사항: ${data.echo.recommendation}`;

                    updateApiStatus(data.validation.status === '정상' ? 'ok' : 'error');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ 쿼리 처리 테스트 실패: ${data.error}`;
                    updateApiStatus('error');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 네트워크 오류: ${error.message}`;
                updateApiStatus('error');
            }
        }

        // 3. AI 엔진 한글 처리 테스트
        async function testAIEngineKorean() {
            const query = document.getElementById('ai-query').value;
            const mode = document.getElementById('ai-mode').value;
            const resultDiv = document.getElementById('ai-result');

            if (!query.trim()) {
                alert('AI 테스트 쿼리를 입력해주세요!');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = '🤖 AI 엔진 한글 처리 테스트 중...';

            try {
                const response = await fetch('/api/test-optimized-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify({
                        query: query,
                        mode: mode
                    })
                });

                const data = await response.json();

                if (data.success) {
                    testResults.ai = data;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ AI 엔진 한글 처리 성공

테스트 쿼리: "${data.testQuery}"
처리 모드: ${data.mode}
사용 엔진: ${data.result.engine}
처리 시간: ${data.result.processingTime}ms
신뢰도: ${data.result.confidence}%

AI 응답:
${data.result.response || '응답 데이터 없음'}

엔진 통계:
- 총 쿼리: ${data.stats.totalQueries}
- 성공률: ${((data.stats.successfulQueries / data.stats.totalQueries) * 100).toFixed(1)}%
- 평균 응답시간: ${data.stats.averageResponseTime}ms

메타데이터:
- 총 엔진 수: ${data.result.metadata?.totalEngines || 'N/A'}
- 활성 엔진: ${data.result.metadata?.activeEngines?.join(', ') || 'N/A'}`;

                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ AI 엔진 테스트 실패: ${data.error}
                    
세부사항: ${data.details || '없음'}
처리 시간: ${data.processingTime || 'N/A'}ms`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 네트워크 오류: ${error.message}`;
            }
        }

        // 4. 종합 진단
        async function runComprehensiveTest() {
            const resultDiv = document.getElementById('comprehensive-result');
            const progressDiv = document.getElementById('comprehensive-progress');
            const progressBar = document.getElementById('progress-bar');

            resultDiv.style.display = 'none';
            progressDiv.style.display = 'block';

            // 진행률 애니메이션
            let progress = 0;
            const interval = setInterval(() => {
                progress += 2;
                progressBar.style.width = progress + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 50);

            try {
                // 모든 테스트 순차 실행
                await testBasicEncoding();
                await new Promise(resolve => setTimeout(resolve, 500));

                await testQueryProcessing();
                await new Promise(resolve => setTimeout(resolve, 500));

                await testAIEngineKorean();
                await new Promise(resolve => setTimeout(resolve, 500));

                // 종합 결과 분석
                const issues = [];
                const successes = [];

                if (testResults.basic?.success) {
                    successes.push('✅ 기본 인코딩 시스템 정상');
                } else {
                    issues.push('❌ 기본 인코딩 시스템 문제');
                }

                if (testResults.query?.success) {
                    successes.push('✅ API 쿼리 처리 정상');
                } else {
                    issues.push('❌ API 쿼리 처리 문제');
                }

                if (testResults.ai?.success) {
                    successes.push('✅ AI 엔진 한글 처리 정상');
                } else {
                    issues.push('❌ AI 엔진 한글 처리 문제');
                }

                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';

                if (issues.length === 0) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `🎉 종합 진단 완료 - 모든 시스템 정상!

${successes.join('\n')}

🚀 권장사항:
- 현재 한글 인코딩 시스템이 완벽하게 작동하고 있습니다
- 정기적인 모니터링을 통해 상태를 유지하세요
- 새로운 기능 추가 시에도 한글 처리를 고려하세요

📊 성능 요약:
- 기본 인코딩: ${testResults.basic?.encoding?.overall ? '정상' : '문제'}
- 쿼리 처리: ${testResults.query?.validation?.status || '확인 필요'}
- AI 엔진: ${testResults.ai?.success ? '정상' : '문제'}`;

                } else {
                    resultDiv.className = 'result warning';
                    resultDiv.textContent = `⚠️ 종합 진단 완료 - 일부 문제 발견

✅ 정상 기능:
${successes.join('\n')}

❌ 문제 발견:
${issues.join('\n')}

🔧 해결 방법:
1. 터미널 인코딩 설정: export LANG=ko_KR.UTF-8
2. 환경변수 확인: .env.local 파일의 UTF-8 설정
3. 브라우저 인코딩: 개발자 도구에서 UTF-8 확인
4. 서버 재시작: npm run dev로 개발 서버 재시작

📞 추가 지원이 필요한 경우:
- 개발팀에 문의하여 상세 진단을 받으세요
- 로그 파일을 확인하여 구체적인 오류를 찾으세요`;
                }

            } catch (error) {
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ 종합 진단 실패: ${error.message}`;
            }
        }

        // 상태 업데이트 함수들
        function updateServerStatus(status) {
            const element = document.getElementById('server-status');
            element.className = `status-item status-${status}`;
            element.textContent = `🖥️ 서버: ${status === 'ok' ? '정상' : status === 'warning' ? '경고' : '오류'}`;
        }

        function updateApiStatus(status) {
            const element = document.getElementById('api-status');
            element.className = `status-item status-${status}`;
            element.textContent = `🔗 API: ${status === 'ok' ? '정상' : status === 'warning' ? '경고' : '오류'}`;
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🔧 한글 인코딩 테스트 페이지 로드 완료');

            // 브라우저 인코딩 확인
            const charset = document.characterSet || document.charset;
            if (charset.toLowerCase() === 'utf-8') {
                document.getElementById('browser-status').className = 'status-item status-ok';
                document.getElementById('browser-status').textContent = '🌐 브라우저: UTF-8 ✓';
            }
        });
    </script>
</body>

</html>