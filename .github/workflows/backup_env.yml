name: Backup and Encrypt Environment Variables

on:
  workflow_dispatch:  # 수동 실행을 위해
  push:
    branches: [ main ]
    paths:
      - '.env.local'
  schedule:
    # 매일 자정에 자동 백업 (UTC 기준)
    - cron: '0 0 * * *'

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up OpenSSL
      run: |
        sudo apt-get update
        sudo apt-get install -y openssl
        openssl version

    - name: Create backup directory
      run: mkdir -p .backup

    - name: Encrypt .env.local
      run: |
        TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
        openssl enc -aes-256-cbc -salt \
          -in .env.local \
          -out .backup/env.backup.${TIMESTAMP}.enc \
          -pass pass:${{ secrets.ENV_BACKUP_PASSWORD }}

    - name: Commit and push backup
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        git add .backup/
        git diff --quiet && git diff --staged --quiet || \
          (git commit -m "🔒 Auto-backup encrypted .env.local" && \
           git push origin HEAD:main)
