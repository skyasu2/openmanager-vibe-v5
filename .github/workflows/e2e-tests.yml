name: ğŸ¤– E2E Tests - OpenManager VIBE

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC) - í•œêµ­ì‹œê°„ ì˜¤í›„ 6ì‹œ
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      test_category:
        description: 'í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - basic
          - ai
          - performance
          - visual
          - accessibility
      browser:
        description: 'ë¸Œë¼ìš°ì € ì„ íƒ'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
      headless:
        description: 'Headless ëª¨ë“œ'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '22.x'
  NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
  CI: true

jobs:
  # ğŸ”§ ê¸°ë³¸ ì„¤ì • ë° ì¢…ì†ì„± ì„¤ì¹˜
  setup:
    name: ğŸ”§ Setup & Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
      
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Cache Dependencies
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-deps-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-
            
      - name: ğŸ“¥ Install Dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          npm ci
          npx playwright install chromium firefox webkit
          npx playwright install-deps
          
      - name: ğŸ” Verify Installation
        run: |
          npm --version
          node --version
          npx playwright --version

  # ğŸ—ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-deps-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸ—ï¸ Build Next.js Application
        run: |
          npm run build
          npm run type-check
          
      - name: ğŸ“ Cache Build
        uses: actions/cache@v4
        with:
          path: .next
          key: ${{ runner.os }}-build-${{ github.sha }}

  # ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê¸°ë³¸)
  e2e-basic:
    name: ğŸ§ª E2E Basic Tests
    runs-on: ubuntu-latest
    needs: [setup, build]
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]
        
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies & Build
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
            .next
          key: ${{ runner.os }}-deps-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸš€ Start Development Server
        run: |
          npm run dev &
          sleep 15
          curl -f http://localhost:3000 || exit 1
          
      - name: ğŸ§ª Run Basic E2E Tests
        run: |
          npm run test:e2e -- \
            --project=${{ matrix.browser }} \
            --reporter=json,github \
            --output-dir=test-results-basic \
            tests/e2e/comprehensive-ui-ux-test.spec.ts \
            tests/e2e/admin-mode-improved.spec.ts
            
      - name: ğŸ“„ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-basic-results-${{ matrix.browser }}
          path: |
            test-results-basic/
            playwright-report/
          retention-days: 7

  # ğŸ¤– AI ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
  e2e-ai:
    name: ğŸ¤– E2E AI Tests
    runs-on: ubuntu-latest
    needs: [setup, build]
    timeout-minutes: 25
    if: ${{ github.event.inputs.test_category == 'ai' || github.event.inputs.test_category == 'all' || github.event_name != 'workflow_dispatch' }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies & Build
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
            .next
          key: ${{ runner.os }}-deps-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸš€ Start Development Server
        run: |
          npm run dev &
          sleep 20
          curl -f http://localhost:3000 || exit 1
          
      - name: ğŸ¤– Run AI Assistant Tests
        run: |
          npm run test:e2e -- \
            --project=chromium \
            --reporter=json,github \
            --output-dir=test-results-ai \
            tests/e2e/ai-assistant-advanced-test.spec.ts
            
      - name: ğŸ“„ Upload AI Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-ai-results
          path: |
            test-results-ai/
            playwright-report/
          retention-days: 7

  # âš¡ ì„±ëŠ¥ ë° ì‹œê°ì  íšŒê·€ í…ŒìŠ¤íŠ¸
  e2e-performance:
    name: âš¡ E2E Performance Tests
    runs-on: ubuntu-latest
    needs: [setup, build]
    timeout-minutes: 30
    if: ${{ github.event.inputs.test_category == 'performance' || github.event.inputs.test_category == 'visual' || github.event.inputs.test_category == 'all' || github.event_name == 'schedule' }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Restore Dependencies & Build
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
            .next
          key: ${{ runner.os }}-deps-${{ hashFiles('package-lock.json') }}
          
      - name: ğŸš€ Start Production Server
        run: |
          npm run start &
          sleep 20
          curl -f http://localhost:3000 || exit 1
          
      - name: âš¡ Run Performance Tests
        run: |
          npm run test:e2e -- \
            --project=chromium \
            --reporter=json,github \
            --output-dir=test-results-performance \
            tests/e2e/performance-visual-regression.spec.ts
            
      - name: ğŸ“Š Generate Lighthouse Report
        run: |
          npm install -g @lhci/cli
          lhci collect --url=http://localhost:3000 --output-dir=lighthouse-results
          
      - name: ğŸ“„ Upload Performance Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-performance-results
          path: |
            test-results-performance/
            lighthouse-results/
            playwright-report/
          retention-days: 14

  # ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ í†µí•© ë° ë¦¬í¬íŠ¸ ìƒì„±
  test-report:
    name: ğŸ“Š Generate Test Report
    runs-on: ubuntu-latest
    needs: [e2e-basic, e2e-ai, e2e-performance]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download All Test Results
        uses: actions/download-artifact@v4
        with:
          path: all-test-results/
          
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“Š Generate Comprehensive Report
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìˆ˜ì§‘
          const resultsDir = './all-test-results';
          const categories = fs.readdirSync(resultsDir);
          
          let totalTests = 0;
          let totalPassed = 0;
          let totalFailed = 0;
          
          const report = {
            timestamp: new Date().toISOString(),
            categories: [],
            summary: {}
          };
          
          categories.forEach(category => {
            const categoryPath = path.join(resultsDir, category);
            if (fs.statSync(categoryPath).isDirectory()) {
              console.log('ğŸ“‚ Processing:', category);
              
              // JSON ê²°ê³¼ íŒŒì¼ ì°¾ê¸°
              const files = fs.readdirSync(categoryPath);
              const jsonFile = files.find(f => f.endsWith('.json'));
              
              if (jsonFile) {
                try {
                  const data = JSON.parse(fs.readFileSync(path.join(categoryPath, jsonFile)));
                  // ê²°ê³¼ ë¶„ì„ ë¡œì§
                  report.categories.push({
                    name: category,
                    results: 'processed'
                  });
                } catch (e) {
                  console.warn('Failed to parse:', jsonFile);
                }
              }
            }
          });
          
          // GitHub Step Summary ìƒì„±
          const summary = \`
          ## ğŸ¤– OpenManager VIBE E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼
          
          ### ğŸ“Š í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìš”ì•½
          - **ì‹¤í–‰ ì‹œê°„**: \${new Date().toLocaleString('ko-KR')}
          - **ë¸Œëœì¹˜**: \${process.env.GITHUB_REF_NAME || 'unknown'}
          - **ì»¤ë°‹**: \${process.env.GITHUB_SHA?.substring(0, 7) || 'unknown'}
          
          ### ğŸ“‹ ì¹´í…Œê³ ë¦¬ë³„ ê²°ê³¼
          \${report.categories.map(cat => \`- \${cat.name}: âœ… ì™„ë£Œ\`).join('\\n')}
          
          ### ğŸ”— ìƒì„¸ ê²°ê³¼
          - [Playwright HTML Report](https://github.com/\${process.env.GITHUB_REPOSITORY}/actions/runs/\${process.env.GITHUB_RUN_ID})
          - [Performance Report](https://github.com/\${process.env.GITHUB_REPOSITORY}/actions/runs/\${process.env.GITHUB_RUN_ID})
          \`;
          
          if (process.env.GITHUB_STEP_SUMMARY) {
            fs.writeFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
          }
          
          console.log('âœ… í†µí•© ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ');
          "
          
      - name: ğŸ“„ Create Summary Comment (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## ğŸ¤– E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼
            
            âœ… **ëª¨ë“  E2E í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**
            
            - ğŸ§ª ê¸°ë³¸ UI/UX í…ŒìŠ¤íŠ¸: ì™„ë£Œ
            - ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸ í…ŒìŠ¤íŠ¸: ì™„ë£Œ  
            - âš¡ ì„±ëŠ¥ ë° ì‹œê°ì  íšŒê·€ í…ŒìŠ¤íŠ¸: ì™„ë£Œ
            
            **ì‹¤í–‰ ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}
            **í…ŒìŠ¤íŠ¸ í™˜ê²½**: Ubuntu Latest + Node.js 22.x
            
            ìƒì„¸ ê²°ê³¼ëŠ” [Actions íƒ­](${context.payload.pull_request.html_url}/checks)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # ğŸš¨ ì‹¤íŒ¨ ì•Œë¦¼
  notify-failure:
    name: ğŸš¨ Notify Test Failures
    runs-on: ubuntu-latest
    needs: [e2e-basic, e2e-ai, e2e-performance]
    if: failure() && (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: ğŸš¨ Create Issue for Test Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ${new Date().toLocaleString('ko-KR')}`;
            const body = `
            ## ğŸš¨ E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë³´ê³ 
            
            **ë¸Œëœì¹˜**: ${context.ref}
            **ì»¤ë°‹**: ${context.sha.substring(0, 7)}
            **ì‹¤í–‰ ì‹œê°„**: ${new Date().toISOString()}
            
            ### ğŸ“‹ ì‹¤íŒ¨í•œ ì‘ì—…
            ${'${{ needs.e2e-basic.result }}' !== 'success' ? '- âŒ Basic E2E Tests' : ''}
            ${'${{ needs.e2e-ai.result }}' !== 'success' ? '- âŒ AI Assistant Tests' : ''}
            ${'${{ needs.e2e-performance.result }}' !== 'success' ? '- âŒ Performance Tests' : ''}
            
            ### ğŸ”— ë§í¬
            - [ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [ì»¤ë°‹ ìƒì„¸](${context.payload.repository.html_url}/commit/${context.sha})
            
            ### ğŸ› ï¸ ëŒ€ì‘ ë°©ì•ˆ
            1. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì›ì¸ íŒŒì•…
            2. í…ŒìŠ¤íŠ¸ í™˜ê²½ ë° ì„¤ì • ê²€í† 
            3. ì½”ë“œ ë³€ê²½ì‚¬í•­ì´ í…ŒìŠ¤íŠ¸ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ë¶„ì„
            4. í•„ìš”ì‹œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì—…ë°ì´íŠ¸
            
            ì´ ì´ìŠˆëŠ” í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•˜ë©´ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.
            `;
            
            // ê¸°ì¡´ ì—´ë¦° ì´ìŠˆ í™•ì¸
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['e2e-test-failure'],
              state: 'open'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['e2e-test-failure', 'bug', 'high-priority']
              });
            }

  # âœ… ì„±ê³µ ì‹œ ì´ìŠˆ ìë™ ë‹«ê¸°
  close-failure-issues:
    name: âœ… Close Failure Issues
    runs-on: ubuntu-latest
    needs: [e2e-basic, e2e-ai, e2e-performance]
    if: success() && (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: âœ… Close E2E Failure Issues
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['e2e-test-failure'],
              state: 'open'
            });
            
            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âœ… E2E í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ ë‹«ìŠµë‹ˆë‹¤.\n\n**í•´ê²° ì»¤ë°‹**: ${context.sha.substring(0, 7)}`
              });
            }