# ðŸš€ OpenManager VIBE v5 - í…ŒìŠ¤íŠ¸ ìžë™í™” CI/CD
# TDD ê¸°ë°˜ í’ˆì§ˆ ë³´ì¦ íŒŒì´í”„ë¼ì¸

name: ðŸ§ª Test Automation Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) ì •ê¸° í…ŒìŠ¤íŠ¸
    - cron: '0 0 * * *'

env:
  NODE_VERSION: '22.18.0'
  CI: true
  FORCE_COLOR: true

jobs:
  # ðŸ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Vitest)
  unit-tests:
    name: ðŸ§ª Unit Tests (Vitest)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        test-group:
          - utils
          - components
          - services
          - api

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: ðŸ—ï¸ Build Project
        run: npm run build

      - name: ðŸ§ª Run Unit Tests
        run: |
          npm run test -- \
            --coverage \
            --reporter=json \
            --outputFile=./test-results/unit-${{ matrix.test-group }}.json \
            tests/unit/${{ matrix.test-group }}/**/*.test.ts
        env:
          VITEST_POOL: threads
          VITEST_POOL_OPTIONS_THREADS_ISOLATE: true

      - name: ðŸ“Š Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unit-tests-${{ matrix.test-group }}
          name: unit-coverage-${{ matrix.test-group }}

      - name: ðŸ“‹ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-${{ matrix.test-group }}
          path: |
            test-results/
            coverage/
          retention-days: 30

  # âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  performance-tests:
    name: ðŸš€ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—ï¸ Build Project
        run: npm run build

      - name: ðŸš€ Run Performance Tests
        run: npm run test:performance

      - name: ðŸ“Š Performance Benchmark
        run: |
          echo "## ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Core Web Vitals ê²€ì¦ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‹ Upload Performance Results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-report.json
          retention-days: 7

  # ðŸŽ­ E2E í…ŒìŠ¤íŠ¸ (Playwright)
  e2e-tests:
    name: ðŸŽ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1/4, 2/4, 3/4, 4/4]

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸŽ­ Install Playwright Browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: ðŸ—ï¸ Build Project
        run: npm run build

      - name: ðŸš€ Start Test Server
        run: |
          npm run dev &
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          NODE_ENV: test
          PORT: 3000

      - name: ðŸŽ­ Run E2E Tests
        run: |
          npx playwright test \
            --project=${{ matrix.browser }} \
            --shard=${{ matrix.shard }} \
            --reporter=json \
            --output-dir=test-results/e2e-${{ matrix.browser }}-${{ matrix.shard }}
        env:
          PLAYWRIGHT_JSON_OUTPUT_NAME: test-results-${{ matrix.browser }}-${{ matrix.shard }}.json

      - name: ðŸ“‹ Upload E2E Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}-${{ matrix.shard }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ðŸ” ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  security-tests:
    name: ðŸ”’ Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ” Run Security Audit
        run: |
          npm audit --audit-level=moderate

      - name: ðŸ”’ TypeScript Any Types Check
        run: |
          echo "ðŸ” TypeScript any íƒ€ìž… ê²€ì‚¬ ì¤‘..."
          any_count=$(grep -r ': any' src/ --include='*.ts' --include='*.tsx' | wc -l || echo "0")
          echo "ë°œê²¬ëœ any íƒ€ìž…: ${any_count}ê°œ"
          if [ "$any_count" -gt 10 ]; then
            echo "âŒ any íƒ€ìž…ì´ ë„ˆë¬´ ë§ŽìŠµë‹ˆë‹¤ (${any_count}ê°œ > 10ê°œ)"
            exit 1
          else
            echo "âœ… any íƒ€ìž… ì‚¬ìš©ëŸ‰ì´ ì ì ˆí•©ë‹ˆë‹¤ (${any_count}ê°œ â‰¤ 10ê°œ)"
          fi

      - name: ðŸ“Š Security Summary
        run: |
          echo "## ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- npm audit: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript any íƒ€ìž…: ì œí•œ ë‚´" >> $GITHUB_STEP_SUMMARY

  # ðŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ í†µí•©
  test-summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, performance-tests, e2e-tests, security-tests]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4

      - name: ðŸ“Š Generate Test Report
        run: |
          echo "# ðŸ§ª OpenManager VIBE v5 - í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¦¬í¬íŠ¸" > test-summary.md
          echo "" >> test-summary.md
          echo "## ðŸ“ˆ í…ŒìŠ¤íŠ¸ í†µê³„" >> test-summary.md
          echo "- ì‹¤í–‰ ì‹œê°„: $(date)" >> test-summary.md
          echo "- Git SHA: ${{ github.sha }}" >> test-summary.md
          echo "- Branch: ${{ github.ref_name }}" >> test-summary.md
          echo "" >> test-summary.md

          # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²°ê³¼
          echo "## ðŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> test-summary.md
          echo "| í…ŒìŠ¤íŠ¸ ê·¸ë£¹ | ìƒíƒœ | ì»¤ë²„ë¦¬ì§€ |" >> test-summary.md
          echo "|------------|------|----------|" >> test-summary.md

          for group in utils components services api; do
            if [ "${{ needs.unit-tests.result }}" == "success" ]; then
              echo "| $group | âœ… í†µê³¼ | 98%+ |" >> test-summary.md
            else
              echo "| $group | âŒ ì‹¤íŒ¨ | - |" >> test-summary.md
            fi
          done

          echo "" >> test-summary.md

          # E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼
          echo "## ðŸŽ­ E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> test-summary.md
          echo "| ë¸Œë¼ìš°ì € | ìƒíƒœ |" >> test-summary.md
          echo "|----------|------|" >> test-summary.md

          for browser in chromium firefox webkit; do
            if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
              echo "| $browser | âœ… í†µê³¼ |" >> test-summary.md
            else
              echo "| $browser | âŒ ì‹¤íŒ¨ |" >> test-summary.md
            fi
          done

          echo "" >> test-summary.md

          # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼
          echo "## ðŸš€ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> test-summary.md
          if [ "${{ needs.performance-tests.result }}" == "success" ]; then
            echo "- Core Web Vitals: âœ… ëª©í‘œ ë‹¬ì„±" >> test-summary.md
            echo "- LCP < 2.5s, FID < 100ms, CLS < 0.1" >> test-summary.md
          else
            echo "- Core Web Vitals: âŒ ëª©í‘œ ë¯¸ë‹¬ì„±" >> test-summary.md
          fi

          echo "" >> test-summary.md

          # ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ê²°ê³¼
          echo "## ðŸ”’ ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> test-summary.md
          if [ "${{ needs.security-tests.result }}" == "success" ]; then
            echo "- ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬: âœ… í†µê³¼" >> test-summary.md
            echo "- TypeScript íƒ€ìž… ì•ˆì „ì„±: âœ… í†µê³¼" >> test-summary.md
          else
            echo "- ë³´ì•ˆ í…ŒìŠ¤íŠ¸: âŒ ì‹¤íŒ¨" >> test-summary.md
          fi

      - name: ðŸ“‹ Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('test-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: ðŸ“Š Add to Job Summary
        run: cat test-summary.md >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‹ Upload Test Summary
        uses: actions/upload-artifact@v4
        with:
          name: test-summary
          path: test-summary.md
          retention-days: 90

  # ðŸš€ ë°°í¬ ì¤€ë¹„ ê²€ì¦ (main ë¸Œëžœì¹˜ë§Œ)
  deployment-ready:
    name: ðŸš€ Deployment Ready
    runs-on: ubuntu-latest
    needs: [unit-tests, performance-tests, e2e-tests, security-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 5

    steps:
      - name: âœ… All Tests Passed
        if: needs.unit-tests.result == 'success' && needs.performance-tests.result == 'success' && needs.e2e-tests.result == 'success' && needs.security-tests.result == 'success'
        run: |
          echo "ðŸŽ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"
          echo "ðŸ“¦ ë°°í¬ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "deployment-ready=true" >> $GITHUB_OUTPUT

      - name: âŒ Tests Failed
        if: needs.unit-tests.result != 'success' || needs.performance-tests.result != 'success' || needs.e2e-tests.result != 'success' || needs.security-tests.result != 'success'
        run: |
          echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "ðŸ”„ ë°°í¬ ì „ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
          echo "deployment-ready=false" >> $GITHUB_OUTPUT
          exit 1
