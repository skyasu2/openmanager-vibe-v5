name: Lighthouse Performance Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # ì£¼ê°„ ì •ê¸° ì‹¤í–‰ (ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ KST)
  schedule:
    - cron: '0 0 * * 1'

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            .npmrc

      - name: Install Dependencies (429 Error Resilient)
        run: |
          echo "ğŸ“¦ Lighthouse NPM ì˜ì¡´ì„± ì„¤ì¹˜..."
          
          # Lighthouseìš© retry ë¡œì§
          for attempt in 1 2; do
            echo "ğŸ”„ NPM CI ì‹œë„ $attempt/2..."
            
            if timeout 400 npm ci; then  # 7ë¶„ íƒ€ì„ì•„ì›ƒ (Lighthouse í™˜ê²½)
              echo "âœ… NPM CI ì„±ê³µ!"
              break
            else
              if [ $attempt -eq 2 ]; then
                echo "âŒ NPM CI ìµœì¢… ì‹¤íŒ¨ - Lighthouse ìŠ¤í‚µ"
                exit 1
              else
                echo "â° 25ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                sleep 25
                npm cache clean --force || true
              fi
            fi
          done

      - name: Wait for Vercel Deployment
        id: vercel-deployment
        run: |
          echo "Waiting for Vercel deployment..."
          # Vercel ë°°í¬ ì™„ë£Œ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
          timeout 600 bash -c '
            until curl -sf https://openmanager-vibe-v5.vercel.app > /dev/null; do
              echo "Waiting for deployment..."
              sleep 30
            done
          '
          echo "deployment_url=https://openmanager-vibe-v5.vercel.app" >> $GITHUB_OUTPUT

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI with Regression Detection
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          echo "ğŸš€ Lighthouse CI ì‹œì‘ - Phase 1 ì™„ë£Œ ê²€ì¦"
          echo "ğŸ“Š Box-Muller Transform ìºì‹œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í¬í•¨"
          
          # ğŸ¯ ì„¤ì • íŒŒì¼ í™•ì¸
          if [ -f lighthouserc.js ]; then
            echo "âœ… Lighthouse ì„¤ì • íŒŒì¼ ë°œê²¬"
          else
            echo "âŒ Lighthouse ì„¤ì • íŒŒì¼ ëˆ„ë½"
            exit 1
          fi
          
          # ğŸ“ˆ ì„±ëŠ¥ ê°ì‚¬ ì‹¤í–‰ (3íšŒ í‰ê· )
          lhci collect --url=${{ steps.vercel-deployment.outputs.deployment_url }}
          
          # ğŸ” íšŒê·€ ê°ì§€ ë° ì—…ë¡œë“œ
          lhci assert --preset=lighthouse:recommended
          lhci upload
          
          echo "âœ… Lighthouse CI ì™„ë£Œ"

      - name: Performance Regression Analysis
        id: regression-check
        run: |
          echo "ğŸ” Phase 1 ì„±ëŠ¥ íšŒê·€ ê°ì§€ ë¶„ì„ ì‹œì‘"
          echo "ğŸ“Š Box-Muller Transform ìºì‹œ ìµœì í™” íš¨ê³¼ ê²€ì¦"
          
          # ğŸ“ˆ Lighthouse ê²°ê³¼ ë¶„ì„
          RESULTS_PATH=".lighthouseci"
          if [ -d "$RESULTS_PATH" ]; then
            echo "âœ… Lighthouse ê²°ê³¼ ë°œê²¬"
            
            # ğŸ¯ ì„±ëŠ¥ ì ìˆ˜ ì¶”ì¶œ (JSON íŒŒì‹±)
            PERF_SCORES=$(find $RESULTS_PATH -name "lhr-*.json" -exec jq -r '.categories.performance.score * 100' {} \; 2>/dev/null || echo "0")
            AVG_SCORE=$(echo "$PERF_SCORES" | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print 0}')
            
            # ğŸ“Š Core Web Vitals ì¶”ì¶œ
            LCP_VALUES=$(find $RESULTS_PATH -name "lhr-*.json" -exec jq -r '.audits."largest-contentful-paint".numericValue' {} \; 2>/dev/null || echo "0")
            CLS_VALUES=$(find $RESULTS_PATH -name "lhr-*.json" -exec jq -r '.audits."cumulative-layout-shift".numericValue' {} \; 2>/dev/null || echo "0")
            FCP_VALUES=$(find $RESULTS_PATH -name "lhr-*.json" -exec jq -r '.audits."first-contentful-paint".numericValue' {} \; 2>/dev/null || echo "0")
            
            AVG_LCP=$(echo "$LCP_VALUES" | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print 0}')
            AVG_CLS=$(echo "$CLS_VALUES" | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print 0}')
            AVG_FCP=$(echo "$FCP_VALUES" | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print 0}')
            
            # ğŸš¨ íšŒê·€ ê°ì§€ ë¡œì§
            REGRESSION_DETECTED=false
            
            # Performance Score ì„ê³„ê°’ ì²´í¬ (< 90)
            if (( $(echo "$AVG_SCORE < 90" | bc -l 2>/dev/null || echo 0) )); then
              echo "âŒ ì„±ëŠ¥ ì ìˆ˜ íšŒê·€ ê°ì§€: $AVG_SCORE < 90"
              REGRESSION_DETECTED=true
            fi
            
            # LCP ì„ê³„ê°’ ì²´í¬ (> 2500ms)
            if (( $(echo "$AVG_LCP > 2500" | bc -l 2>/dev/null || echo 0) )); then
              echo "âŒ LCP íšŒê·€ ê°ì§€: ${AVG_LCP}ms > 2500ms"
              REGRESSION_DETECTED=true
            fi
            
            # CLS ì„ê³„ê°’ ì²´í¬ (> 0.1)
            if (( $(echo "$AVG_CLS > 0.1" | bc -l 2>/dev/null || echo 0) )); then
              echo "âŒ CLS íšŒê·€ ê°ì§€: $AVG_CLS > 0.1"
              REGRESSION_DETECTED=true
            fi
            
            # FCP ì„ê³„ê°’ ì²´í¬ (> 1800ms)
            if (( $(echo "$AVG_FCP > 1800" | bc -l 2>/dev/null || echo 0) )); then
              echo "âŒ FCP íšŒê·€ ê°ì§€: ${AVG_FCP}ms > 1800ms"
              REGRESSION_DETECTED=true
            fi
            
            # ğŸ“‹ ê²°ê³¼ ìš”ì•½ ìƒì„±
            echo "## ğŸš€ Phase 1 Lighthouse ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“Š Box-Muller Transform ìºì‹œ ìµœì í™” ê²€ì¦" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| ë©”íŠ¸ë¦­ | í‰ê· ê°’ | ëª©í‘œê°’ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|--------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| Performance Score | ${AVG_SCORE}% | â‰¥90% | $([ $(echo "$AVG_SCORE >= 90" | bc -l 2>/dev/null || echo 0) = 1 ] && echo "âœ… í†µê³¼" || echo "âŒ ê°œì„  í•„ìš”") |" >> $GITHUB_STEP_SUMMARY
            echo "| First Contentful Paint | ${AVG_FCP}ms | â‰¤1800ms | $([ $(echo "$AVG_FCP <= 1800" | bc -l 2>/dev/null || echo 0) = 1 ] && echo "âœ… í†µê³¼" || echo "âŒ ê°œì„  í•„ìš”") |" >> $GITHUB_STEP_SUMMARY
            echo "| Largest Contentful Paint | ${AVG_LCP}ms | â‰¤2500ms | $([ $(echo "$AVG_LCP <= 2500" | bc -l 2>/dev/null || echo 0) = 1 ] && echo "âœ… í†µê³¼" || echo "âŒ ê°œì„  í•„ìš”") |" >> $GITHUB_STEP_SUMMARY
            echo "| Cumulative Layout Shift | $AVG_CLS | â‰¤0.1 | $([ $(echo "$AVG_CLS <= 0.1" | bc -l 2>/dev/null || echo 0) = 1 ] && echo "âœ… í†µê³¼" || echo "âŒ ê°œì„  í•„ìš”") |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$REGRESSION_DETECTED" = true ]; then
              echo "### âš ï¸ ì„±ëŠ¥ íšŒê·€ ê°ì§€ë¨" >> $GITHUB_STEP_SUMMARY
              echo "ë‹¤ìŒ ìµœì í™”ë¥¼ ê³ ë ¤í•˜ì„¸ìš”:" >> $GITHUB_STEP_SUMMARY
              echo "- Box-Muller Transform ìºì‹œ íˆíŠ¸ìœ¨ í™•ì¸" >> $GITHUB_STEP_SUMMARY
              echo "- ì„œë²„ ë©”íŠ¸ë¦­ ìƒì„± ë¡œì§ ìµœì í™”" >> $GITHUB_STEP_SUMMARY
              echo "- Bundle í¬ê¸° ë° ë¶ˆí•„ìš”í•œ JavaScript ì œê±°" >> $GITHUB_STEP_SUMMARY
              echo "- ì´ë¯¸ì§€ ìµœì í™” ë° lazy loading ì ìš©" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "regression_detected=true" >> $GITHUB_OUTPUT
            else
              echo "### âœ… ì„±ëŠ¥ íšŒê·€ ì—†ìŒ - Phase 1 ìµœì í™” ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
              echo "Box-Muller Transform LRU ìºì‹œê°€ ì„±ëŠ¥ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "regression_detected=false" >> $GITHUB_OUTPUT
            fi
            
            echo "ğŸ“Š ìƒì„¸ ë³´ê³ ì„œëŠ” Lighthouse CI ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            
          else
            echo "âŒ Lighthouse ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "regression_detected=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Upload Lighthouse Results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

      # ğŸš¨ ì„±ëŠ¥ íšŒê·€ ê°ì§€ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì²˜ë¦¬
      - name: Handle Performance Regression
        if: steps.regression-check.outputs.regression_detected == 'true'
        run: |
          echo "ğŸš¨ Phase 1 ì„±ëŠ¥ íšŒê·€ ê°ì§€ë¨!"
          echo "Box-Muller Transform LRU ìºì‹œ ìµœì í™”ê°€ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
          echo ""
          echo "ğŸ“‹ ì¦‰ì‹œ í•´ê²° ë°©ì•ˆ:"
          echo "1. ğŸ” Box-Muller ìºì‹œ íˆíŠ¸ìœ¨ ë¶„ì„: npm run test -- box-muller-cache-performance.test.ts"
          echo "2. ğŸ“Š ì„œë²„ ë©”íŠ¸ë¦­ API ì‘ë‹µ ì‹œê°„ í™•ì¸: /api/servers/all"
          echo "3. ğŸ§¹ ë¶ˆí•„ìš”í•œ JavaScript ì œê±° ë° ë²ˆë“¤ ìµœì í™”"
          echo "4. ğŸ–¼ï¸ ì´ë¯¸ì§€ ìµœì í™” ë° WebP ì „í™˜"
          echo "5. âš¡ CSS ì• ë‹ˆë©”ì´ì…˜ ìµœì í™” (Framer Motion ì œê±° íš¨ê³¼ í™•ì¸)"
          echo ""
          echo "ğŸ“Š ì„±ëŠ¥ ëª©í‘œ:"
          echo "- Performance Score: â‰¥ 90%"
          echo "- First Contentful Paint: â‰¤ 1.8ì´ˆ"
          echo "- Largest Contentful Paint: â‰¤ 2.5ì´ˆ" 
          echo "- Cumulative Layout Shift: â‰¤ 0.1"
          echo ""
          echo "ğŸ” ìƒì„¸ ë¶„ì„ì€ Lighthouse CI ì•„í‹°íŒ©íŠ¸ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”."
          exit 1

      # ğŸš€ Phase 2 ì„±ëŠ¥ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤í–‰
      - name: Advanced Performance Alert System
        id: performance-alerts
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          NEXT_PUBLIC_APP_URL: ${{ steps.vercel-deployment.outputs.deployment_url }}
        run: |
          echo "ğŸš€ Phase 2 ê³ ê¸‰ ì„±ëŠ¥ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹œì‘..."
          echo "ğŸ“Š Core Web Vitals + Box-Muller ìºì‹œ + ì›¹í›… ì•Œë¦¼ í†µí•©"
          
          # Node.jsë¡œ ê³ ê¸‰ ì„±ëŠ¥ ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹¤í–‰
          node scripts/performance/performance-alert-system.js
          
          echo "âœ… ê³ ê¸‰ ì„±ëŠ¥ ì•Œë¦¼ ì‹œìŠ¤í…œ ì™„ë£Œ"

      # âœ… ì„±ëŠ¥ íšŒê·€ ì—†ìŒ - ì„±ê³µ ì•Œë¦¼ (í˜¸í™˜ì„± ìœ ì§€)
      - name: Performance Success
        if: steps.regression-check.outputs.regression_detected == 'false'
        run: |
          echo "ğŸ‰ Phase 1 + Phase 2 ì„±ëŠ¥ ìµœì í™” ì„±ê³µ!"
          echo "âœ… Box-Muller Transform LRU ìºì‹œ + ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì´ ëª¨ë“  ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤."
          echo "ğŸ“Š Phase 2 ê³ ê¸‰ ì„±ëŠ¥ ì•Œë¦¼ ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."

      # âš ï¸ ì¼ë°˜ì ì¸ ì‹¤íŒ¨ ì•Œë¦¼ (ì´ì „ í˜¸í™˜ì„±)
      - name: Performance Alert  
        if: failure() && steps.regression-check.outputs.regression_detected != 'true'
        run: |
          echo "âš ï¸ Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ì—ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "ğŸ” GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë‹¤ìŒì„ ê²€í† í•˜ì„¸ìš”:"
          echo "- Vercel ë°°í¬ ìƒíƒœ ë° ì ‘ê·¼ì„±"
          echo "- Lighthouse CI ì„¤ì • íŒŒì¼ (lighthouserc.js)"
          echo "- í™˜ê²½ë³€ìˆ˜ ë° í† í° ì„¤ì •"
          echo ""
          echo "ğŸ“Š ëŒ€ì•ˆ ëª¨ë‹ˆí„°ë§:"
          echo "- Vercel Analytics: ì‹¤ì‚¬ìš©ì ì„±ëŠ¥ ë°ì´í„°"
          echo "- Vercel Speed Insights: Core Web Vitals ì¶”ì "
