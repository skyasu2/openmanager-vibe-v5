name: Keep Services Alive

# Supabase ë¬´ë£Œ í‹°ì–´: 1ì£¼ì¼ ë¯¸ì‚¬ìš© ì‹œ ìë™ Pause
# ì£¼ 2íšŒ pingìœ¼ë¡œ ë¹„í™œì„±í™” ë°©ì§€

on:
  schedule:
    # ë§¤ì£¼ ìˆ˜ìš”ì¼, ì¼ìš”ì¼ 00:00 UTC (í•œêµ­ì‹œê°„ 09:00)
    - cron: '0 0 * * 0,3'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Ping Supabase Database
        env:
          # Try both naming conventions
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          # Debug: Check if secrets are set (show only length, not values)
          echo "ğŸ” Debug: SUPABASE_URL length = ${#SUPABASE_URL}"
          echo "ğŸ” Debug: SUPABASE_ANON_KEY length = ${#SUPABASE_ANON_KEY}"

          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "âŒ Error: Secrets not configured!"
            echo "Please set SUPABASE_URL and SUPABASE_ANON_KEY in GitHub Secrets"
            exit 1
          fi

          response=$(curl -s -o /dev/null -w "%{http_code}" \
            "${SUPABASE_URL}/rest/v1/" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}")

          if [ "$response" = "200" ]; then
            echo "âœ… Supabase ping successful (HTTP $response)"
          else
            echo "âš ï¸ Supabase ping returned HTTP $response"
            echo "ğŸ” URL prefix: ${SUPABASE_URL:0:30}..."
            exit 1
          fi

      - name: Ping Vercel App Health
        run: |
          response=$(curl -s "https://openmanager-vibe-v5.vercel.app/api/health")
          status=$(echo $response | jq -r '.data.status // .status // "unknown"')

          if [ "$status" = "healthy" ]; then
            echo "âœ… Vercel app is healthy"
            echo "Services status:"
            echo $response | jq '.data.services'
          else
            echo "âš ï¸ Vercel app status: $status"
          fi

      - name: Summary
        run: |
          echo "ğŸ¯ Keep-alive completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "Next scheduled runs:"
          echo "- Sunday 00:00 UTC (í•œêµ­ì‹œê°„ ì¼ìš”ì¼ 09:00)"
          echo "- Wednesday 00:00 UTC (í•œêµ­ì‹œê°„ ìˆ˜ìš”ì¼ 09:00)"
