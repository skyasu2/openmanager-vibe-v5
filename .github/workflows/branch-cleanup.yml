name: Branch & PR Cleanup

# ğŸ§¹ ìŠ¤ì¼€ì¤„ ê¸°ë°˜ ë¸Œëœì¹˜/PR ì •ë¦¬ ìë™í™”
# - ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST) ì‹¤í–‰
# - ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥ (workflow_dispatch)
# - ë³´ì•ˆ: ì™¸ë¶€ ì…ë ¥(github.event.*) ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ 00:00 UTC (09:00 KST)
    - cron: '0 0 * * 1'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup-stale-branches:
    name: ğŸ§¹ Stale Branch Cleanup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find Stale Branches
        id: stale
        run: |
          echo "ğŸ” 30ì¼ ì´ìƒ ë¯¸ì‚¬ìš© ë¸Œëœì¹˜ ê²€ìƒ‰..."

          STALE_BRANCHES=""
          PROTECTED_BRANCHES="main master develop"

          for branch in $(git branch -r --format='%(refname:short)' | sed 's|origin/||'); do
            # ë³´í˜¸ëœ ë¸Œëœì¹˜ ìŠ¤í‚µ
            if echo "$PROTECTED_BRANCHES" | grep -qw "$branch"; then
              continue
            fi

            # HEAD ìŠ¤í‚µ
            if [ "$branch" = "HEAD" ]; then
              continue
            fi

            # ë§ˆì§€ë§‰ ì»¤ë°‹ ë‚ ì§œ í™•ì¸
            LAST_COMMIT=$(git log -1 --format=%ct "origin/$branch" 2>/dev/null || echo "0")
            NOW=$(date +%s)
            DAYS_OLD=$(( (NOW - LAST_COMMIT) / 86400 ))

            if [ "$DAYS_OLD" -gt 30 ]; then
              STALE_BRANCHES="$STALE_BRANCHES $branch($DAYS_OLDì¼)"
            fi
          done

          if [ -z "$STALE_BRANCHES" ]; then
            echo "âœ… Stale ë¸Œëœì¹˜ ì—†ìŒ"
            echo "has_stale=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Stale ë¸Œëœì¹˜ ë°œê²¬:$STALE_BRANCHES"
            echo "has_stale=true" >> $GITHUB_OUTPUT
            echo "stale_list=$STALE_BRANCHES" >> $GITHUB_OUTPUT
          fi

      - name: Report Stale Branches
        if: steps.stale.outputs.has_stale == 'true'
        run: |
          echo "ğŸ“‹ Stale ë¸Œëœì¹˜ ë¦¬í¬íŠ¸"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "${{ steps.stale.outputs.stale_list }}"
          echo ""
          echo "ğŸ’¡ ìˆ˜ë™ ì‚­ì œ ëª…ë ¹ì–´:"
          echo "git push origin --delete <branch-name>"

  check-dependabot-prs:
    name: ğŸ“¦ Dependabot PR Status
    runs-on: ubuntu-latest
    steps:
      - name: Check Open PRs
        uses: actions/github-script@v7
        with:
          script: |
            // ì•ˆì „: context.repoë§Œ ì‚¬ìš© (ì™¸ë¶€ ì…ë ¥ ì—†ìŒ)
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 50
            });

            const dependabotPRs = prs.filter(pr =>
              pr.user.login === 'dependabot[bot]'
            );

            console.log('ğŸ“Š PR í˜„í™©');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`ì „ì²´ Open PR: ${prs.length}ê°œ`);
            console.log(`Dependabot PR: ${dependabotPRs.length}ê°œ`);

            if (dependabotPRs.length > 0) {
              console.log('\nğŸ“¦ Dependabot PRs:');
              dependabotPRs.forEach(pr => {
                const age = Math.floor((Date.now() - new Date(pr.created_at)) / (1000 * 60 * 60 * 24));
                // ì•ˆì „: pr.numberëŠ” ìˆ«ì, pr.titleì€ ë¡œê·¸ ì¶œë ¥ë§Œ (shell ëª…ë ¹ ì•„ë‹˜)
                console.log(`  #${pr.number}: ${pr.title} (${age}ì¼ ì „)`);
              });

              // 7ì¼ ì´ìƒ ëœ Dependabot PR ê²½ê³ 
              const oldPRs = dependabotPRs.filter(pr => {
                const age = Math.floor((Date.now() - new Date(pr.created_at)) / (1000 * 60 * 60 * 24));
                return age > 7;
              });

              if (oldPRs.length > 0) {
                console.log('\nâš ï¸ 7ì¼ ì´ìƒ ë¯¸ì²˜ë¦¬ Dependabot PR:');
                oldPRs.forEach(pr => {
                  console.log(`  â†’ #${pr.number}: ${pr.title}`);
                });
                console.log('\nğŸ’¡ ì²˜ë¦¬ ê¶Œì¥: merge/close/rebase ê²°ì • í•„ìš”');
              }
            } else {
              console.log('âœ… ë¯¸ì²˜ë¦¬ Dependabot PR ì—†ìŒ');
            }

  merged-branch-cleanup:
    name: ğŸ—‘ï¸ Merged Branch Cleanup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find Merged Branches
        run: |
          echo "ğŸ” ì´ë¯¸ ë³‘í•©ëœ ë¸Œëœì¹˜ ê²€ìƒ‰..."

          MERGED=$(git branch -r --merged origin/main | grep -v 'main\|HEAD' | sed 's|origin/||' || true)

          if [ -z "$MERGED" ]; then
            echo "âœ… ë³‘í•© í›„ ë¯¸ì‚­ì œ ë¸Œëœì¹˜ ì—†ìŒ"
          else
            echo "âš ï¸ ë³‘í•© ì™„ë£Œëœ ë¸Œëœì¹˜ (ì‚­ì œ ê°€ëŠ¥):"
            echo "$MERGED"
            echo ""
            echo "ğŸ’¡ ìë™ ì‚­ì œë¥¼ ì›í•˜ë©´ ë¦¬í¬ì§€í† ë¦¬ ì„¤ì •ì—ì„œ"
            echo "   'Automatically delete head branches' í™œì„±í™” ê¶Œì¥"
          fi

  summary:
    name: ğŸ“Š Weekly Summary
    runs-on: ubuntu-latest
    needs: [cleanup-stale-branches, check-dependabot-prs, merged-branch-cleanup]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ğŸ§¹ ì£¼ê°„ ë¸Œëœì¹˜/PR ì •ë¦¬ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹¤í–‰ ì‹œê°„**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ì²´í¬ í•­ëª©" >> $GITHUB_STEP_SUMMARY
          echo "- Stale ë¸Œëœì¹˜: ${{ needs.cleanup-stale-branches.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependabot PR: ${{ needs.check-dependabot-prs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Merged ë¸Œëœì¹˜: ${{ needs.merged-branch-cleanup.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ **ìˆ˜ë™ ì‹¤í–‰**: Actions â†’ Branch & PR Cleanup â†’ Run workflow" >> $GITHUB_STEP_SUMMARY
