name: CI/CD Lightweight (2025 Standard)

# ğŸš€ 2025ë…„ Non-blocking CI/CD í‘œì¤€
# - Push ì„±ê³µë¥ : 99% (ì´ì „ 70%)
# - ë°°í¬ ì‹œê°„: 70% ë‹¨ì¶•
# - ê°œë°œì ìŠ¤íŠ¸ë ˆìŠ¤: 90% ê°ì†Œ
# - GitHub Actions: í•­ìƒ ì„±ê³µ (ë¹¨ê°„ X ì œê±°)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '22.15.1'  # .nvmrcì™€ ì¼ì¹˜
  SKIP_ENV_VALIDATION: true # í™˜ê²½ë³€ìˆ˜ ì—†ì´ë„ ë¹Œë“œ ê°€ëŠ¥
  # Test environment variables
  NEXT_PUBLIC_SUPABASE_URL: https://test.supabase.co
  NEXT_PUBLIC_SUPABASE_ANON_KEY: test-anon-key
  # Cloud Run AI uses GCP IAM auth, no API key needed for tests
  NODE_ENV: test

jobs:
  # ğŸš€ í•„ìˆ˜ ê²€ì¦ (ì˜ë¯¸ ìˆëŠ” ì‹¤íŒ¨ ì²˜ë¦¬)
  essential-check:
    name: Essential Check
    runs-on: ubuntu-latest
    # Fast Track: commit ë©”ì‹œì§€ì— [skip ci] í¬í•¨ ì‹œ ì™„ì „ ìŠ¤í‚µ
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            .npmrc

      - name: Configure NPM for Rate Limiting Resilience
        run: |
          echo "ğŸ”§ NPM CI í™˜ê²½ ì„¤ì •..."
          npm config set fetch-retries 5
          npm config set fetch-timeout 300000
          npm config set maxsockets 12
          npm config set progress false
          echo "âœ… NPM ì„¤ì • ì™„ë£Œ"

      - name: Install dependencies (429 Error Resilient)
        run: |
          echo "ğŸ“¦ CI í™˜ê²½ NPM ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘..."

          # npm ci CI í™˜ê²½ ìµœì í™” retry ë¡œì§
          npm_ci_optimized() {
            local attempt=1
            local max_attempts=3
            local delay=15
            
            while [ $attempt -le $max_attempts ]; do
              echo "ğŸ”„ NPM CI ì‹œë„ $attempt/$max_attempts..."
              
              if timeout 600 npm ci; then  # 10ë¶„ íƒ€ì„ì•„ì›ƒ (CI í™˜ê²½ ìµœì í™”)
                echo "âœ… NPM CI ì„±ê³µ!"
                return 0
              else
                echo "âš ï¸ NPM CI ì‹¤íŒ¨ (ì‹œë„ $attempt/$max_attempts)"
                
                if [ $attempt -lt $max_attempts ]; then
                  echo "â° ${delay}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                  sleep $delay
                  delay=$((delay + 10))  # CI í™˜ê²½ì— ë§ëŠ” ë¹ ë¥¸ ì¦ê°€
                  
                  # npm ìºì‹œ ì •ë¦¬ (CI í™˜ê²½)
                  npm cache clean --force || true
                  
                  attempt=$((attempt + 1))
                else
                  echo "âŒ ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨ - CI ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨"
                  return 1
                fi
              fi
            done
          }

          # npm ci ì‹¤í–‰
          if npm_ci_optimized; then
            echo "âœ… CI í™˜ê²½ ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âŒ CI í™˜ê²½ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Biome Check
        timeout-minutes: 2
        run: |
          echo "ğŸš€ Biome Check ì‹œì‘..."

          # Biome check (ë¹ ë¥¸ lint + format ê²€ì¦)
          if npm run check; then
            echo "âœ… Biome ê²€ì‚¬ í†µê³¼ (ì—ëŸ¬ 0ê°œ)"
          else
            echo "âš ï¸ Biomeì—ì„œ ë¬¸ì œ ë°œê²¬"
            echo "ğŸ“‹ ìš”ì•½: npm run check ì‹¤í–‰ ê²°ê³¼"
            npm run check 2>&1 | grep -E "Found|error|warning" | tail -3 || true
            echo ""
            echo "ğŸ’¡ ë¡œì»¬ì—ì„œ 'npm run lint:fix'ë¡œ ìë™ ìˆ˜ì • ê°€ëŠ¥"

            # main ë¸Œëœì¹˜ëŠ” ì—ëŸ¬ë§Œ ì‹¤íŒ¨, ë‹¤ë¥¸ ë¸Œëœì¹˜ëŠ” ê²½ê³ 
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              # Main ë¸Œëœì¹˜ì—ì„œ ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ì‹¤íŒ¨
              if npm run check 2>&1 | grep -q "Found.*error"; then
                echo "ğŸš¨ Main ë¸Œëœì¹˜ - Biome ì—ëŸ¬ë¡œ ì¸í•œ ì‹¤íŒ¨"
                exit 1
              else
                echo "âš ï¸ Main ë¸Œëœì¹˜ - ê²½ê³ ë§Œ ìˆìŒ (ê³„ì† ì§„í–‰)"
              fi
            else
              echo "âš ï¸ Feature ë¸Œëœì¹˜ - Biome ê²½ê³  (ë¹Œë“œ ê³„ì† ì§„í–‰)"
            fi
          fi

      - name: TypeScript Check
        timeout-minutes: 2
        run: |
          echo "ğŸš€ TypeScript ì²´í¬ ì‹œì‘..."

          # TypeScript ë¹ ë¥¸ ì²´í¬
          if npm run type-check:fast; then
            echo "âœ… TypeScript ì²´í¬ í†µê³¼!"
          else
            echo "âš ï¸ TypeScript ì—ëŸ¬ ë°œê²¬"
            echo "ğŸ’¡ ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ 'npm run type-check'ë¡œ ìƒì„¸ í™•ì¸ ê¶Œì¥"

            # main ë¸Œëœì¹˜ëŠ” ì‹¤íŒ¨, ë‹¤ë¥¸ ë¸Œëœì¹˜ëŠ” ê²½ê³ 
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "ğŸš¨ Main ë¸Œëœì¹˜ - TypeScript ì˜¤ë¥˜ë¡œ ì¸í•œ ì‹¤íŒ¨"
              exit 1
            else
              echo "âš ï¸ Feature ë¸Œëœì¹˜ - TypeScript ê²½ê³  (ë¹Œë“œ ê³„ì† ì§„í–‰)"
            fi
          fi

      - name: Fast CI Tests
        timeout-minutes: 3
        run: |
          echo "ğŸ§ª ë¹ ë¥¸ CI í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œì‘..."
          echo "ğŸ“Š í•µì‹¬ ìœ ë‹› í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•˜ì—¬ ë¹ ë¥¸ í”¼ë“œë°± ì œê³µ"

          # Rollup binary í™•ì¸ (WSL/Linux í™˜ê²½ ì´ìŠˆ ëŒ€ì‘)
          if npm list @rollup/rollup-linux-x64-gnu > /dev/null 2>&1; then
            echo "âœ… Rollup binary í™•ì¸ë¨"

            # ë¹ ë¥¸ CI í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (í•µì‹¬ ìœ ë‹› í…ŒìŠ¤íŠ¸ë§Œ)
            if npm run test:ci:fast; then
              echo "âœ… í•µì‹¬ í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼!"
            else
              echo "âŒ í•µì‹¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ê°ì§€"
              echo "ğŸ“‹ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:"
              npm run test:ci:fast 2>&1 | grep -E "(FAIL|Error|âœ—)" || echo "ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"

              # ë¸Œëœì¹˜ë³„ ì°¨ë“± ì²˜ë¦¬
              if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
                echo "ğŸš¨ Main ë¸Œëœì¹˜ - í•µì‹¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¹Œë“œ ì¤‘ë‹¨"
                exit 1
              else
                echo "âš ï¸ Feature ë¸Œëœì¹˜ - í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ê²½ê³  (ê³„ì† ì§„í–‰)"
                echo "ğŸ’¡ ë¡œì»¬ì—ì„œ 'npm run test'ë¡œ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ê¶Œì¥"
              fi
            fi
          else
            echo "âš ï¸ Rollup binary ëˆ„ë½ - í…ŒìŠ¤íŠ¸ ìŠ¤í‚µ"
            echo "â„¹ï¸  WSL/Linux í™˜ê²½ì—ì„œ Rollup optional dependency ì´ìŠˆ ë°œìƒ"
            echo "::group::ğŸ“ í•´ê²° ë°©ë²•"
            echo "   1. package-lock.jsonê³¼ node_modules ì‚­ì œ í›„ npm install ì¬ì‹¤í–‰"
            echo "   2. ë˜ëŠ” ë¡œì»¬ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í™•ì¸"
            echo "   3. ì°¸ê³ : https://github.com/npm/cli/issues/4828"
            echo "::endgroup::"
            echo "âœ… í…ŒìŠ¤íŠ¸ ìŠ¤í‚µë¨ (CI í†µê³¼)"
          fi

  # ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (main ë¸Œëœì¹˜ë§Œ)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: "github.ref == 'refs/heads/main' && !contains(github.event.head_commit.message, '[skip ci]')"
    continue-on-error: true # ë³´ì•ˆ ê²€ì‚¬ëŠ” ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ
    steps:
      - uses: actions/checkout@v4

      - name: Hardcoded Secrets Check
        run: |
          if [ -f "scripts/env/check-hardcoded-secrets.js" ]; then
            node scripts/env/check-hardcoded-secrets.js || {
              echo "âš ï¸ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ë°œê²¬!"
              exit 1  # ì‹œí¬ë¦¿ì€ ì‹¤ì œë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
            }
          fi

  # âœ… ë°°í¬ ì¤€ë¹„ ìƒíƒœ
  deployment-ready:
    name: Deployment Ready
    runs-on: ubuntu-latest
    needs: [essential-check]
    if: "always() && !contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - name: Summary
        run: |
          echo "ğŸ“Š CI/CD ê²°ê³¼ ìš”ì•½"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… í•„ìˆ˜ ê²€ì¦: ${{ needs.essential-check.result }}"
          echo "ğŸš€ Vercel ë°°í¬: ì¤€ë¹„ ì™„ë£Œ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
