name: Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬ (ê°œì„ ëœ ìŠ¤í¬ë¦½íŠ¸)
      run: |
        # ì •êµí•œ ë³´ì•ˆ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        chmod +x scripts/check-hardcoded-secrets.sh
        ./scripts/check-hardcoded-secrets.sh
    
    - name: npm audit ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
      run: |
        npm audit --audit-level high || true
    
    - name: í™˜ê²½ë³€ìˆ˜ í…œí”Œë¦¿ ê²€ì¦
      run: |
        # .env.example íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if [ ! -f .env.example ]; then
          echo "âš ï¸ .env.example íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        # ì‹¤ì œ ì‹œí¬ë¦¿ì´ .env.exampleì— ì—†ëŠ”ì§€ í™•ì¸ (ì˜ˆì œ íŒ¨í„´ ì œì™¸)
        echo "ğŸ” .env.example íŒŒì¼ ê²€ì¦ ì¤‘..."
        if grep -E "(ghp_[a-zA-Z0-9]{36}|ghs_[a-zA-Z0-9]{36}|sk-[a-zA-Z0-9]{48}|AIza[a-zA-Z0-9-_]{35})" .env.example; then
          echo "âŒ .env.exampleì— ì‹¤ì œ ì‹œí¬ë¦¿ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
          exit 1
        else
          echo "âœ… .env.example íŒŒì¼ì´ ì•ˆì „í•©ë‹ˆë‹¤."
        fi
    
    - name: Run TruffleHog (ê²€ì¦ëœ ì‹œí¬ë¦¿ë§Œ)
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --only-verified --exclude-paths .securityignore