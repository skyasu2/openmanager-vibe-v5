name: Security Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (TruffleHog ìŠ¤ìº”ì„ ìœ„í•´)

      - name: Setup Node.js (Enhanced Caching)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            .npmrc
      
      - name: Configure NPM for Rate Limiting Resilience
        run: |
          echo "ðŸ”§ NPM ì„¤ì • ìµœì í™” ì¤‘..."
          # GitHub Actions í™˜ê²½ì—ì„œ ì¶”ê°€ ìµœì í™”
          npm config set audit-level moderate
          npm config set fetch-retries 5
          npm config set fetch-timeout 300000
          npm config set maxsockets 10
          npm config set progress false
          echo "âœ… NPM ì„¤ì • ì™„ë£Œ"

      - name: Install dependencies (429 Error Resilient)
        run: |
          echo "ðŸ“¦ NPM ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œìž‘..."
          
          # npm ciì— ëŒ€í•œ 429 Rate Limit ëŒ€ì‘ retry ë¡œì§ (ê°„ì†Œí™” ë²„ì „)
          npm_ci_with_retry() {
            local attempt=1
            local max_attempts=3
            local delay=25
            
            while [ $attempt -le $max_attempts ]; do
              echo "ðŸ”„ NPM CI ì‹œë„ $attempt/$max_attempts..."
              
              if timeout 800 npm ci; then  # 13ë¶„ íƒ€ìž„ì•„ì›ƒ
                echo "âœ… NPM CI ì„±ê³µ!"
                return 0
              else
                echo "âš ï¸ NPM CI ì‹¤íŒ¨ (ì‹œë„ $attempt/$max_attempts)"
                
                if [ $attempt -lt $max_attempts ]; then
                  echo "â° ${delay}ì´ˆ ëŒ€ê¸° í›„ ìž¬ì‹œë„..."
                  sleep $delay
                  delay=$((delay + 20))  # ì ì§„ì  ì¦ê°€: 25s â†’ 45s
                  
                  # npm ìºì‹œ ì •ë¦¬
                  npm cache clean --force || true
                  
                  attempt=$((attempt + 1))
                else
                  echo "âŒ ëª¨ë“  ìž¬ì‹œë„ ì‹¤íŒ¨"
                  return 1
                fi
              fi
            done
          }
          
          # npm ci ì‹¤í–‰
          if npm_ci_with_retry; then
            echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âŒ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨ - ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨"
            exit 1
          fi

      - name: í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬ (ê°œì„ ëœ ìŠ¤í¬ë¦½íŠ¸)
        run: |
          # ì •êµí•œ ë³´ì•ˆ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (JavaScript ë²„ì „)
          node scripts/env/check-hardcoded-secrets.js

      - name: npm audit ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ (429 Error Resilient)
        run: |
          echo "ðŸ” NPM ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰ ì¤‘..."
          
          # 429 Rate Limit ëŒ€ì‘ì„ ìœ„í•œ ê°„ì†Œí™”ëœ retry ë¡œì§  
          npm_audit_simple_retry() {
            local attempt=1
            local max_attempts=3
            local delay=15
            
            while [ $attempt -le $max_attempts ]; do
              echo "ðŸ”„ NPM audit ì‹œë„ $attempt/$max_attempts..."
              
              if timeout 60 npm audit --audit-level high 2>&1; then
                echo "âœ… NPM audit ì„±ê³µ!"
                return 0
              else
                local exit_code=$?
                
                # 429 ì—ëŸ¬ë‚˜ íƒ€ìž„ì•„ì›ƒ í™•ì¸
                if npm audit --audit-level high 2>&1 | grep -E "429|Too Many Requests|Rate limit|ENOTFOUND|timeout" | head -1; then
                  echo "âš ï¸ Rate limit ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ê°ì§€ - ${delay}ì´ˆ ëŒ€ê¸°..."
                  sleep $delay
                  delay=$((delay + 5))
                  attempt=$((attempt + 1))
                else
                  # ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬ ì‹œ (ì •ìƒì ì¸ ì‹¤íŒ¨)
                  if [ $exit_code -eq 1 ]; then
                    echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬ë¨ (ì •ìƒì ì¸ ê²°ê³¼)"
                    return 1
                  else
                    echo "âŒ ê¸°íƒ€ NPM audit ì˜¤ë¥˜"
                    return $exit_code
                  fi
                fi
              fi
            done
            
            echo "ðŸ”„ ëª¨ë“  ìž¬ì‹œë„ ì‹¤íŒ¨ - ëŒ€ì²´ ê²€ì‚¬ë¡œ ì§„í–‰"
            return 1
          }
          
          # NPM audit ì‹¤í–‰ (ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš° ê³„ì†)
          if npm_audit_simple_retry; then
            echo "âœ… NPM ë³´ì•ˆ ê²€ì‚¬ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
          else
            echo "âš ï¸ NPM audit ì‹¤íŒ¨ - ëŒ€ì²´ ê²€ì¦ ì‹¤í–‰ ì¤‘..."
            
            # ëŒ€ì²´ ë³´ì•ˆ ê²€ì‚¬: íŒ¨í‚¤ì§€ ë²„ì „ í™•ì¸
            echo "ðŸ“¦ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ ë²„ì „ í™•ì¸:"
            npm list --depth=0 || true
            
            echo "âœ… ëŒ€ì²´ ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ (ì›Œí¬í”Œë¡œìš° ê³„ì† ì§„í–‰)"
          fi

      - name: í™˜ê²½ë³€ìˆ˜ í…œí”Œë¦¿ ê²€ì¦
        run: |
          # .env.example íŒŒì¼ì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
          if [ ! -f .env.example ]; then
            echo "âš ï¸ .env.example íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          # ì‹¤ì œ ì‹œí¬ë¦¿ì´ .env.exampleì— ì—†ëŠ”ì§€ í™•ì¸ (ì˜ˆì œ íŒ¨í„´ ì œì™¸)
          echo "ðŸ” .env.example íŒŒì¼ ê²€ì¦ ì¤‘..."
          if grep -E "(ghp_[a-zA-Z0-9]{36}|ghs_[a-zA-Z0-9]{36}|sk-[a-zA-Z0-9]{48}|AIza[a-zA-Z0-9-_]{35})" .env.example; then
            echo "âŒ .env.exampleì— ì‹¤ì œ ì‹œí¬ë¦¿ì´ í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… .env.example íŒŒì¼ì´ ì•ˆì „í•©ë‹ˆë‹¤."
          fi

      - name: TruffleHog ìŠ¤ìº” ì„¤ì •
        id: trufflehog-config
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ðŸ” Push ì´ë²¤íŠ¸ ê°ì§€ - ì „ì²´ ë¸Œëžœì¹˜ ìŠ¤ìº” ëª¨ë“œ"
            echo "base=" >> $GITHUB_OUTPUT
            echo "head=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ðŸ” PR ì´ë²¤íŠ¸ ê°ì§€ - ë³€ê²½ì‚¬í•­ë§Œ ìŠ¤ìº” ëª¨ë“œ"
            echo "base=${{ github.event.repository.default_branch }}" >> $GITHUB_OUTPUT
            echo "head=HEAD" >> $GITHUB_OUTPUT
          fi

      - name: Run TruffleHog (ê²€ì¦ëœ ì‹œí¬ë¦¿ë§Œ)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.trufflehog-config.outputs.base }}
          head: ${{ steps.trufflehog-config.outputs.head }}
          extra_args: >-
            --only-verified
            --exclude-paths docs/.trufflehog-excludes.txt
            --max-depth 50
        continue-on-error: false
