name: Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for hardcoded secrets
      run: |
        echo "ğŸ” í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬ ì¤‘..."
        
        # ê²€ì‚¬í•  íŒ¨í„´ë“¤
        patterns=(
          "AbYGAAIjcDE5MjNmYjhiZDkwOGQ0MTUyOGFiZjUyMmQ0YTkyMzIwM3AxMA"
          "charming-condor-46598.upstash.io"
          "redis://default:"
          "postgresql://postgres:"
          "ghp_"
          "ghs_"
          "sk-"
          "pk_"
          "api_key"
          "secret_key"
        )
        
        found=0
        for pattern in "${patterns[@]}"; do
          echo "ê²€ì‚¬ ì¤‘: $pattern"
          if grep -r "$pattern" . \
            --exclude-dir=node_modules \
            --exclude-dir=.git \
            --exclude-dir=.next \
            --exclude-dir=coverage \
            --exclude-dir=dist \
            --exclude="*.lock" \
            --exclude="*.log" \
            --exclude=".env.example" \
            --exclude="security-check.yml" \
            2>/dev/null; then
            echo "âš ï¸ ê²½ê³ : '$pattern' íŒ¨í„´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            found=1
          fi
        done
        
        if [ $found -eq 1 ]; then
          echo "âŒ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“ í™˜ê²½ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”."
          exit 1
        else
          echo "âœ… í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        fi
    
    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified