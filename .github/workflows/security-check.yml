name: Security Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (TruffleHog ìŠ¤ìº”ì„ ìœ„í•´)

      - name: í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬ (ê°œì„ ëœ ìŠ¤í¬ë¦½íŠ¸)
        run: |
          # ì •êµí•œ ë³´ì•ˆ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (JavaScript ë²„ì „)
          node scripts/security/check-hardcoded-secrets.js

      - name: npm audit ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
        run: |
          npm audit --audit-level high || true

      - name: í™˜ê²½ë³€ìˆ˜ í…œí”Œë¦¿ ê²€ì¦
        run: |
          # .env.example íŒŒì¼ì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
          if [ ! -f .env.example ]; then
            echo "âš ï¸ .env.example íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          # ì‹¤ì œ ì‹œí¬ë¦¿ì´ .env.exampleì— ì—†ëŠ”ì§€ í™•ì¸ (ì˜ˆì œ íŒ¨í„´ ì œì™¸)
          echo "ðŸ” .env.example íŒŒì¼ ê²€ì¦ ì¤‘..."
          if grep -E "(ghp_[a-zA-Z0-9]{36}|ghs_[a-zA-Z0-9]{36}|sk-[a-zA-Z0-9]{48}|AIza[a-zA-Z0-9-_]{35})" .env.example; then
            echo "âŒ .env.exampleì— ì‹¤ì œ ì‹œí¬ë¦¿ì´ í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… .env.example íŒŒì¼ì´ ì•ˆì „í•©ë‹ˆë‹¤."
          fi

      - name: TruffleHog ìŠ¤ìº” ì„¤ì •
        id: trufflehog-config
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ðŸ” Push ì´ë²¤íŠ¸ ê°ì§€ - ì „ì²´ ë¸Œëžœì¹˜ ìŠ¤ìº” ëª¨ë“œ"
            echo "base=" >> $GITHUB_OUTPUT
            echo "head=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ðŸ” PR ì´ë²¤íŠ¸ ê°ì§€ - ë³€ê²½ì‚¬í•­ë§Œ ìŠ¤ìº” ëª¨ë“œ"
            echo "base=${{ github.event.repository.default_branch }}" >> $GITHUB_OUTPUT
            echo "head=HEAD" >> $GITHUB_OUTPUT
          fi

      - name: Run TruffleHog (ê²€ì¦ëœ ì‹œí¬ë¦¿ë§Œ)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ steps.trufflehog-config.outputs.base }}
          head: ${{ steps.trufflehog-config.outputs.head }}
          extra_args: >-
            --only-verified
            --exclude-paths docs/.trufflehog-excludes.txt
            --max-depth 50
        continue-on-error: false
