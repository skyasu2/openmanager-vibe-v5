name: TDD Test Cleanup
on:
  push:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ ìì • (UTC)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.18.0'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            .npmrc

      - name: Install dependencies (429 Error Resilient)
        run: |
          echo "ğŸ“¦ TDD Cleanup NPM ì˜ì¡´ì„± ì„¤ì¹˜..."
          
          # TDD ì •ë¦¬ìš© retry ë¡œì§
          for attempt in 1 2; do
            echo "ğŸ”„ NPM CI ì‹œë„ $attempt/2..."
            
            if timeout 350 npm ci; then  # 6ë¶„ íƒ€ì„ì•„ì›ƒ
              echo "âœ… NPM CI ì„±ê³µ!"
              break
            else
              if [ $attempt -eq 2 ]; then
                echo "âŒ NPM CI ìµœì¢… ì‹¤íŒ¨ - TDD cleanup ìŠ¤í‚µ"
                exit 1
              else
                echo "â° 20ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                sleep 20
                npm cache clean --force || true
              fi
            fi
          done

      - name: Check TDD test transitions
        id: tdd-check
        run: |
          npm run test:tdd-check
          echo "cleanup_needed=$?" >> $GITHUB_OUTPUT

      - name: Run TDD cleanup
        if: steps.tdd-check.outputs.cleanup_needed == '0'
        run: npm run test:tdd-cleanup

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ§¹ chore: Clean up passing TDD tests'
          title: '[ìë™í™”] TDD í…ŒìŠ¤íŠ¸ ì •ë¦¬'
          body: |
            ## ğŸ”„ TDD í…ŒìŠ¤íŠ¸ ìë™ ì •ë¦¬

            ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

            ### ë³€ê²½ì‚¬í•­
            - REDì—ì„œ GREENìœ¼ë¡œ ì „í™˜ëœ í…ŒìŠ¤íŠ¸ì˜ `@tdd-red` íƒœê·¸ ì œê±°
            - ê´€ë ¨ ë©”íƒ€ë°ì´í„° ì •ë¦¬

            ### ë¦¬í¬íŠ¸
            ìƒì„¸ ë‚´ìš©ì€ `tdd-cleanup-report.md` íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.

            ---
            *ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          branch: auto/tdd-cleanup
          delete-branch: true
          labels: |
            automation
            tests
            cleanup

      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tdd-cleanup-report
          path: |
            tdd-cleanup-report.md
            test-metadata-report.md
          retention-days: 30
