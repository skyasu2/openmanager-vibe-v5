name: ğŸ”„ Background RAG Indexing

on:
  # ë¬¸ì„œ ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰
  push:
    paths:
      - 'docs/**'
      - 'public/**/*.json'
      - 'README.md'
      - 'CHANGELOG.md'
    branches:
      - main
      - develop

  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  workflow_dispatch:
    inputs:
      force_reindex:
        description: 'ê°•ì œ ì „ì²´ ì¬ì¸ë±ì‹±'
        required: false
        default: 'false'
        type: boolean
      concurrency_limit:
        description: 'ë™ì‹œ ì²˜ë¦¬ ìˆ˜ (1-5)'
        required: false
        default: '3'
        type: string

  # ì£¼ê¸°ì  ì‹¤í–‰ (ë§¤ì¼ ìƒˆë²½ 2ì‹œ)
  schedule:
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '22'
  CONCURRENCY_LIMIT: ${{ github.event.inputs.concurrency_limit || '3' }}
  BATCH_SIZE: '10'

jobs:
  background-indexing:
    name: ğŸ“š RAG ë¬¸ì„œ ì¸ë±ì‹±
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“‚ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ë³€ê²½ ê°ì§€ë¥¼ ìœ„í•´ ì´ì „ ì»¤ë°‹ë„ í¬í•¨

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "GOOGLE_AI_API_KEY=${{ secrets.GOOGLE_AI_API_KEY }}" >> $GITHUB_ENV
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV

      - name: ğŸ“‹ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci --production=false
          npm install -g ts-node typescript

      - name: ğŸ” ë³€ê²½ëœ íŒŒì¼ ê°ì§€
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.force_reindex }}" = "true" ]; then
            echo "force_reindex=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ ê°•ì œ ì „ì²´ ì¬ì¸ë±ì‹± ëª¨ë“œ"
          else
            # ë³€ê²½ëœ ë¬¸ì„œ íŒŒì¼ í™•ì¸
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(md|json)$' | head -20 || echo "")
            if [ -n "$CHANGED_FILES" ]; then
              echo "changed_files<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "ğŸ“„ ë³€ê²½ëœ ë¬¸ì„œ íŒŒì¼:"
              echo "$CHANGED_FILES"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "ğŸ“ ë³€ê²½ëœ ë¬¸ì„œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
          fi

      - name: ğŸš€ ë°±ê·¸ë¼ìš´ë“œ ì¸ë±ì‹± ì‹¤í–‰
        if: steps.changes.outputs.has_changes == 'true' || steps.changes.outputs.force_reindex == 'true'
        run: |
          echo "ğŸ”„ RAG ë°±ê·¸ë¼ìš´ë“œ ì¸ë±ì‹± ì‹œì‘..."
          echo "ğŸ“Š ì„¤ì •:"
          echo "  - ë™ì‹œì„± ì œí•œ: $CONCURRENCY_LIMIT"
          echo "  - ë°°ì¹˜ í¬ê¸°: $BATCH_SIZE"
          echo "  - ê°•ì œ ì¬ì¸ë±ì‹±: ${{ steps.changes.outputs.force_reindex || 'false' }}"
          
          # ì¸ë±ì‹± ì‹¤í–‰
          npm run index:background
          
          # ê²°ê³¼ í™•ì¸
          echo "âœ… ì¸ë±ì‹± ì™„ë£Œ"

      - name: ğŸ“Š Supabase ë²¡í„° DB ìƒíƒœ í™•ì¸
        if: steps.changes.outputs.has_changes == 'true' || steps.changes.outputs.force_reindex == 'true'
        run: |
          echo "ğŸ“Š ë²¡í„° DB ìƒíƒœ í™•ì¸..."
          # TODO: Supabase í•¨ìˆ˜ë¥¼ í†µí•´ í†µê³„ ì¡°íšŒ
          # npx supabase functions invoke vector-stats
          echo "âœ… ìƒíƒœ í™•ì¸ ì™„ë£Œ"

      - name: ğŸš¨ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
        if: failure()
        run: |
          echo "âŒ ë°±ê·¸ë¼ìš´ë“œ ì¸ë±ì‹± ì‹¤íŒ¨"
          echo "ğŸ“ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ íŒŒì•…í•´ì£¼ì„¸ìš”."
          echo "ğŸ”§ ì¼ë°˜ì ì¸ í•´ê²° ë°©ë²•:"
          echo "  1. Google AI API í‚¤ í™•ì¸"
          echo "  2. Supabase ì—°ê²° ìƒíƒœ í™•ì¸"
          echo "  3. ë©”ëª¨ë¦¬ ë¶€ì¡± (í° ë¬¸ì„œ ì²˜ë¦¬ ì‹œ)"

      - name: ğŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        if: steps.changes.outputs.has_changes == 'true' || steps.changes.outputs.force_reindex == 'true'
        run: |
          echo "ğŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­:"
          echo "  - ì‹¤í–‰ ì‹œê°„: ${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          echo "  - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: $(free -h | awk '/^Mem:/ {print $3}')"
          echo "  - ì²˜ë¦¬ëœ íŒŒì¼ ìˆ˜: (ì¸ë±ì‹± ë¡œê·¸ì—ì„œ í™•ì¸)"

  # ì„ íƒì : ì¸ë±ì‹± í’ˆì§ˆ ê²€ì¦
  quality-check:
    name: ğŸ¯ ì¸ë±ì‹± í’ˆì§ˆ ê²€ì¦
    runs-on: ubuntu-latest
    needs: background-indexing
    if: success()
    timeout-minutes: 10

    steps:
      - name: ğŸ“‚ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“‹ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci --production=false

      - name: ğŸ”§ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> $GITHUB_ENV

      - name: ğŸ§ª ë²¡í„° ê²€ìƒ‰ í’ˆì§ˆ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ§ª ë²¡í„° ê²€ìƒ‰ í’ˆì§ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          # TODO: ì‹¤ì œ ê²€ìƒ‰ í’ˆì§ˆ í…ŒìŠ¤íŠ¸ êµ¬í˜„
          # npm run test:rag-quality
          echo "âœ… í’ˆì§ˆ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

      - name: ğŸ“Š ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰
        run: |
          echo "ğŸ“Š RAG ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬..."
          # TODO: ë²¤ì¹˜ë§ˆí¬ API í˜¸ì¶œ
          # curl -X GET "$SUPABASE_URL/rest/v1/rpc/vector_search_benchmark"
          echo "âœ… ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ"

  # ì„ íƒì : Slack/Discord ì•Œë¦¼
  notification:
    name: ğŸ“¢ ì™„ë£Œ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [background-indexing, quality-check]
    if: always()

    steps:
      - name: ğŸ“¢ ê²°ê³¼ ì•Œë¦¼
        run: |
          if [ "${{ needs.background-indexing.result }}" = "success" ] && [ "${{ needs.quality-check.result }}" = "success" ]; then
            echo "âœ… RAG ë°±ê·¸ë¼ìš´ë“œ ì¸ë±ì‹± ë° í’ˆì§ˆ ê²€ì¦ ì™„ë£Œ"
            # TODO: Slack/Discord ì›¹í›…ìœ¼ë¡œ ì„±ê³µ ì•Œë¦¼
          else
            echo "âŒ RAG ë°±ê·¸ë¼ìš´ë“œ ì¸ë±ì‹± ë˜ëŠ” í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨"
            echo "ì‹¤íŒ¨í•œ ë‹¨ê³„:"
            echo "  - ì¸ë±ì‹±: ${{ needs.background-indexing.result }}"
            echo "  - í’ˆì§ˆ ê²€ì¦: ${{ needs.quality-check.result }}"
            # TODO: Slack/Discord ì›¹í›…ìœ¼ë¡œ ì‹¤íŒ¨ ì•Œë¦¼
          fi