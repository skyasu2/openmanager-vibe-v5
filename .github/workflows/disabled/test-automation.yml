# ğŸš€ OpenManager VIBE v5 - í…ŒìŠ¤íŠ¸ ìë™í™” CI/CD
# TDD ê¸°ë°˜ í’ˆì§ˆ ë³´ì¦ íŒŒì´í”„ë¼ì¸

name: ğŸ§ª Test Automation Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST) ì •ê¸° í…ŒìŠ¤íŠ¸ - ê°„ì†Œí™”
    - cron: '0 0 * * 1'

env:
  NODE_VERSION: '22.18.0'
  CI: true
  FORCE_COLOR: true

jobs:
  # ğŸ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Vitest) - ê°„ì†Œí™”
  unit-tests:
    name: ğŸ§ª Unit Tests (Vitest)
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸ§ª Run All Unit Tests
        run: npm run test -- --coverage

      - name: ğŸ“Š Upload Coverage (Main branch only)
        if: github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unit-tests
          name: unit-coverage

  # âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ - ë©”ì¸ ë¸Œëœì¹˜ë§Œ ì‹¤í–‰
  performance-tests:
    name: ğŸš€ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸš€ Run Performance Tests
        run: npm run test:performance

      - name: ğŸ“Š Performance Benchmark
        run: |
          echo "## ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Core Web Vitals ê²€ì¦ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“‹ Upload Performance Results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: performance-report.json
          retention-days: 7

  # ğŸ­ E2E í…ŒìŠ¤íŠ¸ (Playwright) - ê°„ì†Œí™”
  e2e-tests:
    name: ğŸ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # ë©”ì¸ ë¸Œëœì¹˜ì™€ PRë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ­ Install Playwright (Chromium only)
        run: npx playwright install --with-deps chromium

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸš€ Start Test Server
        run: |
          npm run dev &
          npx wait-on http://localhost:3000 --timeout 30000
        env:
          NODE_ENV: test
          PORT: 3000

      - name: ğŸ­ Run E2E Tests (Chromium only)
        run: npx playwright test --project=chromium --reporter=line

      - name: ğŸ“‹ Upload E2E Results (Main branch only)
        if: failure() && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: playwright-report/
          retention-days: 3

  # ğŸ” ë³´ì•ˆ í…ŒìŠ¤íŠ¸ - ê°„ì†Œí™”
  security-tests:
    name: ğŸ”’ Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” Run Security Audit
        run: |
          npm audit --audit-level=moderate

      - name: ğŸ”’ TypeScript Any Types Check
        run: |
          echo "ğŸ” TypeScript any íƒ€ì… ê²€ì‚¬ ì¤‘..."
          any_count=$(grep -r ': any' src/ --include='*.ts' --include='*.tsx' | wc -l || echo "0")
          echo "ë°œê²¬ëœ any íƒ€ì…: ${any_count}ê°œ"
          if [ "$any_count" -gt 10 ]; then
            echo "âŒ any íƒ€ì…ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤ (${any_count}ê°œ > 10ê°œ)"
            exit 1
          else
            echo "âœ… any íƒ€ì… ì‚¬ìš©ëŸ‰ì´ ì ì ˆí•©ë‹ˆë‹¤ (${any_count}ê°œ â‰¤ 10ê°œ)"
          fi

      - name: ğŸ“Š Security Summary
        run: |
          echo "## ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- npm audit: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript any íƒ€ì…: ì œí•œ ë‚´" >> $GITHUB_STEP_SUMMARY

  # ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ í†µí•© - ê°„ì†Œí™”
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, performance-tests, e2e-tests, security-tests]
    if: always() && github.ref == 'refs/heads/main'
    timeout-minutes: 2

    steps:
      - name: ğŸ“Š Simple Test Report
        run: |
          echo "## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ${{ needs.unit-tests.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E í…ŒìŠ¤íŠ¸: ${{ needs.e2e-tests.result == 'success' && 'âœ… í†µê³¼' || needs.e2e-tests.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ${{ needs.performance-tests.result == 'success' && 'âœ… í†µê³¼' || needs.performance-tests.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ë³´ì•ˆ í…ŒìŠ¤íŠ¸: ${{ needs.security-tests.result == 'success' && 'âœ… í†µê³¼' || needs.security-tests.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨' }}" >> $GITHUB_STEP_SUMMARY

  # ğŸš€ ë°°í¬ ì¤€ë¹„ ê²€ì¦ - ê°„ì†Œí™”
  deployment-ready:
    name: ğŸš€ Deployment Ready
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 1

    steps:
      - name: âœ… Core Tests Passed
        if: needs.unit-tests.result == 'success'
        run: echo "ğŸ‰ í•µì‹¬ í…ŒìŠ¤íŠ¸ í†µê³¼! ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤."

      - name: âŒ Core Tests Failed
        if: needs.unit-tests.result != 'success'
        run: |
          echo "âŒ í•µì‹¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ë°°í¬ ì°¨ë‹¨ë©ë‹ˆë‹¤."
          exit 1
