name: Cursor Auto Test

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'stories/**'
      - 'scripts/cursor-auto-test.js'
      - 'scripts/validate-storybook.js'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'stories/**'
  workflow_dispatch:

jobs:
  cursor-auto-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm ci
          npx playwright install --with-deps

      - name: ğŸ¯ ì»¤ì„œ ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm run cursor:auto-test
        env:
          CI: true
          NODE_ENV: test
          FORCE_MOCK_REDIS: true
          FORCE_MOCK_GOOGLE_AI: true
          STORYBOOK: true
          DISABLE_HEALTH_CHECK: true
          HEALTH_CHECK_CONTEXT: false
          REDIS_CONNECTION_DISABLED: true
          UPSTASH_REDIS_DISABLED: true

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cursor-test-reports
          path: |
            cursor-test-report.json
            CURSOR_TEST_REPORT.md
            eslint-report.json
            storybook-validation-report.json
          retention-days: 30

      - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## ğŸ¯ ì»¤ì„œ ìë™ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          if [ -f "CURSOR_TEST_REPORT.md" ]; then
            cat CURSOR_TEST_REPORT.md >> $GITHUB_STEP_SUMMARY
          else
            echo "í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¬ PR ì½”ë©˜íŠ¸ ìƒì„±
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ğŸ¯ ì»¤ì„œ ìë™ í…ŒìŠ¤íŠ¸ ê²°ê³¼\n\n';

            try {
              if (fs.existsSync('CURSOR_TEST_REPORT.md')) {
                const report = fs.readFileSync('CURSOR_TEST_REPORT.md', 'utf8');
                comment += report;
              } else {
                comment += 'í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
              }
            } catch (error) {
              comment += `ë³´ê³ ì„œ ì½ê¸° ì‹¤íŒ¨: ${error.message}`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  quick-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“‹ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: âš¡ ë¹ ë¥¸ ê²€ì¦
        run: |
          npm run cursor:validate
          npm run test:unit
        env:
          CI: true
          NODE_ENV: test
          FORCE_MOCK_REDIS: true
          FORCE_MOCK_GOOGLE_AI: true
          DISABLE_HEALTH_CHECK: true
