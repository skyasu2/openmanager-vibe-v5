name: Security Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ

jobs:
  security-review:
    name: Automated Security Review
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js (Enhanced Caching)
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          .npmrc
    
    - name: Configure NPM for Rate Limiting Resilience
      run: |
        echo "ğŸ”§ NPM ì„¤ì • ìµœì í™” ì¤‘..."
        # GitHub Actions í™˜ê²½ì—ì„œ ì¶”ê°€ ìµœì í™”
        npm config set audit-level moderate
        npm config set fetch-retries 5
        npm config set fetch-timeout 300000
        npm config set maxsockets 10
        npm config set progress false
        echo "âœ… NPM ì„¤ì • ì™„ë£Œ"
        
    - name: Install dependencies
      run: npm ci
      
    - name: NPM Security Audit (429 Error Resilient)
      run: |
        echo "ğŸ” NPM ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰ ì¤‘..."
        
        # 429 Rate Limit ëŒ€ì‘ì„ ìœ„í•œ retry ë¡œì§
        npm_audit_with_retry() {
          local attempt=1
          local max_attempts=5
          local delay=10
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ NPM audit ì‹œë„ $attempt/$max_attempts..."
            
            # npm audit ì‹¤í–‰
            if npm audit --audit-level=high 2>&1; then
              echo "âœ… NPM audit ì„±ê³µ!"
              return 0
            else
              local exit_code=$?
              if [ $exit_code -eq 1 ]; then
                echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬ (ì •ìƒì ì¸ ì‹¤íŒ¨)"
                return 1
              fi
              
              # 429 ì—ëŸ¬ í™•ì¸
              if npm audit --audit-level=high 2>&1 | grep -q "429\|Too Many Requests\|Rate limit"; then
                echo "âš ï¸ Rate limit ê°ì§€ - ${delay}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                sleep $delay
                delay=$((delay * 2))  # ì§€ìˆ˜ ë°±ì˜¤í”„
                attempt=$((attempt + 1))
              else
                echo "âŒ NPM audit ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì•„ë‹˜)"
                return $exit_code
              fi
            fi
          done
          
          echo "ğŸ”„ ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨ - ëŒ€ì•ˆ ë°©ë²• ì‚¬ìš©"
          return 1
        }
        
        # ë©”ì¸ audit ì‹¤í–‰
        if npm_audit_with_retry; then
          echo "âœ… NPM ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"
        else
          echo "âš ï¸ NPM audit ì‹¤íŒ¨ - ëŒ€ì•ˆ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰"
          
          # ëŒ€ì•ˆ 1: npm lsë¥¼ í†µí•œ ì˜ì¡´ì„± í™•ì¸
          echo "ğŸ” ëŒ€ì•ˆ ê²€ì‚¬: npm lsë¥¼ í†µí•œ ì˜ì¡´ì„± ë¶„ì„..."
          npm ls --audit || true
          
          # ëŒ€ì•ˆ 2: package.json ì§ì ‘ ë¶„ì„
          echo "ğŸ” ëŒ€ì•ˆ ê²€ì‚¬: ì•Œë ¤ì§„ ì·¨ì•½í•œ íŒ¨í‚¤ì§€ íŒ¨í„´ í™•ì¸..."
          if grep -E "(lodash.*4\.[0-9]\.[0-9]|moment.*2\.29\.[0-3]|axios.*0\.[0-2][0-9])" package.json; then
            echo "âš ï¸ ì•Œë ¤ì§„ ì·¨ì•½ ë²„ì „ íŒ¨í„´ ë°œê²¬"
          else
            echo "âœ… ì£¼ìš” ì·¨ì•½ íŒ¨í„´ ì—†ìŒ"
          fi
          
          # ëŒ€ì•ˆ 3: ìˆ˜ë™ ì·¨ì•½ì  ì²´í¬
          echo "ğŸ” ëŒ€ì•ˆ ê²€ì‚¬: í•µì‹¬ ë³´ì•ˆ íŒ¨í‚¤ì§€ í™•ì¸..."
          if npm list --depth=0 2>&1 | grep -E "(helmet|cors|express-rate-limit|bcrypt)"; then
            echo "âœ… ë³´ì•ˆ ê´€ë ¨ íŒ¨í‚¤ì§€ ì„¤ì¹˜ë¨"
          else
            echo "âš ï¸ ê¶Œì¥ ë³´ì•ˆ íŒ¨í‚¤ì§€ ë¯¸ì„¤ì¹˜"
          fi
          
          # ê²½ê³ ë§Œ í‘œì‹œí•˜ê³  ê³„ì† ì§„í–‰
          echo "âš ï¸ NPM auditì´ ì‹¤íŒ¨í–ˆì§€ë§Œ ëŒ€ì•ˆ ê²€ì‚¬ ì™„ë£Œ - ì›Œí¬í”Œë¡œìš° ê³„ì† ì§„í–‰"
        fi
        
    - name: Check for hardcoded secrets
      run: |
        echo "ğŸ” í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬ ì¤‘..."
        
        # API í‚¤ íŒ¨í„´ ê²€ì‚¬
        if grep -r "api_key\s*=\s*['\"][a-zA-Z0-9_-]\{10,\}" src/ --include="*.ts" --include="*.tsx" --include="*.js"; then
          echo "âŒ Hardcoded API keys found!"
          exit 1
        fi
        
        # ë¹„ë°€ë²ˆí˜¸ íŒ¨í„´ ê²€ì‚¬
        if grep -r "password\s*=\s*['\"][^'\"]\{5,\}" src/ --include="*.ts" --include="*.tsx"; then
          echo "âŒ Hardcoded passwords found!"
          exit 1
        fi
        
        # í† í° íŒ¨í„´ ê²€ì‚¬
        if grep -r "token\s*=\s*['\"][a-zA-Z0-9_-]\{20,\}" src/ --include="*.ts" --include="*.tsx"; then
          echo "âŒ Hardcoded tokens found!"
          exit 1
        fi
        
        echo "âœ… í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ì—†ìŒ"
        
    - name: TypeScript Security Check
      run: |
        echo "ğŸ” TypeScript ë³´ì•ˆ ê²€ì‚¬ ì¤‘..."
        
        # any íƒ€ì… ì‚¬ìš© ê²€ì‚¬
        ANY_COUNT=$(grep -r ": any\b\|as any\b\|<any>" src/ --include="*.ts" --include="*.tsx" | wc -l)
        if [ "$ANY_COUNT" -gt 0 ]; then
          echo "âš ï¸ Found $ANY_COUNT uses of 'any' type - ë³´ì•ˆ ìœ„í—˜"
          echo "ìƒì„¸ ë‚´ìš©:"
          grep -r ": any\b\|as any\b\|<any>" src/ --include="*.ts" --include="*.tsx" | head -10
        else
          echo "âœ… any íƒ€ì… ì‚¬ìš© ì—†ìŒ"
        fi
        
    - name: Security Headers Check
      run: |
        echo "ğŸ” ë³´ì•ˆ í—¤ë” ì„¤ì • í™•ì¸ ì¤‘..."
        
        # Next.js ë³´ì•ˆ í—¤ë” ì„¤ì • í™•ì¸
        if [ -f "next.config.js" ] || [ -f "next.config.mjs" ] || [ -f "next.config.ts" ]; then
          echo "âœ… Next.js config íŒŒì¼ ì¡´ì¬"
          if grep -q "X-Content-Type-Options\|X-Frame-Options\|X-XSS-Protection\|Content-Security-Policy" next.config.*; then
            echo "âœ… ë³´ì•ˆ í—¤ë” ì„¤ì •ë¨"
          else
            echo "âš ï¸ ë³´ì•ˆ í—¤ë” ë¯¸ì„¤ì • - ê¶Œì¥ì‚¬í•­"
          fi
        else
          echo "âš ï¸ Next.js config íŒŒì¼ ì—†ìŒ"
        fi
        
    - name: Environment Variables Check
      run: |
        echo "ğŸ” í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸ ì¤‘..."
        
        # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í…œí”Œë¦¿ í™•ì¸
        if [ -f ".env.local.template" ]; then
          echo "âœ… í™˜ê²½ë³€ìˆ˜ í…œí”Œë¦¿ ì¡´ì¬"
          
          # í™˜ê²½ë³€ìˆ˜ê°€ ì½”ë“œì—ì„œ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©ë˜ëŠ”ì§€ í™•ì¸
          ENV_VARS=$(grep -o "NEXT_PUBLIC_[A-Z_]*\|[A-Z_]*_API_KEY\|[A-Z_]*_SECRET" .env.local.template 2>/dev/null || true)
          if [ -n "$ENV_VARS" ]; then
            echo "í…œí”Œë¦¿ì— ì •ì˜ëœ í™˜ê²½ë³€ìˆ˜ë“¤ì´ ì½”ë“œì—ì„œ ì‚¬ìš©ë˜ëŠ”ì§€ í™•ì¸:"
            echo "$ENV_VARS" | while read var; do
              if grep -q "process\.env\.$var\|env\.$var" src/ --include="*.ts" --include="*.tsx" -r; then
                echo "  âœ… $var: ì‚¬ìš©ë¨"
              else
                echo "  âš ï¸ $var: ì‚¬ìš©ë˜ì§€ ì•ŠìŒ"
              fi
            done
          fi
        else
          echo "âš ï¸ .env.local.template íŒŒì¼ ì—†ìŒ"
        fi
        
    - name: API Route Security Check
      run: |
        echo "ğŸ” API ë¼ìš°íŠ¸ ë³´ì•ˆ ê²€ì‚¬ ì¤‘..."
        
        # API ë¼ìš°íŠ¸ íŒŒì¼ ì°¾ê¸°
        if [ -d "src/app/api" ]; then
          API_FILES=$(find src/app/api -name "*.ts" -exec grep -l "export.*function.*GET\|POST\|PUT\|DELETE" {} \;)
          
          if [ -n "$API_FILES" ]; then
            echo "ë°œê²¬ëœ API ë¼ìš°íŠ¸:"
            UNPROTECTED=0
            
            echo "$API_FILES" | while read file; do
              echo "  ê²€ì‚¬ ì¤‘: $file"
              # ì¸ì¦ ê´€ë ¨ ì½”ë“œ í™•ì¸
              if grep -q "getServerSession\|authenticate\|auth\|jwt\|token" "$file"; then
                echo "    âœ… ì¸ì¦ ë¡œì§ ì¡´ì¬"
              else
                echo "    âš ï¸ ì¸ì¦ ë¡œì§ ì—†ìŒ - ê³µê°œ APIì¸ì§€ í™•ì¸ í•„ìš”"
                UNPROTECTED=$((UNPROTECTED + 1))
              fi
            done
            
            if [ "$UNPROTECTED" -gt 0 ]; then
              echo "âš ï¸ $UNPROTECTEDê°œì˜ API ë¼ìš°íŠ¸ì—ì„œ ì¸ì¦ ë¡œì§ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            fi
          else
            echo "âœ… API ë¼ìš°íŠ¸ íŒŒì¼ ì—†ìŒ"
          fi
        else
          echo "âœ… API ë””ë ‰í† ë¦¬ ì—†ìŒ"
        fi
        
    - name: Database Security Check
      run: |
        echo "ğŸ” ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ ì„¤ì • í™•ì¸ ì¤‘..."
        
        # SQL ì¸ì ì…˜ ì·¨ì•½ì  íŒ¨í„´ ê²€ì‚¬
        SQL_ISSUES=$(grep -r "\`.*\${.*}\`\|query.*+.*\|execute.*+.*" src/ --include="*.ts" --include="*.tsx" | grep -v "test\|spec" || true)
        if [ -n "$SQL_ISSUES" ]; then
          echo "âš ï¸ SQL ì¸ì ì…˜ ìœ„í—˜ íŒ¨í„´ ë°œê²¬:"
          echo "$SQL_ISSUES"
        else
          echo "âœ… SQL ì¸ì ì…˜ ìœ„í—˜ íŒ¨í„´ ì—†ìŒ"
        fi
        
        # Supabase RLS ì •ì±… í™•ì¸
        if grep -r "supabase\|from.*select\|from.*insert\|from.*update\|from.*delete" src/ --include="*.ts" --include="*.tsx" | grep -v "test\|spec" >/dev/null; then
          echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ë°œê²¬ - RLS ì •ì±… ì„¤ì • í™•ì¸ ê¶Œì¥"
        fi
        
    - name: Create Security Report
      if: always()
      run: |
        # ë³´ê³ ì„œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p reports
        
        # ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
        cat > reports/security-report.md << EOF
        # ğŸ›¡ï¸ Security Review Report
        
        **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Branch**: ${{ github.head_ref || github.ref_name }}
        **Commit**: ${{ github.sha }}
        **Workflow**: Security Review
        
        ## ğŸ“Š Scan Results
        
        ### NPM Audit Summary
        \`\`\`bash
        $(npm audit --json 2>/dev/null | jq -r 'if .vulnerabilities then "Vulnerabilities found: " + (.vulnerabilities | length | tostring) else "No vulnerabilities" end' || echo "No vulnerabilities")
        \`\`\`
        
        ### Code Security Analysis
        - **Hardcoded secrets**: $(grep -r "api_key\|password\|secret.*=" src/ --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l || echo "0") potential issues
        - **TypeScript 'any' usage**: $(grep -r ": any\b\|as any\b" src/ --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l || echo "0") instances
        - **API routes**: $(find src/app/api -name "*.ts" 2>/dev/null | wc -l || echo "0") files found
        - **Environment template**: $(if [ -f ".env.local.template" ]; then echo "âœ… Exists"; else echo "âŒ Missing"; fi)
        
        ### Security Headers
        - **Next.js config**: $(if [ -f "next.config.js" ] || [ -f "next.config.mjs" ] || [ -f "next.config.ts" ]; then echo "âœ… Found"; else echo "âŒ Missing"; fi)
        - **Security headers**: $(if grep -q "X-Content-Type-Options\|X-Frame-Options\|X-XSS-Protection" next.config.* 2>/dev/null; then echo "âœ… Configured"; else echo "âš ï¸ Not configured"; fi)
        
        ## ğŸ”§ Recommendations
        
        ### Immediate Actions (High Priority)
        1. **Update vulnerable dependencies** - Run \`npm audit fix\`
        2. **Remove hardcoded secrets** - Use environment variables
        3. **Eliminate 'any' types** - Improve type safety
        
        ### Short-term Improvements
        1. **Add security headers** - Configure in Next.js config
        2. **API authentication** - Ensure all sensitive endpoints are protected  
        3. **Environment variables** - Create .env.local.template if missing
        
        ### Long-term Security
        1. **Regular security scans** - Weekly automated reviews
        2. **Dependency monitoring** - Automated updates
        3. **Security training** - Team awareness
        
        ## ğŸš€ Quick Fixes
        
        \`\`\`bash
        # NPM ì·¨ì•½ì  ìˆ˜ì •
        npm audit fix
        
        # Claude Code ë‚´ì¥ ë³´ì•ˆ ì ê²€
        claude /security-review
        
        # ì¢…í•© ë³´ì•ˆ ê²€ì‚¬
        npm run security:audit
        \`\`\`
        
        ---
        *Generated by Security Auditor Agent - Claude Code v1.0.72+*
        
        **ë³´ì•ˆ ë¬¸ì˜**: ì´ ë¦¬í¬íŠ¸ì— ëŒ€í•œ ì§ˆë¬¸ì´ë‚˜ false positive ì‹ ê³ ëŠ” GitHub Issuesë¥¼ í†µí•´ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
        EOF
        
    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report-${{ github.sha }}
        path: reports/security-report.md
        retention-days: 30
        
    - name: Comment PR with Security Report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          if (fs.existsSync('reports/security-report.md')) {
            const report = fs.readFileSync('reports/security-report.md', 'utf8');
            
            // ê¸°ì¡´ ë³´ì•ˆ ë¦¬í¬íŠ¸ ëŒ“ê¸€ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Security Review Report')
            );
            
            if (botComment) {
              // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // ìƒˆ ëŒ“ê¸€ ìƒì„±
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }
          }
          
    - name: Set Security Status
      if: always()
      run: |
        # ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ì— ë”°ë¥¸ ìƒíƒœ ì„¤ì •
        CRITICAL_ISSUES=0
        
        # NPM ê³ ìœ„í—˜ ì·¨ì•½ì  í™•ì¸
        if npm audit --audit-level=high --json | jq -e '.vulnerabilities | length > 0' >/dev/null 2>&1; then
          CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
          echo "âŒ ê³ ìœ„í—˜ NPM ì·¨ì•½ì  ë°œê²¬"
        fi
        
        # í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ í™•ì¸
        if grep -r "api_key\s*=\s*['\"][a-zA-Z0-9_-]\{10,\}\|password\s*=\s*['\"][^'\"]\{5,\}\|token\s*=\s*['\"][a-zA-Z0-9_-]\{20,\}" src/ --include="*.ts" --include="*.tsx" --include="*.js" >/dev/null 2>&1; then
          CRITICAL_ISSUES=$((CRITICAL_ISSUES + 1))
          echo "âŒ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ë°œê²¬"
        fi
        
        if [ "$CRITICAL_ISSUES" -gt 0 ]; then
          echo "::error::$CRITICAL_ISSUES critical security issues found"
          echo "SECURITY_STATUS=critical" >> $GITHUB_ENV
        else
          echo "âœ… ì¤‘ìš” ë³´ì•ˆ ë¬¸ì œ ì—†ìŒ"
          echo "SECURITY_STATUS=passed" >> $GITHUB_ENV
        fi