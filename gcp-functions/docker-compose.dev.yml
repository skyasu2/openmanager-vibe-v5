version: '3.8'

# Cloud Run Services - Local Development Environment
# All services are Flask + Gunicorn based (Cloud Run compatible)
# Usage: docker-compose -f docker-compose.dev.yml up --build
# Or use: ./scripts/dev/run-docker-functions.sh

services:
  # ML Analytics Engine - Time Series & Anomaly Detection
  ml-analytics-engine:
    build:
      context: ./ml-analytics-engine
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    volumes:
      # Mount source code for live reloading
      - ./ml-analytics-engine:/app
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8080
      - FLASK_DEBUG=true
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Enhanced Korean NLP - Intent & Entity Extraction
  enhanced-korean-nlp:
    build:
      context: ./enhanced-korean-nlp
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
    volumes:
      - ./enhanced-korean-nlp:/app
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8080
      - FLASK_DEBUG=true
      - JAVA_HOME=/usr/lib/jvm/default-java
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # Unified AI Processor - Orchestration & Aggregation
  unified-ai-processor:
    build:
      context: ./unified-ai-processor
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    volumes:
      - ./unified-ai-processor:/app
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8080
      - FLASK_DEBUG=true
      - JAVA_HOME=/usr/lib/jvm/default-java
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    # Note: unified-ai-processor has local engines, no network dependency

# Network configuration (optional - all containers can communicate)
networks:
  default:
    name: cloud-run-dev
