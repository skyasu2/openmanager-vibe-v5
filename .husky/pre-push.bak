#!/usr/bin/env sh
# Husky pre-push hook
echo "ðŸš€ Pre-push ê²€ì¦ ì‹œìž‘..."

# ðŸš¨ ë°±ê·¸ë¼ìš´ë“œì—ì„œ 30ì´ˆ íƒ€ìž„ì•„ì›ƒ ì„¤ì •
(
  sleep 120
  echo "â° Pre-push íƒ€ìž„ì•„ì›ƒ (2ë¶„) - ê²€ì¦ ì¤‘ë‹¨"
  pkill -f "npm run validate:all" 2>/dev/null || true
  pkill -f "vitest" 2>/dev/null || true
  pkill -f "tsc" 2>/dev/null || true
  exit 1
) &
TIMEOUT_PID=$!

# ì „ì²´ ê²€ì¦ (íƒ€ìž… ì²´í¬ + ë¦°íŠ¸ + í…ŒìŠ¤íŠ¸)
echo "ðŸ” ì „ì²´ í’ˆì§ˆ ê²€ì‚¬..."
timeout 100s npm run validate:all
VALIDATE_EXIT_CODE=$?

# ë°±ê·¸ë¼ìš´ë“œ íƒ€ìž„ì•„ì›ƒ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
kill $TIMEOUT_PID 2>/dev/null || true

if [ $VALIDATE_EXIT_CODE -ne 0 ]; then
  echo "âŒ ê²€ì¦ ì‹¤íŒ¨! ë‹¤ìŒ í•­ëª©ë“¤ì„ í™•ì¸í•˜ì„¸ìš”:"
  echo "   - TypeScript íƒ€ìž… ì—ëŸ¬"
  echo "   - ESLint ì—ëŸ¬"
  echo "   - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
  echo "   - ë¹Œë“œ ì‹¤íŒ¨"
  
  # ðŸ§¹ ë‚¨ì€ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
  pkill -f "vitest" 2>/dev/null || true
  pkill -f "node.*test" 2>/dev/null || true
  
  exit 1
fi

echo "âœ… Pre-push ê²€ì¦ ì™„ë£Œ! ðŸŽ‰"

# ðŸ§¹ ìµœì¢… í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
pkill -f "vitest" 2>/dev/null || true
pkill -f "node.*test" 2>/dev/null || true 