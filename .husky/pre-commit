#!/bin/sh

echo "ğŸš€ Pre-commit ê²€ì¦ ì‹œì‘..."

# í™˜ê²½ ë³€ìˆ˜ë¡œ ìŠ¤í‚µ ê°€ëŠ¥
if [ "$HUSKY" = "0" ]; then
    echo "â­ï¸  Huskyê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê²€ì¦ì„ ê±´ë„ˆëœë‹ˆë‹¤."
    exit 0
fi

# lint-staged ì‹¤í–‰ (ë³€ê²½ëœ íŒŒì¼ë§Œ ê²€ì‚¬) - ì„±ëŠ¥ ìµœì í™”
echo "ğŸ§¹ ë³€ê²½ëœ íŒŒì¼ ê²€ì‚¬ ì¤‘... (ì„±ëŠ¥ ìµœì í™” ëª¨ë“œ)"
# ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ --concurrent ì˜µì…˜ ì¶”ê°€
npx lint-staged --concurrent --relative

if [ $? -ne 0 ]; then
    echo "âŒ Pre-commit ê²€ì¦ ì‹¤íŒ¨!"
    echo "ğŸ’¡ ì„±ëŠ¥ ìµœì í™”ëœ ì„¤ì •ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ë¬¸ì œê°€ ìˆìœ¼ë©´ npm run lint:fix ì‹¤í–‰ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
    exit 1
fi

# ë³´ì•ˆ ê²€ì‚¬ (í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬)
echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ ì¤‘..."
if [ -f "scripts/check-hardcoded-secrets.sh" ]; then
    bash scripts/check-hardcoded-secrets.sh
    if [ $? -ne 0 ]; then
        echo "âŒ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨! í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
        exit 1
    fi
fi

# ë¬¸ì„œ íŒŒì¼ ì‹œí¬ë¦¿ ê²€ì‚¬ (ì„ íƒì‚¬í•­)
if [ -f "scripts/security/check-secrets-in-docs.sh" ]; then
    echo "ğŸ“„ ë¬¸ì„œ íŒŒì¼ ì‹œí¬ë¦¿ ê²€ì‚¬ ì¤‘..."
    bash scripts/security/check-secrets-in-docs.sh
    if [ $? -ne 0 ]; then
        echo "âŒ ë¬¸ì„œ íŒŒì¼ì—ì„œ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ’¡ í† í°ì„ [REDACTED]ë¡œ êµì²´í•˜ê±°ë‚˜ ì˜ˆì‹œ í˜•ì‹ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”."
        exit 1
    fi
fi

# TDD ë©”íƒ€ë°ì´í„° ê²€ì‚¬ (ì„ íƒì‚¬í•­)
if [ -f "scripts/test-metadata.ts" ]; then
    echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ë©”íƒ€ë°ì´í„° ê²€ì‚¬ ì¤‘..."
    npm run test:metadata --silent || {
        echo "âš ï¸  ì˜¤ë˜ëœ skip í…ŒìŠ¤íŠ¸ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
        echo "ğŸ’¡ test-metadata-report.mdë¥¼ í™•ì¸í•˜ì—¬ 30ì¼ ì´ìƒëœ skip í…ŒìŠ¤íŠ¸ë¥¼ ì •ë¦¬í•´ì£¼ì„¸ìš”."
        # ê²½ê³ ë§Œ í•˜ê³  ì»¤ë°‹ì€ í—ˆìš© (exit 1 í•˜ì§€ ì•ŠìŒ)
    }
fi

# TDD RED â†’ GREEN ì „í™˜ ê²€ì‚¬ (ì„ íƒì‚¬í•­)
if [ -f "scripts/tdd-cleanup.ts" ]; then
    echo "ğŸ”„ TDD í…ŒìŠ¤íŠ¸ ìƒíƒœ ê²€ì‚¬ ì¤‘..."
    npm run test:tdd-check --silent || {
        CLEANUP_NEEDED=$?
        if [ $CLEANUP_NEEDED -eq 0 ]; then
            echo "âš ï¸  GREENìœ¼ë¡œ ì „í™˜ëœ TDD í…ŒìŠ¤íŠ¸ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ 'npm run test:tdd-cleanup'ì„ ì‹¤í–‰í•˜ì—¬ @tdd-red íƒœê·¸ë¥¼ ì œê±°í•˜ì„¸ìš”."
            # ê°œë°œìì—ê²Œ ì•Œë¦¼ë§Œ ì œê³µ (ì»¤ë°‹ì€ í—ˆìš©)
        fi
    }
fi

echo "âœ… Pre-commit ê²€ì¦ í†µê³¼!"