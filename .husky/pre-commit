#!/usr/bin/env bash

# Pre-commit Hook: Code Quality + Serena Anti-pattern Detection
# ëª©ì : 1) ESLint/Prettier ìë™ ìˆ˜ì • (staged filesë§Œ)
#      2) ì»¨í…ìŠ¤íŠ¸ ì••ì¶• ë°©ì§€ (Serena ì•ˆí‹°íŒ¨í„´)

set -e

# 1. lint-staged: ESLint + Prettier (fast, staged files only)
echo "ğŸ” Running lint-staged (ESLint + Prettier)..."
npx lint-staged || {
  echo "âŒ Linting/Formatting failed"
  echo "ğŸ’¡ Some files were auto-fixed. Please review and re-add them."
  exit 1
}

# 2. Serena Anti-pattern Detection
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No staged files to check for Serena anti-patterns"
  exit 0
fi

echo "ğŸ” Serena ì•ˆí‹°íŒ¨í„´ ê²€ì‚¬ ì¤‘..."

ANTI_PATTERN_FOUND=0

# ì•ˆí‹°íŒ¨í„´ 1: Read() ë‚¨ë°œ (500ì¤„+ íŒŒì¼)
echo "  â”œâ”€ Read() ë‚¨ë°œ ê²€ì‚¬..."
for FILE in $STAGED_FILES; do
  # Read() í˜¸ì¶œì—ì„œ "500ì¤„", "1000ì¤„" ë“± í° íŒŒì¼ ì£¼ì„ íƒì§€
  if grep -n "Read(.*\/\/.*(500|1000|2000)ì¤„" "$FILE" 2>/dev/null; then
    echo "  â”‚  âŒ $FILE: Read() ë‚¨ë°œ ë°œê²¬ (500ì¤„+ íŒŒì¼)"
    echo "  â”‚     â†’ Serena get_symbols_overview() ì‚¬ìš© ê¶Œì¥"
    ANTI_PATTERN_FOUND=1
  fi
done

# ì•ˆí‹°íŒ¨í„´ 2: recursive:true without skip_ignored_files
echo "  â”œâ”€ recursive:true ê²€ì‚¬..."
for FILE in $STAGED_FILES; do
  # list_dir ë¸”ë¡ ë‚´ì—ì„œ recursive:true ìˆì§€ë§Œ skip_ignored_files ì—†ëŠ” ê²½ìš°
  if grep -Pzo "list_dir\([^)]*recursive:\s*true(?![\s\S]*skip_ignored_files)" "$FILE" 2>/dev/null; then
    echo "  â”‚  âŒ $FILE: recursive:true without skip_ignored_files"
    echo "  â”‚     â†’ skip_ignored_files: true ì¶”ê°€ í•„ìˆ˜ (48ë°° ë¹ ë¦„)"
    ANTI_PATTERN_FOUND=1
  fi
done

# ì•ˆí‹°íŒ¨í„´ 3: ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ìŠ¤ìº”
echo "  â”œâ”€ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ìŠ¤ìº” ê²€ì‚¬..."
for FILE in $STAGED_FILES; do
  # list_dirì—ì„œ relative_path: "." ë˜ëŠ” "" ì‚¬ìš©
  if grep -n 'list_dir.*relative_path.*["\x27]\.["\x27]' "$FILE" 2>/dev/null || \
     grep -n 'list_dir.*relative_path.*["\x27]["\x27]' "$FILE" 2>/dev/null; then
    echo "  â”‚  âŒ $FILE: ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ìŠ¤ìº” ë°œê²¬"
    echo "  â”‚     â†’ íŠ¹ì • ë””ë ‰í† ë¦¬ë¡œ ì œí•œ (src/components ë“±)"
    ANTI_PATTERN_FOUND=1
  fi
done

# ì•ˆí‹°íŒ¨í„´ 4: ê´‘ë²”ìœ„í•œ íŒ¨í„´ ê²€ìƒ‰
echo "  â””â”€ ê´‘ë²”ìœ„í•œ íŒ¨í„´ ê²€ìƒ‰ ê²€ì‚¬..."
for FILE in $STAGED_FILES; do
  # search_for_patternì—ì„œ relative_path ì—†ì´ ì§§ì€ íŒ¨í„´ ì‚¬ìš©
  if grep -Pzo "search_for_pattern\([^)]*substring_pattern.*[\"'][^\"']{1,3}[\"'](?![\s\S]*relative_path)" "$FILE" 2>/dev/null; then
    echo "     âŒ $FILE: ê´‘ë²”ìœ„í•œ íŒ¨í„´ ê²€ìƒ‰ ë°œê²¬"
    echo "        â†’ relative_pathë¡œ ë²”ìœ„ ì œí•œ í•„ìˆ˜"
    ANTI_PATTERN_FOUND=1
  fi
done

if [ $ANTI_PATTERN_FOUND -eq 1 ]; then
  echo ""
  echo "âŒ Serena ì•ˆí‹°íŒ¨í„´ ë°œê²¬!"
  echo ""
  echo "ğŸ“š ì°¸ì¡° ë¬¸ì„œ:"
  echo "  - docs/claude/environment/mcp/serena-tools-comprehensive-guide.md"
  echo "  - docs/claude/environment/mcp/mcp-priority-guide.md"
  echo ""
  echo "âš ï¸  ì»¨í…ìŠ¤íŠ¸ ì••ì¶• ë°©ì§€ ê·œì¹™:"
  echo "  1. Read() ëŒ€ì‹  Serena get_symbols_overview() ì‚¬ìš© (500ì¤„+)"
  echo "  2. list_dir + recursive:true ì‹œ skip_ignored_files:true í•„ìˆ˜"
  echo "  3. search_for_pattern ì‹œ relative_pathë¡œ ë²”ìœ„ ì œí•œ"
  echo "  4. ë£¨íŠ¸ ë””ë ‰í† ë¦¬(.) ìŠ¤ìº” ê¸ˆì§€"
  echo ""
  echo "ğŸ’¡ ìˆ˜ì • í›„ ë‹¤ì‹œ ì»¤ë°‹í•˜ì„¸ìš”."
  exit 1
fi

echo "âœ… Serena ì•ˆí‹°íŒ¨í„´ ê²€ì‚¬ í†µê³¼!"
exit 0
