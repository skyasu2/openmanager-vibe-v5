#!/bin/sh

echo "ğŸš€ Pre-commit ê²€ì¦ ì‹œì‘..."

# í™˜ê²½ ë³€ìˆ˜ë¡œ ìŠ¤í‚µ ê°€ëŠ¥
if [ "$HUSKY" = "0" ]; then
    echo "â­ï¸  Huskyê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê²€ì¦ì„ ê±´ë„ˆëœë‹ˆë‹¤."
    exit 0
fi

# lint-staged ì‹¤í–‰ (ë³€ê²½ëœ íŒŒì¼ë§Œ ê²€ì‚¬) - ì„±ëŠ¥ ìµœì í™”
echo "ğŸ§¹ ë³€ê²½ëœ íŒŒì¼ ê²€ì‚¬ ì¤‘... (ì„±ëŠ¥ ìµœì í™” ëª¨ë“œ)"
# ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ --concurrent ì˜µì…˜ ì¶”ê°€ (ê¸°ë³¸ê°’ true)
npx lint-staged --concurrent=true

if [ $? -ne 0 ]; then
    echo "âŒ Pre-commit ê²€ì¦ ì‹¤íŒ¨!"
    echo "ğŸ’¡ ì„±ëŠ¥ ìµœì í™”ëœ ì„¤ì •ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ë¬¸ì œê°€ ìˆìœ¼ë©´ npm run lint:fix ì‹¤í–‰ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
    echo ""
    echo "ğŸ¤– ì„œë¸Œì—ì´ì „íŠ¸ ì¶”ì²œ:"
    echo "   - ì½”ë“œ í’ˆì§ˆ ê²€í† : Task({ subagent_type: 'code-review-specialist', prompt: 'Lint ì—ëŸ¬ ìˆ˜ì •' })"
    echo "   - í”„ë¡œì íŠ¸ ê·œì¹™: Task({ subagent_type: 'quality-control-checker', prompt: 'CLAUDE.md ê·œì¹™ ì¤€ìˆ˜ ê²€ì¦' })"
    exit 1
fi

# Storybook ìŠ¤í† ë¦¬ íŒŒì¼ ê²€ì¦ (ìˆëŠ” ê²½ìš°ë§Œ)
STORY_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.stories\.(ts|tsx|js|jsx)$' || true)
if [ -n "$STORY_FILES" ]; then
    echo "ğŸ“š Storybook ìŠ¤í† ë¦¬ íŒŒì¼ ê²€ì¦ ì¤‘..."
    echo "   ê²€ì‚¬ ëŒ€ìƒ: $(echo "$STORY_FILES" | wc -l)ê°œ íŒŒì¼"
    
    # ìŠ¤í† ë¦¬ íŒŒì¼ì— ëŒ€í•œ íŠ¹ë³„í•œ ESLint ê·œì¹™ ì ìš©
    npx eslint --ext .stories.ts,.stories.tsx --plugin storybook --max-warnings 5 $STORY_FILES || {
        echo "âŒ Storybook ìŠ¤í† ë¦¬ íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨!"
        echo ""
        echo "ğŸ¤– ì„œë¸Œì—ì´ì „íŠ¸ ì¶”ì²œ:"
        echo "   - ì½”ë“œ í’ˆì§ˆ: Task({ subagent_type: 'code-review-specialist', prompt: 'Storybook ìŠ¤í† ë¦¬ íŒŒì¼ ESLint ì—ëŸ¬ ìˆ˜ì •' })"
        echo "   - UI ì»´í¬ë„ŒíŠ¸: Task({ subagent_type: 'ux-performance-optimizer', prompt: 'Storybook ìŠ¤í† ë¦¬ ì ‘ê·¼ì„± ê²€ì¦' })"
        exit 1
    }
    echo "âœ… Storybook ìŠ¤í† ë¦¬ íŒŒì¼ ê²€ì¦ í†µê³¼"
fi

# ë³´ì•ˆ ê²€ì‚¬ (í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬)
echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ ì¤‘..."
if [ -f "scripts/check-hardcoded-secrets.sh" ]; then
    bash scripts/check-hardcoded-secrets.sh
    if [ $? -ne 0 ]; then
        echo "âŒ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨! í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
        echo ""
        echo "ğŸ¤– ì„œë¸Œì—ì´ì „íŠ¸ ì¶”ì²œ:"
        echo "   - ë³´ì•ˆ ê°ì‚¬: Task({ subagent_type: 'security-auditor', prompt: 'í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ì œê±° ë° í™˜ê²½ë³€ìˆ˜ë¡œ ëŒ€ì²´' })"
        exit 1
    fi
fi

# ë¬¸ì„œ íŒŒì¼ ì‹œí¬ë¦¿ ê²€ì‚¬ (ì„ íƒì‚¬í•­)
if [ -f "scripts/security/check-secrets-in-docs.sh" ]; then
    echo "ğŸ“„ ë¬¸ì„œ íŒŒì¼ ì‹œí¬ë¦¿ ê²€ì‚¬ ì¤‘..."
    bash scripts/security/check-secrets-in-docs.sh
    if [ $? -ne 0 ]; then
        echo "âŒ ë¬¸ì„œ íŒŒì¼ì—ì„œ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ’¡ í† í°ì„ [REDACTED]ë¡œ êµì²´í•˜ê±°ë‚˜ ì˜ˆì‹œ í˜•ì‹ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”."
        exit 1
    fi
fi

# TDD ë©”íƒ€ë°ì´í„° ê²€ì‚¬ (SKIP_TDD_CHECK=1ë¡œ ê±´ë„ˆë›¸ ìˆ˜ ìˆìŒ)
if [ "$SKIP_TDD_CHECK" != "1" ] && [ -f "scripts/test-metadata.ts" ]; then
    echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ë©”íƒ€ë°ì´í„° ê²€ì‚¬ ì¤‘... (SKIP_TDD_CHECK=1ë¡œ ê±´ë„ˆë›°ê¸° ê°€ëŠ¥)"
    # íƒ€ì„ì•„ì›ƒ 5ì´ˆë¡œ ì œí•œí•˜ì—¬ ë¹ ë¥¸ ê²€ì‚¬ë§Œ
    timeout 5s npm run test:metadata --silent || {
        echo "âš ï¸  í…ŒìŠ¤íŠ¸ ë©”íƒ€ë°ì´í„° ê²€ì‚¬ê°€ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆê±°ë‚˜ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤."
        echo "ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰: npm run test:metadata"
        echo "ğŸ’¡ ê±´ë„ˆë›°ê¸°: SKIP_TDD_CHECK=1 git commit"
        # ê²½ê³ ë§Œ í•˜ê³  ì»¤ë°‹ì€ í—ˆìš©
    }
fi

# TDD RED â†’ GREEN ì „í™˜ ê²€ì‚¬ (ê¸°ë³¸ì ìœ¼ë¡œ ê±´ë„ˆëœ€ - ë„ˆë¬´ ë¬´ê±°ì›€)
if [ "$ENABLE_TDD_CHECK" = "1" ] && [ -f "scripts/tdd-cleanup.ts" ]; then
    echo "ğŸ”„ TDD í…ŒìŠ¤íŠ¸ ìƒíƒœ ê²€ì‚¬ ì¤‘... (ë¬´ê±°ìš´ ì‘ì—… - ì„ íƒì  í™œì„±í™”)"
    timeout 10s npm run test:tdd-check --silent || {
        echo "âš ï¸  TDD ê²€ì‚¬ê°€ ì‹œê°„ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."
        echo "ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰: npm run test:tdd-check"
        # ê°œë°œìì—ê²Œ ì•Œë¦¼ë§Œ ì œê³µ (ì»¤ë°‹ì€ í—ˆìš©)
    }
else
    echo "â­ï¸  TDD ê²€ì‚¬ ê±´ë„ˆëœ€ (ENABLE_TDD_CHECK=1ë¡œ í™œì„±í™” ê°€ëŠ¥)"
fi

echo "âœ… Pre-commit ê²€ì¦ í†µê³¼!"