#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Pre-push: Smart validation (ë³€ê²½ëœ íŒŒì¼ë§Œ, ~20ì´ˆ ì˜ˆìƒ)..."
START_TIME=$(date +%s)

# 1. ë¹ ë¥¸ ìœ ë‹› í…ŒìŠ¤íŠ¸ (11ì´ˆ)
echo "ğŸ§ª Running quick tests..."
npm run test:super-fast || {
  echo "âŒ Tests failed"
  echo "ğŸ’¡ Fix: npm run test"
  exit 1
}

# 2. ë¯¼ê° íŒŒì¼ ì²´í¬ (ë³´ì•ˆ)
echo "ğŸ”’ Security check..."
if git diff origin/main...HEAD --name-only 2>/dev/null | grep -E '\.(env|key|pem)$'; then
  echo "âŒ ë¯¼ê°í•œ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
  exit 1
fi

# 3. package.json ê²€ì¦
echo "ğŸ“¦ Checking package.json..."
node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" || {
  echo "âŒ package.json has syntax errors"
  exit 1
}

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo "âœ… Pre-push validation passed in ${DURATION}s"
echo "ğŸš€ Ready to push"
echo "ğŸ’¡ Full validation (type-check + build + lint) will run in Vercel CI/CD"
