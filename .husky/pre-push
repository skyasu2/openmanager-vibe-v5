#!/usr/bin/env sh
# Husky pre-push hook
echo "🚀 Pre-push 검증 시작..."

# 🚨 백그라운드에서 30초 타임아웃 설정
(
  sleep 120
  echo "⏰ Pre-push 타임아웃 (2분) - 검증 중단"
  pkill -f "npm run validate:all" 2>/dev/null || true
  pkill -f "vitest" 2>/dev/null || true
  pkill -f "tsc" 2>/dev/null || true
  exit 1
) &
TIMEOUT_PID=$!

# 전체 검증 (타입 체크 + 린트 + 테스트)
echo "🔍 전체 품질 검사..."
timeout 100s npm run validate:all
VALIDATE_EXIT_CODE=$?

# 백그라운드 타임아웃 프로세스 종료
kill $TIMEOUT_PID 2>/dev/null || true

if [ $VALIDATE_EXIT_CODE -ne 0 ]; then
  echo "❌ 검증 실패! 다음 항목들을 확인하세요:"
  echo "   - TypeScript 타입 에러"
  echo "   - ESLint 에러"
  echo "   - 단위 테스트 실패"
  echo "   - 빌드 실패"
  
  # 🧹 남은 프로세스 정리
  pkill -f "vitest" 2>/dev/null || true
  pkill -f "node.*test" 2>/dev/null || true
  
  exit 1
fi

echo "✅ Pre-push 검증 완료! 🎉"

# 🧹 최종 프로세스 정리
pkill -f "vitest" 2>/dev/null || true
pkill -f "node.*test" 2>/dev/null || true 