#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Pre-push: Type-safe validation (~60ì´ˆ ì˜ˆìƒ)..."
START_TIME=$(date +%s)

# 1. ë¹ ë¥¸ ìœ ë‹› í…ŒìŠ¤íŠ¸ (11ì´ˆ)
echo "ğŸ§ª Running quick tests..."
npm run test:super-fast || {
  echo "âŒ Tests failed"
  echo "ğŸ’¡ Fix: npm run test"
  exit 1
}

# 2. TypeScript íƒ€ì… ì²´í¬ (CRITICAL - í”„ë¡œë•ì…˜ ì•ˆì „ì„±)
echo "ğŸ” Type checking..."
npm run type-check || {
  echo "âŒ TypeScript errors found - push blocked"
  echo "ğŸ’¡ Fix: npm run type-check"
  echo "âš ï¸  CRITICAL: Type errors must be fixed before push"
  echo "   (Vercel may deploy broken code if this is skipped)"
  exit 1
}

# 3. ë¯¼ê° íŒŒì¼ ì²´í¬ (ë³´ì•ˆ)
echo "ğŸ”’ Security check..."
if git diff origin/main...HEAD --name-only 2>/dev/null | grep -E '\.(env|key|pem)$'; then
  echo "âŒ ë¯¼ê°í•œ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
  exit 1
fi

# 4. package.json ê²€ì¦
echo "ğŸ“¦ Checking package.json..."
node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" || {
  echo "âŒ package.json has syntax errors"
  exit 1
}

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo "âœ… Pre-push validation passed in ${DURATION}s"
echo "ğŸš€ Ready to push - Type-safe guaranteed!"
echo "ğŸ’¡ CI will run: build + lint:strict"
echo "ğŸ›¡ï¸  Protection: Type errors blocked at local â†’ Vercel deployment safe"
