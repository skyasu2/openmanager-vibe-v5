#!/usr/bin/env bash

echo "ğŸ” Pre-push: Type-safe + Build validation (~90ì´ˆ ì˜ˆìƒ)..."
START_TIME=$(date +%s)

# 1. ë¹ ë¥¸ ìœ ë‹› í…ŒìŠ¤íŠ¸ (11ì´ˆ) - CRITICAL (opt-out with SKIP_TESTS=true)
echo "ğŸ§ª Running quick tests..."
TEST_STATUS="passed"
if [ "${SKIP_TESTS:-false}" = "true" ]; then
  TEST_STATUS="skipped"
  echo "âšª Tests skipped (SKIP_TESTS=true)"
  echo "âš ï¸  WARNING: Skipping tests may allow regressions to slip through"
else
  # Rollup ë°”ì´ë„ˆë¦¬ ì²´í¬ (WSL/Linux í™˜ê²½)
  if command -v uname \u003e/dev/null 2\u003e\u00261 \u0026\u0026 [ "$(uname -s)" = "Linux" ]; then
    # Linux í™˜ê²½ì—ì„œëŠ” ë°”ì´ë„ˆë¦¬ í™•ì¸
    if ! npm list @rollup/rollup-linux-x64-gnu \u003e/dev/null 2\u003e\u00261; then
      echo "âš ï¸  Rollup Linux binary not found"
      echo "   This is a known issue in WSL environments"
      echo "   Skipping tests (build validation will still run)"
      TEST_STATUS="skipped-rollup"
    else
      npm run test:super-fast || {
        TEST_STATUS="failed"
        echo "âŒ Tests failed - push blocked"
        echo ""
        echo "ğŸ’¡ Fix the test failures:"
        echo "   npm run test:super-fast"
        echo ""
        echo "âš ï¸  To bypass (not recommended):"
        echo "   SKIP_TESTS=true git push"
        exit 1
      }
    fi
  else
    # Windows/macOSì—ì„œëŠ” í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œë„
    npm run test:super-fast || {
      # Rollup ì—ëŸ¬ì¸ì§€ í™•ì¸
      if npm run test:super-fast 2\u003e\u00261 | grep -q "@rollup"; then
        echo "âš ï¸  Rollup binary issue detected"
        echo "   Tests skipped (build validation will still run)"
        echo ""
        echo "â„¹ï¸  To fix permanently:"
        echo "   - Windows: Install WSL and run from Linux"
        echo "   - Or use: SKIP_TESTS=true git push"
        TEST_STATUS="skipped-rollup"
      else
        TEST_STATUS="failed"
        echo "âŒ Tests failed - push blocked"
        echo ""
        echo "ğŸ’¡ Fix the test failures:"
        echo "   npm run test:super-fast"
        echo ""
        echo "âš ï¸  To bypass (not recommended):"
        echo "   SKIP_TESTS=true git push"
        exit 1
      fi
    }
  fi
fi

# 2. í”„ë¡œë•ì…˜ ë¹Œë“œ ê²€ì¦ (CRITICAL - Vercel ë°°í¬ ì „ ë¡œì»¬ ê²€ì¦, íƒ€ì… ì²´í¬ í¬í•¨)
# 2. í”„ë¡œë•ì…˜ ë¹Œë“œ ê²€ì¦ (CRITICAL - Vercel ë°°í¬ ì „ ë¡œì»¬ ê²€ì¦, íƒ€ì… ì²´í¬ í¬í•¨)
echo "ğŸ—ï¸ Build validation..."
if [ "${SKIP_BUILD:-false}" = "true" ]; then
  echo "âšª Build validation skipped (SKIP_BUILD=true)"
  echo "âš ï¸  WARNING: Skipping build validation may lead to deployment failures"
else
  npm run build || {
    echo "âŒ Build failed - push blocked"
    echo "ğŸ’¡ Fix: npm run build"
    echo "âš ï¸  CRITICAL: Build must succeed before push"
    echo "   (Prevents Vercel deployment failures)"
    echo "   To bypass (emergency only): SKIP_BUILD=true git push"
    exit 1
  }
fi

# 3. í™˜ê²½ ë³€ìˆ˜ ê²€ì‚¬ (CRITICAL - ë°°í¬ ì•ˆì „ì„±)
echo "ğŸ” Environment variables check..."
npm run env:check || {
  echo "âŒ Environment variables check failed - push blocked"
  echo "ğŸ’¡ Fix: Add missing env vars to .env.local"
  echo "âš ï¸  CRITICAL: Missing env vars will break deployment"
  echo "   (Check .env.example for required variables)"
  exit 1
}

# 4. ë¯¼ê° íŒŒì¼ ì²´í¬ (ë³´ì•ˆ)
echo "ğŸ”’ Security check..."
# Robust security check with fallback for shallow clones/missing remote
SENSITIVE_FILES=$(git diff origin/main...HEAD --name-only 2>/dev/null) || \
  SENSITIVE_FILES=$(git diff HEAD~1 --name-only --diff-filter=d 2>/dev/null || true)
SENSITIVE_FILES=$(echo "$SENSITIVE_FILES" | grep -E '\.(env|key|pem)$' || true)
if [ -n "$SENSITIVE_FILES" ]; then
  echo "âŒ ë¯¼ê°í•œ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤:"
  echo "$SENSITIVE_FILES"
  exit 1
fi

# 5. package.json ê²€ì¦
echo "ğŸ“¦ Checking package.json..."
node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" || {
  echo "âŒ package.json has syntax errors"
  exit 1
}

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "âœ… Pre-push validation passed in ${DURATION}s"
echo "ğŸš€ Ready to push - Type-safe & Build-safe guaranteed!"
echo ""
echo "ğŸ“Š Validation Summary:"
# Test ìƒíƒœ ë™ì  í‘œì‹œ
if [ "$TEST_STATUS" = "passed" ]; then
  echo "  âœ… Quick tests passed"
elif [ "$TEST_STATUS" = "skipped" ]; then
  echo "  âšª Quick tests skipped (SKIP_TESTS=true)"
elif [ "$TEST_STATUS" = "skipped-rollup" ]; then
  echo "  âšª Quick tests skipped (Rollup binary issue)"
else
  echo "  âŒ Quick tests failed (should not reach here)"
fi
echo "  âœ… Production build succeeded (includes type check)"
echo "  âœ… Environment variables validated"
echo "  âœ… Security check passed"
echo "  âœ… package.json validated"
echo ""
echo "â„¹ï¸  Post-commit (background, non-blocking):"
echo "  â€¢ ESLint â†’ logs/lint-reports/"
echo "  â€¢ TypeScript â†’ logs/typecheck-reports/"
echo "  â€¢ AI review â†’ logs/code-reviews/"
echo ""
echo "ğŸ›¡ï¸  Protection: Type errors + Build failures blocked at local"
echo "ğŸ’¡ Vercel deployment will be safe"
