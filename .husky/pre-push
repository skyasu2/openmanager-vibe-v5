echo "ğŸ” Pre-push: Type-safe + Build validation (~90ì´ˆ ì˜ˆìƒ)..."
START_TIME=$(date +%s)

# 1. ë¹ ë¥¸ ìœ ë‹› í…ŒìŠ¤íŠ¸ (11ì´ˆ) - CRITICAL (opt-out with SKIP_TESTS=true)
echo "ğŸ§ª Running quick tests..."
TEST_STATUS="passed"
if [ "${SKIP_TESTS:-false}" = "true" ]; then
  TEST_STATUS="skipped"
  echo "âšª Tests skipped (SKIP_TESTS=true)"
  echo "âš ï¸  WARNING: Skipping tests may allow regressions to slip through"
else
  npm run test:super-fast || {
    TEST_STATUS="failed"
    echo "âŒ Tests failed - push blocked"
    echo "ğŸ’¡ Fix: npm run test:super-fast"
    echo "âš ï¸  To bypass (not recommended): SKIP_TESTS=true git push"
    echo "   Known issue: @rollup/rollup-linux-x64-gnu installation"
    exit 1
  }
fi

# 2. Lint ê²€ì‚¬ (ìˆ˜ì •ëœ íŒŒì¼ë§Œ - ë¹ ë¥¸ ê²€ì¦)
echo "ğŸ” Linting changed files..."
# origin/mainê³¼ ë¹„êµí•˜ì—¬ ì‹¤ì œ ë³€ê²½ëœ íŒŒì¼ ì²´í¬ (fallback: HEAD~1 if empty)
CHANGED_FILES=$(git diff origin/main...HEAD --name-only --diff-filter=ACM 2>/dev/null)
if [ -z "$CHANGED_FILES" ]; then
  # Fallback: ë¹ˆ ê²°ê³¼ë©´ HEAD~1ê³¼ ë¹„êµ (ì–•ì€ í´ë¡ /ì›ê²© ë¶€ì¬ ì‹œ)
  CHANGED_FILES=$(git diff HEAD~1 --name-only --diff-filter=ACM 2>/dev/null || true)
fi
CHANGED_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)
LINT_STATUS="passed"
if [ -n "$CHANGED_FILES" ]; then
  echo "$CHANGED_FILES" | xargs npx eslint --max-warnings=0 || {
    LINT_STATUS="failed"
    echo "âš ï¸  Lint warnings/errors found in changed files"
    echo "ğŸ’¡ Fix: npm run lint -- --fix"
    echo "â„¹ï¸  Continuing with remaining validations..."
  }
else
  echo "â„¹ï¸  No TypeScript/JavaScript files changed, skipping lint"
  LINT_STATUS="skipped"
fi

# 3. TypeScript íƒ€ì… ì²´í¬ (CRITICAL - í”„ë¡œë•ì…˜ ì•ˆì „ì„±)
echo "ğŸ” Type checking..."
npm run type-check || {
  echo "âŒ TypeScript errors found - push blocked"
  echo "ğŸ’¡ Fix: npm run type-check"
  echo "âš ï¸  CRITICAL: Type errors must be fixed before push"
  echo "   (Vercel may deploy broken code if this is skipped)"
  exit 1
}

# 4. í”„ë¡œë•ì…˜ ë¹Œë“œ ê²€ì¦ (CRITICAL - Vercel ë°°í¬ ì „ ë¡œì»¬ ê²€ì¦)
echo "ğŸ—ï¸ Build validation..."
npm run build || {
  echo "âŒ Build failed - push blocked"
  echo "ğŸ’¡ Fix: npm run build"
  echo "âš ï¸  CRITICAL: Build must succeed before push"
  echo "   (Prevents Vercel deployment failures)"
  exit 1
}

# 5. í™˜ê²½ ë³€ìˆ˜ ê²€ì‚¬ (CRITICAL - ë°°í¬ ì•ˆì „ì„±)
echo "ğŸ” Environment variables check..."
npm run env:check || {
  echo "âŒ Environment variables check failed - push blocked"
  echo "ğŸ’¡ Fix: Add missing env vars to .env.local"
  echo "âš ï¸  CRITICAL: Missing env vars will break deployment"
  echo "   (Check .env.example for required variables)"
  exit 1
}

# 6. ë¯¼ê° íŒŒì¼ ì²´í¬ (ë³´ì•ˆ)
echo "ğŸ”’ Security check..."
if git diff origin/main...HEAD --name-only 2>/dev/null | grep -E '\.(env|key|pem)$'; then
  echo "âŒ ë¯¼ê°í•œ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
  exit 1
fi

# 7. package.json ê²€ì¦
echo "ğŸ“¦ Checking package.json..."
node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" || {
  echo "âŒ package.json has syntax errors"
  exit 1
}

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "âœ… Pre-push validation passed in ${DURATION}s"
echo "ğŸš€ Ready to push - Type-safe & Build-safe guaranteed!"
echo ""
echo "ğŸ“Š Validation Summary:"
# Test ìƒíƒœ ë™ì  í‘œì‹œ
if [ "$TEST_STATUS" = "passed" ]; then
  echo "  âœ… Quick tests passed"
elif [ "$TEST_STATUS" = "skipped" ]; then
  echo "  âšª Quick tests skipped (SKIP_TESTS=true)"
else
  echo "  âŒ Quick tests failed (should not reach here)"
fi
# Lint ìƒíƒœ ë™ì  í‘œì‹œ
if [ "$LINT_STATUS" = "passed" ]; then
  echo "  âœ… Lint check passed (changed files only)"
elif [ "$LINT_STATUS" = "skipped" ]; then
  echo "  âšª Lint check skipped (no files changed)"
else
  echo "  âš ï¸  Lint check failed (warnings found, non-blocking)"
fi
echo "  âœ… TypeScript type check passed"
echo "  âœ… Production build succeeded"
echo "  âœ… Environment variables validated"
echo "  âœ… Security check passed"
echo "  âœ… package.json validated"
echo ""
echo "ğŸ›¡ï¸  Protection: Type errors + Build failures blocked at local"
echo "ğŸ’¡ Vercel deployment will be safe"
