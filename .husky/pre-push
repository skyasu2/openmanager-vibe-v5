#!/bin/sh

echo "🚀 Pre-push 검증 시작..."
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Skip if HUSKY is disabled
if [ "$HUSKY" = "0" ]; then
    echo "⏭️  Husky가 비활성화되어 있습니다. 검증을 건너뜁니다."
    exit 0
fi

# Skip tests if SKIP_TESTS is set
if [ "$SKIP_TESTS" = "1" ]; then
    echo "⏭️  SKIP_TESTS=1 설정됨. 테스트를 건너뜁니다."
fi

# 실패 카운터 및 상태 추적
FAILURES=0
TYPE_CHECK_FAILED=0
TEST_FAILED=0

# Type check
echo "📝 TypeScript 타입 체크 중..."
npm run type-check
if [ $? -ne 0 ]; then
    echo "❌ TypeScript 타입 체크 실패!"
    FAILURES=$((FAILURES + 1))
    TYPE_CHECK_FAILED=1
else
    echo "✅ TypeScript 타입 체크 통과"
fi
echo ""

# Unit tests - 빠른 테스트만 실행 (SKIP_TESTS가 설정되지 않은 경우)
if [ "$SKIP_TESTS" != "1" ]; then
    echo "🧪 핵심 검증 실행 중..."
    # minimal-test.js만 실행 (1초 이내 완료)
    node scripts/minimal-test.js
    TEST_EXIT_CODE=$?
    
    if [ $TEST_EXIT_CODE -ne 0 ]; then
        echo "❌ 검증 실패!"
        FAILURES=$((FAILURES + 1))
        TEST_FAILED=1
    else
        echo "✅ 핵심 검증 통과"
    fi
    echo ""
fi

# 하드코딩된 시크릿 검사
echo "🔒 하드코딩된 시크릿 검사 중..."
if [ -f "scripts/security/check-hardcoded-secrets.sh" ]; then
    bash scripts/security/check-hardcoded-secrets.sh
    if [ $? -ne 0 ]; then
        echo "❌ 하드코딩된 시크릿이 발견되었습니다!"
        echo "⚠️  이것은 심각한 보안 문제입니다. 반드시 수정하세요!"
        exit 1  # 시크릿은 무조건 차단
    else
        echo "✅ 하드코딩된 시크릿 없음"
    fi
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# 결과 확인
if [ $FAILURES -eq 0 ]; then
    echo "✅ 모든 Pre-push 검증 통과!"
    echo "🚀 Push를 진행합니다..."
    exit 0
else
    echo "⚠️  $FAILURES개의 검증이 실패했습니다."
    echo ""
    
    # 서브에이전트 추천
    echo "🤖 서브에이전트 추천:"
    
    # TypeScript 타입 체크 실패 시
    if [ "$TYPE_CHECK_FAILED" = "1" ]; then
        echo "   📝 TypeScript 타입 에러 해결:"
        echo "      Task({ subagent_type: 'code-review-specialist', prompt: 'TypeScript 타입 에러 수정' })"
    fi
    
    # 테스트 실패 시
    if [ "$TEST_FAILED" = "1" ]; then
        echo "   🧪 테스트 실패 해결:"
        echo "      Task({ subagent_type: 'test-automation-specialist', prompt: '실패한 테스트 수정' })"
        echo "      또는 디버깅이 필요한 경우:"
        echo "      Task({ subagent_type: 'debugger-specialist', prompt: '테스트 실패 원인 분석' })"
    fi
    
    # Git 관련 문제 시
    echo "   🔧 Git 워크플로우 문제 해결:"
    echo "      Task({ subagent_type: 'git-cicd-specialist', prompt: 'Pre-push 검증 실패 해결' })"
    
    echo ""
    echo "💡 다음 옵션이 있습니다:"
    echo "   1. 문제를 수정하고 다시 시도"
    echo "   2. 검증을 건너뛰고 푸시:"
    echo "      HUSKY=0 git push"
    echo "   3. 테스트만 건너뛰고 푸시:"
    echo "      SKIP_TESTS=1 git push"
    echo ""
    echo "⚠️  주의: 테스트 실패를 무시하면 CI/CD에서 문제가 발생할 수 있습니다."
    
    # 대화형 모드에서만 선택 옵션 제공
    if [ -t 0 ]; then
        echo ""
        echo "그래도 푸시하시겠습니까? (y/N)"
        read -r response
        if [ "$response" = "y" ] || [ "$response" = "Y" ]; then
            echo "⚠️  검증 실패를 무시하고 푸시를 진행합니다..."
            exit 0
        fi
    fi
    
    exit 1
fi