#!/bin/sh

echo "🚀 지능형 Pre-push 검증 시작..."

# Skip if HUSKY is disabled
if [ "$HUSKY" = "0" ]; then
    echo "⏭️  Husky가 비활성화되어 있습니다. 검증을 건너뜁니다."
    exit 0
fi

# 🧠 지능형 Pre-push 엔진 실행
node scripts/intelligent-pre-push.js

# 폴백: 기본 검사 (Node.js 실행 실패 시)
if [ $? -ne 0 ]; then
    echo "⚡ 폴백: 기본 Pre-push 검증"
    
    # 기본 빠른 검증
    echo "⚡ 빠른 검증 실행 중..."
    npm run validate:fast
    
    if [ $? -ne 0 ]; then
        echo "❌ 빠른 검증 실패!"
        echo "💡 해결책:"
        echo "  npm run lint:fix && npm run type-check"
        echo "  또는 HUSKY=0 git push (강제 푸시)"
        
        # 대화형 모드에서만 선택 옵션 제공
        if [ -t 0 ]; then
            echo ""
            echo "그래도 푸시하시겠습니까? (y/N)"
            read -r response
            if [ "$response" = "y" ] || [ "$response" = "Y" ]; then
                exit 0
            fi
        fi
        
        exit 1
    fi
fi

echo "✅ Pre-push 검증 완료!"
echo "🚀 Push를 진행합니다..."