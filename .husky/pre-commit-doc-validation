#!/usr/bin/env bash

# ============================================================================
# Pre-Commit 문서/테스트 검증 Hook
# ============================================================================
# 설명: 코드 변경 시 문서와 테스트가 함께 갱신되었는지 검증
# 버전: 1.0.0
# 작성일: 2025-11-28
# ============================================================================

set -euo pipefail

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 프로젝트 루트 경로 (동적)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# 에러 트랩
trap 'echo -e "${RED}❌ Pre-commit hook 실패 (라인: $LINENO, 명령어: $BASH_COMMAND)${NC}"; exit 1' ERR

echo -e "${GREEN}📝 문서/테스트 검증 시작...${NC}"

# ============================================================================
# 1. 스테이징된 파일 목록 수집
# ============================================================================
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [[ -z "$STAGED_FILES" ]]; then
  echo -e "${YELLOW}⚠️  스테이징된 파일이 없습니다.${NC}"
  exit 0
fi

# ============================================================================
# 2. 소스 코드 변경 감지
# ============================================================================
SOURCE_CHANGED=false
TEST_CHANGED=false
DOC_CHANGED=false

while IFS= read -r file; do
  # 소스 코드 변경 (src/ 디렉토리)
  if [[ "$file" =~ ^src/ ]] && [[ ! "$file" =~ \.test\.(ts|tsx|js|jsx)$ ]]; then
    SOURCE_CHANGED=true
  fi

  # 테스트 파일 변경
  if [[ "$file" =~ \.(spec|test)\.(ts|tsx|js|jsx)$ ]]; then
    TEST_CHANGED=true
  fi

  # 문서 파일 변경
  if [[ "$file" =~ \.md$ ]] || [[ "$file" =~ ^docs/ ]]; then
    DOC_CHANGED=true
  fi
done <<< "$STAGED_FILES"

# ============================================================================
# 3. 검증 로직
# ============================================================================
WARNINGS=()

# 소스 코드 변경 시 테스트 확인
if [[ "$SOURCE_CHANGED" == true ]] && [[ "$TEST_CHANGED" == false ]]; then
  WARNINGS+=("⚠️  소스 코드가 변경되었으나 테스트 파일이 스테이징되지 않았습니다.")
  WARNINGS+=("   확인: tests/ 디렉토리에 관련 테스트가 있는지 확인하세요.")
fi

# 소스 코드 변경 시 문서 확인
if [[ "$SOURCE_CHANGED" == true ]] && [[ "$DOC_CHANGED" == false ]]; then
  WARNINGS+=("⚠️  소스 코드가 변경되었으나 문서가 스테이징되지 않았습니다.")
  WARNINGS+=("   확인: README.md, docs/, CHANGELOG.md 등을 확인하세요.")
fi

# ============================================================================
# 4. 경고 출력 및 저장 (AI 리뷰 연동)
# ============================================================================
WARNING_LOG="logs/doc-validation-warning.txt"
mkdir -p logs
rm -f "$WARNING_LOG"

if [[ ${#WARNINGS[@]} -gt 0 ]]; then
  echo ""
  echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${YELLOW}⚠️  문서/테스트 검증 경고${NC}"
  echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

  # 로그 파일 헤더 작성
  echo "⚠️ 문서/테스트 검증 경고:" > "$WARNING_LOG"

  for warning in "${WARNINGS[@]}"; do
    echo -e "${YELLOW}$warning${NC}"
    echo "- $warning" >> "$WARNING_LOG"
  done

  echo ""
  echo -e "${YELLOW}💡 권장 사항:${NC}"
  echo -e "   - 테스트 추가: npm run test:super-fast"
  echo -e "   - 문서 갱신: ./scripts/docs/update-changelog.sh"
  echo -e "   - README 업데이트: 주요 변경사항 반영"
  echo ""

  # 권장 사항도 로그에 추가
  echo "" >> "$WARNING_LOG"
  echo "💡 권장 사항:" >> "$WARNING_LOG"
  echo "   - 테스트 추가: npm run test:super-fast"
  echo "   - 문서 갱신: ./scripts/docs/update-changelog.sh" >> "$WARNING_LOG"

  # 경고만 표시하고 자동 진행 (대기 시간 제거)
  echo -e "${YELLOW}💡 Soft warning - 커밋은 계속 진행됩니다.${NC}"
fi

echo -e "${GREEN}✅ 문서/테스트 검증 완료!${NC}"
exit 0
