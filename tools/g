#!/usr/bin/env node

/**
 * ğŸš€ g - Gemini ê°œë°œ ë„êµ¬ ë¹ ë¥¸ ì‹¤í–‰ê¸°
 * 
 * ì‚¬ìš©ë²•:
 *   ./tools/g "ì§ˆë¬¸ë‚´ìš©"                     # ë¹ ë¥¸ ì±„íŒ…
 *   ./tools/g file src/app/page.tsx          # íŒŒì¼ ë¶„ì„
 *   ./tools/g diff                           # Git diff ë¦¬ë·°
 *   ./tools/g stats                          # ì‚¬ìš©ëŸ‰ í™•ì¸
 *   ./tools/g health                         # í—¬ìŠ¤ì²´í¬
 */

import GeminiDevTools from './gemini-dev-tools.js';

const tool = new GeminiDevTools();
const args = process.argv.slice(2);

// stdin ì…ë ¥ ê°ì§€ ë° ì½ê¸°
async function readStdin() {
  // TTYê°€ ì•„ë‹ˆê±°ë‚˜ readableì´ë©´ íŒŒì´í”„ ì…ë ¥ ê°€ëŠ¥ì„±ì´ ìˆìŒ
  if (process.stdin.isTTY === true) {
    return null; // íŒŒì´í”„ ì…ë ¥ì´ ì—†ìŒ
  }
  
  // stdinì´ readableí•œ ìƒíƒœì¸ì§€ í™•ì¸
  if (!process.stdin.readable) {
    return null;
  }
  
  return new Promise((resolve, reject) => {
    let data = '';
    let resolved = false;
    const chunks = [];
    
    process.stdin.setEncoding('utf8');
    
    // ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì¦‰ì‹œ í™•ì¸
    process.stdin.on('readable', () => {
      let chunk;
      while (null !== (chunk = process.stdin.read())) {
        chunks.push(chunk);
      }
    });
    
    process.stdin.on('end', () => {
      if (!resolved) {
        resolved = true;
        data = chunks.join('');
        resolve(data.trim() || null);
      }
    });
    
    process.stdin.on('error', (err) => {
      if (!resolved) {
        resolved = true;
        resolve(null);
      }
    });
    
    // íƒ€ì„ì•„ì›ƒ ì„¤ì •
    setTimeout(() => {
      if (!resolved) {
        resolved = true;
        data = chunks.join('');
        resolve(data.trim() || null);
      }
    }, 100);
  });
}

async function showUsage() {
  console.log(`
ğŸš€ g - Gemini ê°œë°œ ë„êµ¬ ë¹ ë¥¸ ì‹¤í–‰ê¸°

ì‚¬ìš©ë²•:
  ./tools/g "ì§ˆë¬¸ë‚´ìš©"              ë¹ ë¥¸ ì±„íŒ…
  ./tools/g file <íŒŒì¼ê²½ë¡œ>         íŒŒì¼ ë¶„ì„
  ./tools/g diff                    Git diff ë¦¬ë·°
  ./tools/g stats                   ì‚¬ìš©ëŸ‰ í™•ì¸
  ./tools/g health                  í—¬ìŠ¤ì²´í¬
  ./tools/g clear                   ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
  ./tools/g memory [cmd]            ë©”ëª¨ë¦¬ ê´€ë¦¬

íŒŒì´í”„ ì…ë ¥:
  echo "ì½”ë“œ" | ./tools/g
  git diff | ./tools/g "ë¦¬ë·°í•´ì£¼ì„¸ìš”"
  cat file.txt | ./tools/g

ì˜ˆì‹œ:
  ./tools/g "TypeScript ì—ëŸ¬ í•´ê²°ë²•"
  ./tools/g file src/app/page.tsx
  ./tools/g diff "SOLID ì›ì¹™ ê´€ì ì—ì„œ"
  `);
}

async function run() {
  try {
    // stdin ì…ë ¥ í™•ì¸
    const stdinInput = await readStdin();
    
    // íŒŒì´í”„ ì…ë ¥ì´ ìˆê³  ì¸ìê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ë²• í‘œì‹œ ëŒ€ì‹  ë°”ë¡œ ì²˜ë¦¬
    if (stdinInput && args.length === 0) {
      const result = await tool.executeGemini([], { 
        pipeInput: stdinInput 
      });
      console.log(result.stdout);
      return;
    }
    
    // ì¸ìê°€ ì—†ê³  íŒŒì´í”„ ì…ë ¥ë„ ì—†ìœ¼ë©´ ì‚¬ìš©ë²• í‘œì‹œ
    if (args.length === 0 && !stdinInput) {
      await showUsage();
      process.exit(0);
    }
    
    const command = args[0];
    
    switch (command) {
      case 'file':
        if (args.length < 2) {
          console.error('âŒ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
          process.exit(1);
        }
        const filePath = args[1];
        const question = args.slice(2).join(' ') || "ì´ íŒŒì¼ì„ ë¶„ì„í•´ì£¼ì„¸ìš”";
        const result = await tool.analyzeFile(filePath, question);
        console.log(result);
        break;
        
      case 'diff':
        const diffMessage = args.slice(1).join(' ') || "ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”";
        const diffResult = await tool.analyzeGitDiff(diffMessage);
        console.log(diffResult);
        break;
        
      case 'stats':
        const stats = await tool.getStats();
        console.log(stats);
        break;
        
      case 'health':
        const health = await tool.healthCheck();
        console.log(JSON.stringify(health, null, 2));
        break;
        
      case 'clear':
        const clearResult = await tool.clearContext();
        console.log(clearResult);
        break;
        
      case 'compress':
        const compressResult = await tool.compressContext();
        console.log(compressResult);
        break;
        
      case 'memory':
        const memoryArgs = args.slice(1);
        const memoryResult = await tool.systemCommands.memoryCommand(...memoryArgs);
        console.log(memoryResult);
        break;
        
      default:
        // íŒŒì´í”„ ì…ë ¥ì´ ìˆìœ¼ë©´ í•©ì³ì„œ ì²˜ë¦¬
        if (stdinInput) {
          const prompt = args.join(' ');
          const combinedInput = prompt ? `${stdinInput}\n\n${prompt}` : stdinInput;
          const result = await tool.executeGemini([], { 
            pipeInput: combinedInput 
          });
          console.log(result.stdout);
        } else {
          // ê¸°ë³¸ì ìœ¼ë¡œ ì±„íŒ…ìœ¼ë¡œ ì²˜ë¦¬
          const chatResult = await tool.quickChat(args.join(' '));
          console.log(chatResult);
        }
    }
  } catch (error) {
    console.error('âŒ ì˜¤ë¥˜:', error.message);
    process.exit(1);
  }
}

run();